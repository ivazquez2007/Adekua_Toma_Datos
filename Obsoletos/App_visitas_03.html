<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ App Toma de Datos - Completa</title>
    <style>
        :root { --primary: #0056b3; --accent: #e67e22; --bg: #f0f2f5; --success: #27ae60; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        /* HEADER & TABS */
        header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        h1 { margin: 0; font-size: 1.2rem; }
        
        .nav-tabs { display: flex; background: white; border-bottom: 1px solid #ddd; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; color: #666; cursor: pointer; white-space: nowrap; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #f8f9fa; }
        
        /* CONTENT */
        .container { max-width: 800px; margin: 0 auto; padding: 15px; padding-bottom: 80px; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CARDS & INPUTS */
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h2 { font-size: 1rem; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 8px; margin-top: 0; }
        h3 { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        
        label { display: block; margin-top: 10px; font-weight: 600; font-size: 0.85rem; color: #444; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        input[type="checkbox"] { width: 20px; height: 20px; vertical-align: middle; margin-right: 10px; }
        
        /* SYSTEM SELECTOR */
        .sys-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .sys-btn { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; background: white; font-weight: bold; cursor: pointer; }
        .sys-btn.active { border-color: var(--primary); background: #e3f2fd; color: var(--primary); }

        /* TRAMOS */
        .tramo-card { background: #f8f9fa; border-left: 4px solid var(--primary); padding: 15px; margin-bottom: 10px; position: relative; border-radius: 4px; }
        .remove-btn { position: absolute; top: 5px; right: 5px; color: red; background: none; border: none; font-size: 1.2rem; font-weight: bold; }
        .add-btn { background: var(--success); color: white; width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; margin-top: 10px; cursor: pointer; }

        /* CHECKLIST */
        .check-group { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        
        /* PHOTOS & CANVAS */
        .photo-area { text-align: center; }
        #canvas-container { position: relative; width: 100%; max-height: 60vh; overflow: hidden; border: 2px dashed #ccc; margin: 10px 0; background: #eee; display: flex; align-items: center; justify-content: center; }
        canvas { max-width: 100%; touch-action: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .photo-tools { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .tool-btn { padding: 10px 15px; border-radius: 20px; border: none; font-weight: bold; color: white; cursor: pointer; }
        
        /* GALLERY */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .thumb { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid #ccc; }

        /* FOOTER ACTIONS */
        .footer-actions { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; gap: 10px; }
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; color: white; cursor: pointer; text-align: center; }
        .save-btn { background: var(--primary); }
        
        .hidden { display: none !important; }
        .conditional-bg { background-color: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 5px; }
    </style>
</head>
<body>

<header>
    <h1>üìê Toma de Datos 360¬∫</h1>
</header>

<div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('tab-general')">1. General</button>
    <button class="tab-btn" onclick="switchTab('tab-tecnico')">2. T√©cnico</button>
    <button class="tab-btn" onclick="switchTab('tab-seguridad')">3. Accesos/Seg</button>
    <button class="tab-btn" onclick="switchTab('tab-fotos')">4. Fotos</button>
</div>

<div class="container">

    <div id="tab-general" class="section active">
        <div class="card">
            <h2>Datos del Proyecto</h2>
            <label>Cliente</label>
            <input type="text" id="g-client" placeholder="Nombre Empresa">
            <label>Obra / Ubicaci√≥n</label>
            <input type="text" id="g-site" placeholder="Referencia de la obra">
            <label>Responsable en Obra</label>
            <input type="text" id="g-contact" placeholder="Nombre y Tel√©fono">
            <label>Fecha Visita</label>
            <input type="date" id="g-date">
        </div>

        <div class="card">
            <h2>¬øQu√© vamos a medir?</h2>
            <div class="sys-selector">
                <div class="sys-btn active" id="btn-mode-barandilla" onclick="setSystem('barandilla')">Barandilla</div>
                <div class="sys-btn" id="btn-mode-lv" onclick="setSystem('linea_vida')">L√≠nea de Vida</div>
            </div>
        </div>
        
        <div style="text-align: center; color: #666; margin-top: 20px;">
            Pulsa "2. T√©cnico" para continuar üëá
        </div>
    </div>

    <div id="tab-tecnico" class="section">
        
        <div id="form-barandilla">
            <div class="card">
                <h2>Configuraci√≥n Barandilla</h2>
                <label>Tipo de Fijaci√≥n</label>
                <select id="b-type">
                    <option value="contrapeso">Autoportante (Contrapeso)</option>
                    <option value="metalica">Fijaci√≥n a Metal</option>
                    <option value="hormigon">Fijaci√≥n a Hormig√≥n</option>
                </select>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Inicio</label><select id="b-start"><option value="libre">Libre</option><option value="pared">Pared</option></select></div>
                    <div><label>Final</label><select id="b-end"><option value="libre">Libre</option><option value="pared">Pared</option></select></div>
                </div>
            </div>
            
            <div id="b-tramos-list"></div>
            <button class="add-btn" onclick="addBarandillaTramo()">+ A√±adir Tramo Recto</button>
        </div>

        <div id="form-lv" class="hidden">
            <div class="card">
                <h2>Configuraci√≥n L√≠nea de Vida</h2>
                <label>Soporte Principal</label>
                <select id="lv-support" onchange="toggleLvSupport()">
                    <option value="sand02">Chapa Sandwich / Deck</option>
                    <option value="poste">Poste Estructural</option>
                </select>
                
                <div id="lv-opts-sand" class="conditional-bg">
                    <label>Espesor Chapa</label>
                    <select id="lv-sand-thickness">
                        <option value="0.5">Est√°ndar (0.5 - 0.63mm)</option>
                        <option value="0.6">Gruesa (> 0.63mm)</option>
                    </select>
                </div>

                <div id="lv-opts-poste" class="conditional-bg hidden">
                    <label>Altura Poste</label>
                    <select id="lv-poste-height">
                        <option value="STA-30-300">300mm</option>
                        <option value="STA-30-500">500mm</option>
                        <option value="STA-30-700">700mm</option>
                    </select>
                </div>
                
                <label><input type="checkbox" id="lv-loop"> Es una l√≠nea cerrada (Anillo)</label>
            </div>

            <div id="lv-tramos-list"></div>
            <button class="add-btn" onclick="addLvTramo()">+ A√±adir Tramo/Segmento</button>
            <div class="card" style="margin-top: 10px; background: #e8f8f5;">
                <h3 id="lv-summary-text">Longitud Total: 0.00 m</h3>
            </div>
        </div>
    </div>

    <div id="tab-seguridad" class="section">
        <div class="card">
            <h2>üì¶ Elevaci√≥n de Materiales</h2>
            <div class="check-group"><input type="checkbox" id="chk-grua"><label>Se requiere Gr√∫a Externa</label></div>
            <div class="check-group"><input type="checkbox" id="chk-montacargas"><label>Hay Montacargas disponible</label></div>
            <div class="check-group"><input type="checkbox" id="chk-escalera-int"><label>Se puede subir material por escalera interior</label></div>
            <label>Observaciones Elevaci√≥n:</label>
            <textarea id="txt-elevacion" rows="2" placeholder="Ej: La gr√∫a solo puede aparcar en cara norte..."></textarea>
        </div>

        <div class="card">
            <h2>üöß Seguridad en Instalaci√≥n</h2>
            <div class="check-group"><input type="checkbox" id="chk-fragil"><label>Cubierta FR√ÅGIL (Requiere pasarelas)</label></div>
            <div class="check-group"><input type="checkbox" id="chk-lucernarios"><label>Hay lucernarios sin proteger</label></div>
            <div class="check-group"><input type="checkbox" id="chk-linea-existente"><label>Existe l√≠nea vieja (usar para instalar)</label></div>
            <div class="check-group"><input type="checkbox" id="chk-agua-luz"><label>Punto de luz/agua disponible</label></div>
            <label>Riesgos Espec√≠ficos:</label>
            <textarea id="txt-riesgos" rows="2" placeholder="Ej: Cables de alta tensi√≥n cercanos..."></textarea>
        </div>
    </div>

    <div id="tab-fotos" class="section">
        <div class="card photo-area">
            <h2>Captura y Edici√≥n</h2>
            <p style="font-size: 0.8rem; color:#666;">1. Toma foto. 2. Dibuja (opcional). 3. Guarda.</p>
            
            <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none" onchange="loadImage(event)">
            <button class="action-btn" style="background:#34495e; margin-bottom: 10px;" onclick="document.getElementById('camera-input').click()">üì∑ Abrir C√°mara / Galer√≠a</button>

            <div id="canvas-container">
                <span style="color:#aaa;">La imagen aparecer√° aqu√≠</span>
                <canvas id="editor-canvas"></canvas>
            </div>

            <div class="photo-tools">
                <button class="tool-btn" style="background: #e74c3c;" onclick="enableDraw()">‚úèÔ∏è Pintar (Rojo)</button>
                <button class="tool-btn" style="background: #f1c40f; color: black;" onclick="clearDraw()">‚Ü∫ Deshacer Dibujo</button>
                <button class="tool-btn" style="background: var(--success);" onclick="savePhoto()">üíæ Guardar en Reporte</button>
            </div>
        </div>

        <div class="card">
            <h2>Fotos Guardadas (<span id="photo-count">0</span>)</h2>
            <div class="gallery" id="gallery-grid"></div>
        </div>
    </div>

</div>

<div class="footer-actions">
    <button class="action-btn save-btn" onclick="exportData()">üì§ Guardar y Exportar JSON</button>
</div>

<script>
    // --- L√ìGICA DE NAVEGACI√ìN ---
    function switchTab(tabId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        
        // Activar bot√≥n visualmente
        const btnIndex = ['tab-general', 'tab-tecnico', 'tab-seguridad', 'tab-fotos'].indexOf(tabId);
        document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
    }

    let currentSystem = 'barandilla';
    function setSystem(sys) {
        currentSystem = sys;
        document.getElementById('btn-mode-barandilla').classList.toggle('active', sys === 'barandilla');
        document.getElementById('btn-mode-lv').classList.toggle('active', sys === 'linea_vida');
        
        if (sys === 'barandilla') {
            document.getElementById('form-barandilla').classList.remove('hidden');
            document.getElementById('form-lv').classList.add('hidden');
        } else {
            document.getElementById('form-barandilla').classList.add('hidden');
            document.getElementById('form-lv').classList.remove('hidden');
        }
    }

    // --- LOGICA BARANDILLA ---
    function addBarandillaTramo() {
        const container = document.getElementById('b-tramos-list');
        const idx = container.children.length + 1;
        const html = `
            <div class="tramo-card b-tramo">
                <button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>
                <h3>Tramo ${idx}</h3>
                ${idx > 1 ? `
                <div class="conditional-bg">
                   <label>Esquina con el anterior:</label>
                   <select class="b-corner"><option value="Esquina cerrada">Est√°ndar (90¬∫)</option><option value="Articulada">Articulada (Variable)</option></select>
                   <input type="number" class="b-angle" placeholder="Grados (90)" value="90">
                </div>` : ''}
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
                    <div><label>Longitud (m)</label><input type="number" class="b-len" step="0.1"></div>
                    <div><label>Rodapi√©</label><input type="checkbox" class="b-rodapie" style="margin-top:15px;"></div>
                </div>
                <label>Postes Fijos (m, sep. por comas)</label>
                <input type="text" class="b-fixed" placeholder="Ej: 1.5, 4.2">
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    // --- LOGICA LINEA DE VIDA ---
    function toggleLvSupport() {
        const val = document.getElementById('lv-support').value;
        document.getElementById('lv-opts-sand').classList.toggle('hidden', val !== 'sand02');
        document.getElementById('lv-opts-poste').classList.toggle('hidden', val !== 'poste');
    }

    function addLvTramo() {
        const container = document.getElementById('lv-tramos-list');
        const idx = container.children.length + 1;
        const html = `
            <div class="tramo-card lv-tramo" oninput="updateLvSummary()">
                <button class="remove-btn" onclick="this.parentElement.remove(); updateLvSummary()">√ó</button>
                <h3>Segmento ${idx}</h3>
                <label>Longitud Recta (m)</label>
                <input type="number" class="lv-len" step="0.1" value="0">
                
                <div style="background: #fff; padding: 10px; margin-top: 10px; border: 1px dashed #ccc;">
                    <label>Al finalizar este tramo:</label>
                    <select class="lv-action" onchange="this.nextElementSibling.classList.toggle('hidden', this.value !== 'curve')">
                        <option value="none">Nada (Fin o sigue recto)</option>
                        <option value="curve">Hay una Curva</option>
                    </select>
                    <div class="hidden">
                        <label>√Ångulo Curva (¬∫)</label><input type="number" class="lv-angle" value="90">
                        <label>Tipo</label><select class="lv-curve-type"><option value="AIO-EDLE-19">Flexible (EDLE)</option><option value="Rigida">R√≠gida</option></select>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    function updateLvSummary() {
        let total = 0;
        document.querySelectorAll('.lv-len').forEach(i => total += parseFloat(i.value || 0));
        document.getElementById('lv-summary-text').innerText = `Longitud Total: ${total.toFixed(2)} m`;
    }

    // --- L√ìGICA FOTOS Y CANVAS ---
    const canvas = document.getElementById('editor-canvas');
    const ctx = canvas.getContext('2d');
    let imgObj = new Image();
    let savedPhotos = [];
    let isDrawing = false;

    function loadImage(e) {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(event) {
                imgObj.onload = function() {
                    // Resize to max 800px width to save space
                    const maxW = 800;
                    const scale = Math.min(maxW / imgObj.width, 1);
                    canvas.width = imgObj.width * scale;
                    canvas.height = imgObj.height * scale;
                    ctx.drawImage(imgObj, 0, 0, canvas.width, canvas.height);
                }
                imgObj.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        }
    }

    function enableDraw() {
        ctx.lineWidth = 4;
        ctx.strokeStyle = "red";
        ctx.lineCap = "round";
        
        // Mouse
        canvas.onmousedown = (e) => { isDrawing = true; draw(e.pageX, e.pageY); };
        canvas.onmousemove = (e) => { if (isDrawing) draw(e.pageX, e.pageY); };
        canvas.onmouseup = () => { isDrawing = false; ctx.beginPath(); };
        
        // Touch
        canvas.ontouchstart = (e) => { isDrawing = true; draw(e.touches[0].pageX, e.touches[0].pageY); e.preventDefault(); };
        canvas.ontouchmove = (e) => { if (isDrawing) draw(e.touches[0].pageX, e.touches[0].pageY); e.preventDefault(); };
        canvas.ontouchend = () => { isDrawing = false; ctx.beginPath(); };
    }

    function draw(x, y) {
        const rect = canvas.getBoundingClientRect();
        // Adjust for scroll
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        const pos_x = x - rect.left - scrollLeft;
        const pos_y = y - rect.top - scrollTop;

        ctx.lineTo(pos_x, pos_y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(pos_x, pos_y);
    }

    function clearDraw() {
        // Redraw image to clear lines
        ctx.drawImage(imgObj, 0, 0, canvas.width, canvas.height);
    }

    function savePhoto() {
        if (!canvas.width) return alert("Primero carga una foto");
        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
        savedPhotos.push({
            id: Date.now(),
            data: dataUrl
        });
        renderGallery();
        alert("Foto guardada en memoria");
    }

    function renderGallery() {
        const grid = document.getElementById('gallery-grid');
        grid.innerHTML = '';
        savedPhotos.forEach(p => {
            const img = document.createElement('img');
            img.src = p.data;
            img.className = 'thumb';
            grid.appendChild(img);
        });
        document.getElementById('photo-count').innerText = savedPhotos.length;
    }

    // --- EXPORTACI√ìN ---
    function exportData() {
        // 1. Datos Generales
        const general = {
            cliente: document.getElementById('g-client').value,
            obra: document.getElementById('g-site').value,
            fecha: document.getElementById('g-date').value,
            tipo_sistema: currentSystem
        };

        // 2. Checklist
        const checklist = {
            elevacion: {
                grua: document.getElementById('chk-grua').checked,
                montacargas: document.getElementById('chk-montacargas').checked,
                escalera: document.getElementById('chk-escalera-int').checked,
                notas: document.getElementById('txt-elevacion').value
            },
            seguridad: {
                fragil: document.getElementById('chk-fragil').checked,
                lucernarios: document.getElementById('chk-lucernarios').checked,
                linea_previa: document.getElementById('chk-linea-existente').checked,
                suministros: document.getElementById('chk-agua-luz').checked,
                riesgos: document.getElementById('txt-riesgos').value
            }
        };

        // 3. Datos T√©cnicos (Formato para Oficina)
        let technicalData = {};
        
        if (currentSystem === 'barandilla') {
            // Recopilar tramos barandilla
            let lengths = [], toeBoards = [], fixedPosts = {}, corners = [], angles = [];
            document.querySelectorAll('.b-tramo').forEach((el, i) => {
                lengths.push(parseFloat(el.querySelector('.b-len').value) || 0);
                toeBoards.push(el.querySelector('.b-rodapie').checked);
                
                const fVal = el.querySelector('.b-fixed').value;
                if(fVal) fixedPosts[i] = fVal.split(',').map(n=>parseFloat(n));
                
                if (i > 0) { // Las esquinas pertenecen al tramo siguiente en la l√≥gica de UI
                    corners.push(el.querySelector('.b-corner').value);
                    angles.push(parseFloat(el.querySelector('.b-angle').value)||90);
                }
            });

            technicalData = {
                appType: 'app.js', // Flag para tu software de oficina
                parameters: {
                    installType: document.getElementById('b-type').value,
                    startType: document.getElementById('b-start').value,
                    endType: document.getElementById('b-end').value,
                    lengths: lengths,
                    toeBoards: toeBoards,
                    fixedPosts: fixedPosts,
                    esquinas: corners,
                    angles: angles
                }
            };

        } else {
            // Recopilar tramos l√≠nea vida
            let curves = [];
            let currentPos = 0;
            
            document.querySelectorAll('.lv-tramo').forEach(el => {
                const len = parseFloat(el.querySelector('.lv-len').value) || 0;
                currentPos += len;
                
                const action = el.querySelector('.lv-action').value;
                if(action === 'curve') {
                    curves.push({
                        posicion: parseFloat(currentPos.toFixed(2)),
                        angulo: parseFloat(el.querySelector('.lv-angle').value) || 90,
                        tipo: el.querySelector('.lv-curve-type').value,
                        unidades: 1
                    });
                }
            });

            const support = document.getElementById('lv-support').value;
            technicalData = {
                appType: support === 'sand02' ? 'calculations.js' : 'Calculations_postes.js',
                layoutData: {
                    longitud: parseFloat(currentPos.toFixed(2)),
                    curvas: curves,
                    isClosedLoop: document.getElementById('lv-loop').checked,
                    direccionInicial: 0
                },
                parameters: {
                    // Par√°metros espec√≠ficos seg√∫n soporte
                    espesor: support === 'sand02' ? document.getElementById('lv-sand-thickness').value : null,
                    poste_tipo: support === 'poste' ? document.getElementById('lv-poste-height').value : null
                }
            };
        }

        // 4. Construir Objeto Final
        const finalExport = {
            meta: { generated: new Date().toISOString(), version: "2.0" },
            general: general,
            checklist: checklist,
            technical: technicalData,
            photos: savedPhotos // Array de base64
        };

        // Descarga
        const fileName = `Visita_${general.obra.replace(/\s+/g, '_')}_${general.fecha}.json`;
        const blob = new Blob([JSON.stringify(finalExport, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // Inicializar
    document.getElementById('g-date').valueAsDate = new Date();
    addBarandillaTramo();
    addLvTramo();

</script>

</body>
</html>