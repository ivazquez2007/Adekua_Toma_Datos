<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Toma de Datos v14 (Superposici√≥n + BOM)</title>
    <!-- SheetJS Library for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #0056b3;
            --accent: #e67e22;
            --bg: #f4f6f8;
            --success: #27ae60;
            --danger: #c0392b;
            --purple: #6f42c1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            padding-bottom: 90px;
        }

        /* HEADER */
        header {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        h1 {
            margin: 0;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* TABS */
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 50px;
            z-index: 90;
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 10px;
            border: none;
            background: none;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: #f8f9fa;
        }

        /* CONTAINER */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* CARDS */
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
            border: 1px solid #e1e4e8;
        }

        h2 {
            font-size: 1rem;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 15px;
        }

        h3 {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 5px;
            font-weight: 600;
        }

        /* INPUTS */
        label {
            display: block;
            margin-top: 12px;
            font-weight: 600;
            font-size: 0.85rem;
            color: #34495e;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* CHECKBOX GROUP */
        .check-group {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f1f1;
        }

        .check-group input {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        /* BUTTONS */
        .btn-full {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            text-align: center;
        }

        .btn-add {
            background: var(--success);
            color: white;
        }

        .btn-mini {
            padding: 5px 10px;
            font-size: 0.8rem;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
        }

        .btn-save {
            background: var(--primary);
            color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-overlay {
            background: var(--purple);
            color: white;
        }

        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--danger);
            background: none;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
        }

        /* SYSTEM SELECTOR */
        .sys-selector {
            display: flex;
            gap: 10px;
        }

        .sys-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
            background: white;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
        }

        .sys-btn.active {
            border-color: var(--primary);
            background: #ebf5fb;
            color: var(--primary);
        }

        /* VISUALIZACION (CANVAS) */
        #geo-preview-container {
            width: 100%;
            height: 350px;
            background: #2c3e50;
            border-radius: 8px;
            margin-bottom: 15px;
            position: sticky;
            top: 110px;
            z-index: 80;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
            border: 1px solid #1a252f;
        }

        canvas {
            display: block;
        }

        .preview-label {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 0.8rem;
            opacity: 0.7;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .bom-overlay {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* TABLA BOM */
        #bom-table-container {
            margin-top: 0px;
            margin-bottom: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .bom-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .bom-table th {
            background: #f8f9fa;
            text-align: left;
            padding: 10px;
            border-bottom: 2px solid #ddd;
            color: #555;
        }

        .bom-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .bom-badge {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            font-size: 0.8rem;
            margin-right: 8px;
        }

        /* UTILS */
        .hidden {
            display: none !important;
        }

        .conditional-box {
            background-color: #fff8e1;
            border: 1px solid #ffe0b2;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .tramo-card {
            background: #fdfdfd;
            border-left: 4px solid var(--accent);
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            border-radius: 4px;
            border: 1px solid #eee;
            border-left-width: 4px;
        }

        .config-card {
            border-left: 4px solid var(--primary);
            background: #eef2f5;
        }

        .manual-point-row {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            align-items: center;
            background: #fff;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
        }

        /* FOTOS */
        #canvas-container {
            position: relative;
            width: 100%;
            height: 300px;
            border: 2px dashed #ccc;
            margin: 10px 0;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }

        .thumb {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        /* FOOTER */
        .footer-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background: white;
            border-top: 1px solid #ddd;
            z-index: 999;
            display: flex;
            gap: 10px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>

    <header>
        <h1>üìê Toma de Datos v14</h1>
    </header>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('tab-tecnico')">1. Configuraci√≥n</button>
        <button class="tab-btn" onclick="switchTab('tab-geometria')">2. Plano (Auto)</button>
        <button class="tab-btn" onclick="switchTab('tab-fotos')">3. Fotos</button>
    </div>

    <div class="container">

        <div id="tab-tecnico" class="section active">
            <div class="card">
                <h2>Datos del Proyecto</h2>
                <label>Cliente</label><input type="text" id="g-client">
                <label>Obra</label><input type="text" id="g-site">
                <label>Fecha</label><input type="date" id="g-date">
            </div>

            <div class="card">
                <h2>Sistema a Presupuestar</h2>
                <div class="sys-selector">
                    <div class="sys-btn active" id="btn-barandilla" onclick="setSystem('barandilla')">üõ°Ô∏è Barandilla
                    </div>
                    <div class="sys-btn" id="btn-sand02" onclick="setSystem('sand02')">üì¶ Sand02</div>
                    <div class="sys-btn" id="btn-poste" onclick="setSystem('poste')">üèóÔ∏è Postes</div>
                    <div class="sys-btn" id="btn-rail" onclick="setSystem('rail')">üöÇ Rail</div>
                </div>
            </div>

            <div id="tech-barandilla">
                <div class="card">
                    <h2>Fijaci√≥n Barandilla</h2>
                    <label>Tipo de Fijaci√≥n</label>
                    <select id="b-fix-type" onchange="toggleBarandillaOpts()">
                        <option value="contrapeso">Autoportante (Contrapeso)</option>
                        <option value="metalica">Fijaci√≥n a Metal</option>
                        <option value="hormigon">Fijaci√≥n a Hormig√≥n</option>
                    </select>
                    <div id="opts-b-contrapeso" class="conditional-box">
                        <label>Tipo de Superficie</label>
                        <select id="b-surface">
                            <option value="grava">Grava / Canto rodado</option>
                            <option value="asfaltica">Tela Asf√°ltica</option>
                            <option value="pvc_tpo">L√°mina PVC / TPO</option>
                            <option value="losa">Losa Hormig√≥n / Baldosa</option>
                            <option value="delicado">Suelo Delicado (Fieltro)</option>
                        </select>
                    </div>
                    <div id="opts-b-metal" class="conditional-box hidden">
                        <label>Tipo Metal</label><input type="text" id="b-metal-desc" placeholder="Ej: Viga IPN">
                        <label>¬øTorniller√≠a Pasante?</label>
                        <select id="b-metal-pasante">
                            <option value="no">No</option>
                            <option value="si">S√≠</option>
                        </select>
                    </div>
                    <div id="opts-b-hormigon" class="conditional-box hidden">
                        <label>Estado</label>
                        <select id="b-hormigon-status">
                            <option value="bueno">Bueno</option>
                            <option value="malo">Malo</option>
                        </select>
                        <label>Ancho Peto (cm)</label><input type="number" id="b-peto-width">
                    </div>
                </div>
            </div>

            <div id="tech-linea" class="hidden">
                <div class="card config-card">
                    <h2>Definici√≥n de Componentes (BOM)</h2>
                    <label>Variante del Sistema</label>
                    <select id="lv-variant" onchange="toggleLvConfig(); drawPreview();">
                        <option value="ends10">Ends10 (Est√°ndar)</option>
                        <option value="ends50">Ends50 (Simplificado)</option>
                    </select>
                    <div id="group-ends10">
                        <label>Elemento de Extremo (EB)</label>
                        <select id="lv-eb-model" onchange="drawPreview()"></select>
                        <div class="check-group" style="margin-top:15px; border-top:1px solid #ddd; padding-top:10px;">
                            <input type="checkbox" id="chk-shock" onchange="toggleShockOpts()">
                            <label>¬øLleva Absorbedores?</label>
                        </div>
                        <div id="opts-shock" class="conditional-box hidden">
                            <label>Cantidad Absorbedores</label>
                            <input type="number" id="lv-shock-qty" value="0">
                            <label>Tipo</label><select id="lv-shock-type">
                                <option value="SHOCK-10">SHOCK-10</option>
                                <option value="SHOCK-11">SHOCK-11</option>
                            </select>
                        </div>
                    </div>
                    <div id="group-ends50" class="hidden">
                        <label>Configuraci√≥n de Extremos</label>
                        <select id="lv-ends50-config">
                            <option value="50-51">1√ó AIO-ENDS-50 + 1√ó AIO-ENDS-51</option>
                            <option value="50-50">2√ó AIO-ENDS-50</option>
                        </select>
                    </div>
                    <hr style="margin: 20px 0; border:0; border-top:1px solid #ddd;">
                    <label>Elemento Intermedio (SZH)</label>
                    <select id="lv-szh-model" onchange="drawPreview()"></select>
                </div>

                <div class="card" id="card-alzas-sand02">
                    <h2>Opciones de Instalaci√≥n</h2>
                    <div class="check-group">
                        <input type="checkbox" id="chk-alzas">
                        <label>¬øLleva alzas de nivelaci√≥n (VL-SAND-SET)?</label>
                    </div>
                </div>

                <div class="card">
                    <h2>Soporte L√≠nea de Vida</h2>
                    <label>Estructura</label>
                    <select id="lv-support-type" onchange="toggleLvOpts(); drawPreview();">
                        <option value="sand02">Cubierta Chapa (Sandwich/Deck)</option>
                        <option value="poste">Poste Estructural</option>
                    </select>
                    <div id="opts-lv-chapa" class="conditional-box">
                        <label>Tipo Chapa</label>
                        <select id="lv-chapa-type">
                            <option value="sandwich">Panel Sandwich</option>
                            <option value="grecada">Grecada Simple</option>
                            <option value="deck">Deck</option>
                        </select>
                        <label>Tipo de Chapa</label>
                        <select id="lv-chapa-thick" onchange="updateMaxDistSand02(); drawPreview()">
                            <option value="10">Chapa Fina (m√°x 10m entre intermedios)</option>
                            <option value="12">Chapa Gruesa (m√°x 12m entre intermedios)</option>
                        </select>
                        <label>Distancia M√°xima entre Intermedios (m)</label>
                        <input type="number" id="lv-max-dist-sand02" value="10" min="1" max="12" step="0.5"
                            onchange="drawPreview()" style="width:100%;">
                        <small style="display:block; margin-top:5px; color:#666; font-size:0.85rem;">Puedes reducir la
                            distancia si lo necesitas</small>
                    </div>
                    <div id="opts-lv-poste" class="conditional-box hidden">
                        <label>Distancia M√°xima entre Soportes (m)</label>
                        <input type="number" id="lv-max-dist-poste" value="15" min="1" max="15" step="0.5"
                            onchange="drawPreview()" style="width:100%;">
                        <small
                            style="display:block; margin-top:5px; margin-bottom:15px; color:#666; font-size:0.85rem;">Distancia
                            m√°xima entre extremos e intermedios (m√°x 15m)</small>

                        <div class="check-group"
                            style="background:#e3f2fd; padding:10px; border-radius:4px; margin-bottom:15px;">
                            <input type="checkbox" id="chk-use-posts" checked
                                onchange="toggleUsePostsOpts(); drawPreview();">
                            <label>Usar Postes en la Instalaci√≥n</label>
                        </div>
                        <div id="opts-with-posts">
                            <label>Modelo Poste (STA)</label>
                            <select id="lv-post-model" onchange="drawPreview()"></select>
                            <label>Material Base</label>
                            <select id="lv-base-mat">
                                <option value="hormigon">Hormig√≥n</option>
                                <option value="acero">Metal</option>
                                <option value="madera">Madera</option>
                            </select>
                            <div style="margin-top:10px;">
                                <div class="check-group"><input type="checkbox" id="chk-contraplaca"><label>Requiere
                                        Contraplaca</label></div>
                                <div class="check-group"><input type="checkbox" id="chk-baseplate"><label>Requiere
                                        Placas Base (VL-20-XX)</label></div>
                                <div class="check-group"><input type="checkbox" id="chk-alzas-posts"><label>Requiere
                                        Alzas de Nivelaci√≥n (VL-20-50)</label></div>
                                <div class="check-group"><input type="checkbox" id="chk-herreria"
                                        onchange="document.getElementById('desc-herreria').classList.toggle('hidden',!this.checked)"><label>Herrer√≠a
                                        Especial</label></div>
                                <textarea id="desc-herreria" class="hidden" rows="2"
                                    placeholder="Detalle..."></textarea>
                            </div>
                            <hr style="margin: 15px 0; border:0; border-top:1px solid #ddd;">
                            <button class="btn-mini" style="width:100%; background:var(--accent);"
                                onclick="toggleCustomPostsUI()">‚öôÔ∏è Personalizar Postes Individuales</button>
                            <div id="custom-posts-container" class="hidden"
                                style="margin-top:10px; padding:10px; background:#fff3cd; border-radius:4px;">
                                <p style="font-size:0.85rem; margin:0 0 10px; color:#856404;">Selecciona postes
                                    espec√≠ficos
                                    para usar un modelo diferente:</p>
                                <div id="custom-posts-list"></div>
                            </div>
                        </div>
                        <div id="opts-without-posts" class="hidden"
                            style="padding:15px; background:#fff3cd; border-radius:4px; margin-top:10px;">
                            <p style="font-size:0.9rem; margin:0; color:#856404;"><strong>‚ö†Ô∏è Instalaci√≥n Sin
                                    Postes:</strong> Se usar√°n directamente los elementos de extremo (ENDS) sin postes
                                estructurales.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tech-rail" class="hidden">
                <div class="card">
                    <h2>Configuraci√≥n Sistema Rail (TAURUS)</h2>
                    <label>Longitud Total (m)</label>
                    <input type="number" id="rail-longitud" value="20" min="1" max="500" step="0.5">

                    <div class="check-group" style="margin-top:15px;">
                        <input type="checkbox" id="rail-cerrada">
                        <label>L√≠nea Cerrada (bucle)</label>
                    </div>
                </div>

                <div class="card">
                    <h2>Tipo de Soporte</h2>
                    <label>Estructura</label>
                    <select id="rail-soporte-tipo" onchange="toggleRailSoporteOpts()">
                        <option value="bef">Fijaci√≥n Directa (BEF)</option>
                        <option value="sta">Postes Estructurales (STA)</option>
                        <option value="bef-eb">Fijaci√≥n Acero (BEF-411 + EB)</option>
                    </select>

                    <div id="opts-rail-bef">
                        <label>Modelo BEF</label>
                        <select id="rail-bef-model"></select>
                    </div>

                    <div id="opts-rail-sta" class="hidden">
                        <label>Modelo Poste (STA)</label>
                        <select id="rail-sta-model"></select>
                        <small style="display:block; margin-top:5px; color:#666; font-size:0.85rem;">Se a√±adir√°
                            autom√°ticamente
                            TAURUS-BEF-30</small>
                    </div>

                    <div id="opts-rail-bef-eb" class="hidden">
                        <label>Soporte EB</label>
                        <select id="rail-eb-model"></select>
                        <label>Fijaci√≥n BEF Adicional</label>
                        <select id="rail-bef-adicional"></select>
                        <div class="check-group" style="margin-top:10px;">
                            <input type="checkbox" id="rail-varilla-m16">
                            <label>A√±adir 0.5x Varilla M16 por punto</label>
                        </div>
                    </div>

                    <label style="margin-top:15px;">Distancia M√°xima entre Soportes (m)</label>
                    <input type="number" id="rail-dist-max" value="3" min="1" max="6" step="0.1">
                    <small style="display:block; margin-top:5px; color:#666; font-size:0.85rem;">M√°ximo recomendado:
                        6m</small>
                </div>

                <div class="card">
                    <h2>Componentes del Sistema</h2>

                    <div class="check-group">
                        <input type="checkbox" id="rail-usar-6m" checked>
                        <label>Priorizar ra√≠les de 6m</label>
                    </div>
                    <small style="display:block; margin-bottom:15px; color:#666; font-size:0.85rem;">Si no, solo se
                        usar√°n
                        ra√≠les de 3m</small>

                    <label>Tipo de Carro Deslizador</label>
                    <select id="rail-carro-tipo"></select>

                    <label>Tipo de Uni√≥n de Carril</label>
                    <select id="rail-union-tipo"></select>

                    <div class="check-group" style="margin-top:10px;">
                        <input type="checkbox" id="rail-optimizar-ve5" checked>
                        <label>Optimizar con packs VE5 (VB-10/VB-12)</label>
                    </div>
                    <small style="display:block; margin-top:5px; color:#666; font-size:0.85rem;">Divide uniones en packs
                        de
                        5 +
                        unidades sueltas</small>
                </div>
            </div>

            <div class="card">
                <h2>Seguridad y Accesos</h2>
                <div class="check-group"><input type="checkbox" id="chk-grua"><label>Requiere Gr√∫a Externa</label></div>
                <div class="check-group"><input type="checkbox" id="chk-fragil"><label>Cubierta Fr√°gil</label></div>
                <label>Notas Accesos:</label><textarea id="txt-accesos" rows="2"></textarea>
            </div>
        </div>



        <div id="tab-geometria" class="section">
            <div id="geo-preview-container">
                <div class="preview-label">üëÅÔ∏è Plano de Instalaci√≥n</div>
                <canvas id="geo-canvas" width="600" height="350"></canvas>
                <div class="bom-overlay" id="bom-display">Items: 0</div>
            </div>

            <div id="bom-table-container">
                <table class="bom-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">#</th>
                            <th>Tipo de Punto</th>
                            <th>Configuraci√≥n de Montaje</th>
                        </tr>
                    </thead>
                    <tbody id="bom-table-body"></tbody>
                </table>
            </div>

            <div id="geo-barandilla">
                <div class="card config-card">
                    <h3>Terminaciones</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div><label>Comienzo</label><select id="b-start-conf" onchange="drawPreview()">
                                <option value="R41">R41 (Pared)</option>
                                <option value="R91">R91 (Libre)</option>
                                <option value="R51">R51 (Libre/Unido)</option>
                            </select></div>
                        <div><label>Final</label><select id="b-end-conf" onchange="drawPreview()">
                                <option value="R41">R41 (Pared)</option>
                                <option value="R91">R91 (Libre)</option>
                                <option value="R51">R51 (Libre/Unido)</option>
                            </select></div>
                    </div>
                </div>
                <div id="b-tramos-list"></div>
                <button class="btn-full btn-add" onclick="addBarandillaTramo()">+ A√±adir Tramo Recto</button>
            </div>

            <div id="geo-linea" class="hidden">
                <div class="card" style="background: #e3f2fd; padding:10px;">
                    <div class="check-group"><input type="checkbox" id="lv-loop" onchange="drawPreview()"><label>Sistema
                            Cerrado (Anillo)</label></div>
                </div>
                <div id="lv-tramos-list"></div>
                <button class="btn-full btn-add" onclick="addLvTramo()">+ A√±adir Segmento</button>
            </div>
        </div>

        <div id="tab-fotos" class="section">
            <div class="card" style="text-align: center;">
                <input type="file" id="cam-input" accept="image/*" capture="environment" style="display:none"
                    onchange="loadPhoto(event)">
                <button class="btn-full" style="background:#555; color:white; margin-bottom:10px;"
                    onclick="document.getElementById('cam-input').click()">üì∑ Tomar Foto</button>

                <div id="canvas-container"><canvas id="editor"></canvas></div>

                <div id="overlay-controls"
                    style="display:none; background:#f1f3f5; padding:10px; border-radius:4px; margin-bottom:10px; border:1px solid #ddd;">
                    <label style="margin-top:0; color:var(--purple);">üó∫Ô∏è Ajustar Plano</label>
                    <div style="display:flex; gap:10px; align-items:center; justify-content:center;">
                        <span style="font-size:0.8rem;">Tam:</span>
                        <input type="range" id="overlay-scale" min="0.1" max="3" step="0.1" value="1"
                            oninput="renderEditor()">
                        <button class="btn-mini" style="background:var(--success);" onclick="fixOverlay()">‚úÖ
                            Fijar</button>
                    </div>
                    <p style="font-size:0.7rem; color:#666; margin:5px 0;">Arrastra para mover. Usa la barra para
                        escalar.</p>
                </div>

                <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                    <button onclick="importPlanToPhoto()" class="btn-mini btn-overlay">üó∫Ô∏è Superponer Plano</button>
                    <button onclick="enableDraw()" class="btn-mini">‚úèÔ∏è Pintar</button>
                    <button onclick="clearDraw()" class="btn-mini">‚Ü∫ Limpiar</button>
                    <button onclick="savePhoto()" class="btn-mini btn-save">üíæ Guardar</button>
                </div>
            </div>
            <div class="card">
                <h3>Galer√≠a (<span id="photo-count">0</span>)</h3>
                <div class="gallery" id="gallery-grid"></div>
            </div>
        </div>

    </div>

    <div class="footer-fixed">
        <button class="btn-full btn-save" onclick="exportJSON()" style="flex:1;">üì§ JSON</button>
        <button class="btn-full" style="background:var(--success); color:white; flex:1;" onclick="exportToExcel()">üìä
            Excel</button>
        <button class="btn-full" style="background:var(--purple); color:white; flex:1;" onclick="generateReport()">üìÑ
            Informe</button>
    </div>

    <script>
        if (window.NodeList && !NodeList.prototype.forEach) {
            NodeList.prototype.forEach = Array.prototype.forEach;
        }
        // --- DATOS MAESTROS ---
        const STA_LIST = ['STA-10-400', 'STA-10-600', 'STA-10-600-A4', 'STA-10-800', 'STA-11-340', 'STA-11-470', 'STA-12-400', 'STA-12-600', 'STA-12-800', 'STA-16-200', 'STA-16-500', 'STA-17-300', 'STA-17-400', 'STA-17-600'];
        const EB_LIST = ['AIO-EB-10', 'AIO-EB-11', 'AIO-EB-12', 'AIO-EB-13', 'AIO-EB-15', 'AIO-EB-16', 'AIO-EB-17'];
        const SZH_LIST = ['AIO-SZH-10', 'AIO-SZH-11', 'AIO-SZH-12', 'AIO-SZH-13', 'AIO-SZH-15', 'AIO-SZH-16', 'AIO-SZH-17'];
        const EDLE_LIST = ['AIO-EDLE-10', 'AIO-EDLE-11', 'AIO-EDLE-12', 'AIO-EDLE-13', 'AIO-EDLE-15', 'AIO-EDLE-16', 'AIO-EDLE-17', 'AIO-EDLE-19', 'AIO-EDLE-50', 'AIO-EDLE-51'];
        const EXTRA_ELEMENTS = ['AIO-EDLE-19', 'AIO-SZH-10', 'POSTE-REFUERZO', 'OTRO'];
        const RAIL_BEF_LIST = ['TAURUS-BEF-10', 'TAURUS-BEF-10-VE5', 'TAURUS-BEF-12', 'TAURUS-BEF-13-VE5', 'TAURUS-BEF-20', 'TAURUS-BEF-21', 'TAURUS-BEF-30', 'TAURUS-BEF-41', 'TAURUS-BEF-411'];
        const RAIL_CARRO_LIST = ['TAURUS-GLEIT-H-11', 'TAURUS-GLEIT-A-31', 'TAURUS-GLEIT-10', 'TAURUS-GLEIT-11', 'TAURUS-GLEIT-12', 'TAURUS-GLEIT-13'];
        const RAIL_UNION_LIST = ['TAURUS-VB-10', 'TAURUS-VB-11', 'TAURUS-VB-12'];

        // --- GLOBALES ---
        let currentSystem = 'barandilla'; // 'barandilla', 'sand02', or 'poste'
        let globalCalculatedPosts = [];
        let customPostSelections = {}; // Stores custom post models: { segmentIndex_postIndex: 'STA-XX-XXX' }
        // Variables FOTOS
        let imgObj = new Image();
        let savedPhotos = [];
        let isDrawing = false;
        let overlay = { img: null, x: 0, y: 0, scale: 1.0, active: false, isDragging: false };

        var dateInput = document.getElementById('g-date');
        if (dateInput) {
            var today = new Date().toISOString().split('T')[0]; // "2026-01-05"
            dateInput.value = today;
        }


        // --- INIT ---
        function populateSelect(id, list) { const sel = document.getElementById(id); list.forEach(m => { let opt = document.createElement('option'); opt.value = m; opt.text = m; sel.appendChild(opt); }); }
        populateSelect('lv-post-model', STA_LIST); populateSelect('lv-eb-model', EB_LIST); populateSelect('lv-szh-model', SZH_LIST);
        populateSelect('rail-sta-model', STA_LIST); populateSelect('rail-eb-model', EB_LIST);
        populateSelect('rail-bef-model', RAIL_BEF_LIST);
        populateSelect('rail-bef-adicional', RAIL_BEF_LIST);
        populateSelect('rail-carro-tipo', RAIL_CARRO_LIST);
        populateSelect('rail-union-tipo', RAIL_UNION_LIST);
        function getEdleOptionsHTML() { return EDLE_LIST.map(e => `<option value="${e}">${e}</option>`).join(''); }
        function getExtraElemOptions() { return EXTRA_ELEMENTS.map(e => `<option value="${e}">${e}</option>`).join(''); }

        // --- UI ---
        function switchTab(tabId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            const map = { 'tab-tecnico': 0, 'tab-geometria': 1, 'tab-fotos': 2 };
            document.querySelectorAll('.tab-btn')[map[tabId]].classList.add('active');
            if (tabId === 'tab-geometria') setTimeout(drawPreview, 100);
        }

        function setSystem(sys) {
            currentSystem = sys;
            document.getElementById('btn-barandilla').classList.toggle('active', sys === 'barandilla');
            document.getElementById('btn-sand02').classList.toggle('active', sys === 'sand02');
            document.getElementById('btn-poste').classList.toggle('active', sys === 'poste');
            document.getElementById('btn-rail').classList.toggle('active', sys === 'rail');

            document.getElementById('tech-barandilla').classList.toggle('hidden', sys !== 'barandilla');
            document.getElementById('tech-linea').classList.toggle('hidden', sys !== 'sand02' && sys !== 'poste');
            document.getElementById('tech-rail').classList.toggle('hidden', sys !== 'rail');

            // Show VL-SAND-SET alzas only for sand02, not for postes
            const alzasCard = document.getElementById('card-alzas-sand02');
            if (alzasCard) {
                alzasCard.classList.toggle('hidden', sys !== 'sand02');
            }

            // For sand02 and poste, set the support type accordingly
            if (sys === 'sand02') {
                document.getElementById('lv-support-type').value = 'sand02';
                toggleLvOpts();
            } else if (sys === 'poste') {
                document.getElementById('lv-support-type').value = 'poste';
                toggleLvOpts();
            }

            document.getElementById('geo-barandilla').classList.toggle('hidden', sys !== 'barandilla');
            document.getElementById('geo-linea').classList.toggle('hidden', sys !== 'sand02' && sys !== 'poste');
            // Rail uses same geo as linea for now
            if (sys === 'rail') {
                document.getElementById('geo-linea').classList.remove('hidden');
            }
            drawPreview();
        }

        function toggleBarandillaOpts() {
            const type = document.getElementById('b-fix-type').value;
            document.getElementById('opts-b-contrapeso').classList.toggle('hidden', type !== 'contrapeso');
            document.getElementById('opts-b-metal').classList.toggle('hidden', type !== 'metalica');
            document.getElementById('opts-b-hormigon').classList.toggle('hidden', type !== 'hormigon');
        }
        function toggleLvOpts() {
            const type = document.getElementById('lv-support-type').value;
            document.getElementById('opts-lv-chapa').classList.toggle('hidden', type !== 'sand02');
            document.getElementById('opts-lv-poste').classList.toggle('hidden', type !== 'poste');
        }

        function toggleUsePostsOpts() {
            const usePosts = document.getElementById('chk-use-posts').checked;
            document.getElementById('opts-with-posts').classList.toggle('hidden', !usePosts);
            document.getElementById('opts-without-posts').classList.toggle('hidden', usePosts);
        }

        function updateMaxDistSand02() {
            const chapaValue = document.getElementById('lv-chapa-thick').value;
            const maxDistInput = document.getElementById('lv-max-dist-sand02');
            maxDistInput.value = chapaValue;
            maxDistInput.max = chapaValue;
        }


        function toggleRailSoporteOpts() {
            const tipo = document.getElementById('rail-soporte-tipo').value;
            document.getElementById('opts-rail-bef').classList.toggle('hidden', tipo !== 'bef');
            document.getElementById('opts-rail-sta').classList.toggle('hidden', tipo !== 'sta');
            document.getElementById('opts-rail-bef-eb').classList.toggle('hidden', tipo !== 'bef-eb');
        }

        function toggleLvConfig() {
            const variant = document.getElementById('lv-variant').value;
            document.getElementById('group-ends10').classList.toggle('hidden', variant === 'ends50');
            document.getElementById('group-ends50').classList.toggle('hidden', variant !== 'ends50');
        }
        function toggleShockOpts() {
            document.getElementById('opts-shock').classList.toggle('hidden', !document.getElementById('chk-shock').checked);
        }

        function toggleCustomPostsUI() {
            const container = document.getElementById('custom-posts-container');
            const list = document.getElementById('custom-posts-list');

            if (container.classList.contains('hidden')) {
                // Show and populate
                container.classList.remove('hidden');
                updateCustomPostsList();
            } else {
                container.classList.add('hidden');
            }
        }

        function updateCustomPostsList() {
            const list = document.getElementById('custom-posts-list');
            list.innerHTML = '';

            if (!globalCalculatedPosts || globalCalculatedPosts.segments.length === 0) {
                list.innerHTML = '<p style="font-size:0.85rem; color:#999; font-style:italic;">A√±ade segmentos primero para personalizar postes.</p>';
                return;
            }

            const defaultModel = document.getElementById('lv-post-model').value;

            globalCalculatedPosts.segments.forEach((segment, segIdx) => {
                if (segment.length === 0) return;

                const segmentDiv = document.createElement('div');
                segmentDiv.style.cssText = 'margin-bottom:10px; padding:8px; background:white; border-radius:4px; border:1px solid #ddd;';
                segmentDiv.innerHTML = `<strong style="font-size:0.85rem;">Segmento ${segIdx + 1}:</strong>`;

                segment.forEach((post, postIdx) => {
                    const key = `${segIdx}_${postIdx}`;
                    const currentModel = customPostSelections[key] || defaultModel;

                    const postRow = document.createElement('div');
                    postRow.style.cssText = 'display:flex; gap:5px; align-items:center; margin-top:5px; font-size:0.85rem;';
                    postRow.innerHTML = `
                        <input type="checkbox" id="chk-custom-${key}" ${customPostSelections[key] ? 'checked' : ''} 
                            onchange="toggleCustomPostSelect('${key}')">
                        <label style="flex:1; margin:0;">${post.type === 'auto' ? 'Intermedio' : 'Manual'} #${postIdx + 1}</label>
                        <select id="sel-custom-${key}" class="custom-post-select" style="width:140px; padding:4px; font-size:0.85rem;" 
                            ${!customPostSelections[key] ? 'disabled' : ''} 
                            onchange="setCustomPost('${key}', this.value)">
                            ${STA_LIST.map(sta => `<option value="${sta}" ${currentModel === sta ? 'selected' : ''}>${sta}</option>`).join('')}
                        </select>
                    `;

                    segmentDiv.appendChild(postRow);
                });

                list.appendChild(segmentDiv);
            });
        }

        function toggleCustomPostSelect(key) {
            const checkbox = document.getElementById(`chk-custom-${key}`);
            const select = document.getElementById(`sel-custom-${key}`);

            if (checkbox.checked) {
                select.disabled = false;
                customPostSelections[key] = select.value;
            } else {
                select.disabled = true;
                delete customPostSelections[key];
            }

            drawPreview();
        }

        function setCustomPost(key, model) {
            customPostSelections[key] = model;
            drawPreview();
        }

        // --- GEOMETRY ---
        function addBarandillaTramo() {
            const container = document.getElementById('b-tramos-list');
            const idx = container.children.length + 1;
            let angleLabel = idx === 1 ? "Direcci√≥n Inicial (¬∫)" : "Giro respecto anterior (¬∫)";
            let defaultVal = idx === 1 ? "0" : "90";
            const html = `
            <div class="tramo-card b-tramo">
                <button class="remove-btn" onclick="this.parentElement.remove(); drawPreview()">√ó</button>
                <h3>Tramo ${idx}</h3>
                <div style="background:#eee; padding:8px; margin-bottom:5px; border-radius:4px;"><label>${angleLabel}</label><input type="number" class="b-angle" value="${defaultVal}" oninput="drawPreview()"></div>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
                    <div><label>Longitud (m)</label><input type="number" class="b-len" step="0.01" oninput="drawPreview()"></div>
                    <div><label>Rodapi√©</label><input type="checkbox" class="b-rodapie" style="margin-top:40px;"></div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
            drawPreview();
        }

        function addLvTramo() {
            const container = document.getElementById('lv-tramos-list');
            const idx = container.children.length + 1;
            let startHtml = idx === 1 ? `<div style="background:#e8f5e9; padding:8px; margin-bottom:10px;"><label>Orientaci√≥n Inicial (¬∫)</label><input type="number" class="lv-start-angle" value="0" oninput="drawPreview()"></div>` : '';
            const html = `
            <div class="tramo-card lv-tramo" oninput="drawPreview()">
                <button class="remove-btn" onclick="this.parentElement.remove(); drawPreview()">√ó</button>
                <h3>Segmento ${idx}</h3>
                ${startHtml}
                <label>Longitud Recta (m)</label><input type="number" class="lv-len" step="0.01" value="0">
                <div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:5px;">
                    <div class="manual-points-list"></div>
                    <button class="btn-mini" onclick="addManualPoint(this)">+ P. Intermedio Manual</button>
                </div>
                <div style="margin-top:10px; padding:10px; background:#e3f2fd;">
                    <label>Al final:</label>
                    <select class="lv-end" onchange="this.nextElementSibling.classList.toggle('hidden', this.value !== 'curva'); drawPreview()">
                        <option value="nada">Sigue recto / Fin</option>
                        <option value="curva">Hay Curva</option>
                    </select>
                    <div class="hidden"><label>Giro (¬∫)</label><input type="number" class="lv-angle" value="90"><label>Modelo</label><select class="lv-curve-type" onchange="drawPreview()">${getEdleOptionsHTML()}</select></div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
            drawPreview();
        }

        function addManualPoint(btn) {
            btn.previousElementSibling.insertAdjacentHTML('beforeend', `<div class="manual-point-row"><input type="number" class="mp-dist" placeholder="Dist" style="width:70px;" oninput="drawPreview()"><select class="mp-type" onchange="drawPreview()">${getExtraElemOptions()}</select><button onclick="this.parentElement.remove(); drawPreview()" style="color:red; border:none;">√ó</button></div>`);
        }

        // --- CALC ---
        function solveBarandillaPosts(tramos, startType, endType) {
            if (tramos.length === 0) return { posts: [], count: 0 };
            const getOffset = (type) => { if (type === 'R91') return 0.35; if (type === 'R51') return 0.50; if (type === 'R41') return 2.50; return 0.35; };
            const startOff = getOffset(startType);
            const endOff = getOffset(endType);
            if (tramos.length === 1) return calcSegmentPosts(tramos[0].len, startOff, endOff, 0);
            const numCorners = tramos.length - 1;
            const combinations = 1 << numCorners;
            let bestConfig = null; let minTotalPosts = Infinity;
            for (let i = 0; i < combinations; i++) {
                let currentTotal = 0; let currentLayout = [];
                for (let t = 0; t < tramos.length; t++) {
                    let s_off = (t === 0) ? startOff : (((i >> (t - 1)) & 1) === 0 ? 1.5 : 0.4);
                    let e_off = (t === tramos.length - 1) ? endOff : (((i >> t) & 1) === 0 ? 0.4 : 1.5);
                    const res = calcSegmentPosts(tramos[t].len, s_off, e_off, t);
                    currentTotal += res.count;
                    currentLayout.push(res.positions);
                }
                if (currentTotal < minTotalPosts) { minTotalPosts = currentTotal; bestConfig = currentLayout; }
            }
            return { posts: bestConfig, count: minTotalPosts };
        }

        function calcSegmentPosts(length, startM, endM) {
            const positions = []; positions.push(startM);
            const coverDist = length - startM - endM;
            if (coverDist > 0) {
                const spaces = Math.ceil(coverDist / 2.5);
                const step = coverDist / spaces;
                for (let k = 1; k < spaces; k++) positions.push(startM + (step * k));
            }
            const lastPos = length - endM;
            if (Math.abs(lastPos - startM) > 0.01) positions.push(lastPos);
            return { positions: positions, count: positions.length };
        }

        function solveLvPosts(tramosData) {
            const support = document.getElementById('lv-support-type').value;
            let maxDist = 10.0; // Default

            if (currentSystem === 'rail') {
                const customDist = parseFloat(document.getElementById('rail-dist-max').value) || 3;
                maxDist = customDist;
            } else if (support === 'sand02') {
                // Use custom max distance for sand02
                const customDist = parseFloat(document.getElementById('lv-max-dist-sand02').value) || 10;
                maxDist = customDist;
            } else {
                // Use custom max distance for poste (default 15m)
                const customDist = parseFloat(document.getElementById('lv-max-dist-poste').value) || 15;
                maxDist = customDist;
            }

            let totalSZH = 0; let totalExtras = 0; const segmentResults = [];
            tramosData.forEach(tramo => {
                if (tramo.len <= 0) { segmentResults.push([]); return; }
                let manualPoints = tramo.manual.map(m => ({ dist: parseFloat(m.dist), type: m.type })).filter(m => m.dist > 0 && m.dist < tramo.len).sort((a, b) => a.dist - b.dist);
                let nodes = [0, ...manualPoints.map(m => m.dist), tramo.len];
                let postsPositions = [];
                for (let i = 0; i < nodes.length - 1; i++) {
                    const span = nodes[i + 1] - nodes[i];
                    if (i > 0) { postsPositions.push({ pos: nodes[i], type: 'manual', ref: manualPoints[i - 1].type }); totalExtras++; }
                    if (span > 0) {
                        const spaces = Math.ceil(span / maxDist);
                        const realDist = span / spaces;
                        for (let k = 1; k < spaces; k++) { postsPositions.push({ pos: nodes[i] + (realDist * k), type: 'auto', ref: 'SZH' }); totalSZH++; }
                    }
                }
                segmentResults.push(postsPositions);
            });
            const result = { segments: segmentResults, countSZH: totalSZH, countExtras: totalExtras };
            globalCalculatedPosts = result; // Store globally for custom posts UI
            return result;
        }

        // --- DRAW ---
        function drawPreview() {
            const cvs = document.getElementById('geo-canvas'); const ctx = cvs.getContext('2d');
            const width = cvs.width; const height = cvs.height;
            ctx.clearRect(0, 0, width, height);
            let points = [{ x: 0, y: 0 }]; let currentAngle = 0; const bomData = {};

            if (currentSystem === 'barandilla') {
                let tramosData = [];
                document.querySelectorAll('.b-tramo').forEach((el, i) => {
                    const angleInput = parseFloat(el.querySelector('.b-angle').value) || 0;
                    currentAngle = i === 0 ? angleInput : currentAngle + angleInput;
                    const len = parseFloat(el.querySelector('.b-len').value) || 0;
                    tramosData.push({ len: len, angle: currentAngle });
                    const rad = currentAngle * Math.PI / 180;
                    const last = points[points.length - 1];
                    points.push({ x: last.x + len * Math.cos(rad), y: last.y + len * Math.sin(rad) });
                });
                if (points.length < 2) return;
                const sol = solveBarandillaPosts(tramosData, document.getElementById('b-start-conf').value, document.getElementById('b-end-conf').value);
                // Fit to screen
                const xs = points.map(p => p.x), ys = points.map(p => p.y);
                const scale = Math.min((width - 100) / (Math.max(...xs) - Math.min(...xs) || 1), (height - 100) / (Math.max(...ys) - Math.min(...ys) || 1)) || 20;
                const toScreen = (x, y) => ({ x: 50 + (x - Math.min(...xs)) * scale + (width - 100 - (Math.max(...xs) - Math.min(...xs)) * scale) / 2, y: height - (50 + (y - Math.min(...ys)) * scale + (height - 100 - (Math.max(...ys) - Math.min(...ys)) * scale) / 2) });
                // Draw
                ctx.beginPath(); ctx.strokeStyle = '#e67e22'; ctx.lineWidth = 4;
                points.forEach((p, i) => { const s = toScreen(p.x, p.y); if (i === 0) ctx.moveTo(s.x, s.y); else ctx.lineTo(s.x, s.y); });
                ctx.stroke();
                if (sol.posts && sol.posts.length > 0) {
                    tramosData.forEach((tramo, idx) => {
                        const pStart = points[idx]; const rad = tramo.angle * Math.PI / 180;
                        (sol.posts[idx] || []).forEach(dist => {
                            const s = toScreen(pStart.x + dist * Math.cos(rad), pStart.y + dist * Math.sin(rad));
                            ctx.fillStyle = '#0056b3'; ctx.beginPath(); ctx.arc(s.x, s.y, 4, 0, 2 * Math.PI); ctx.fill();
                        });
                    });
                }
                document.getElementById('bom-display').innerText = `Postes S50: ${sol.count}`;
                bomData['1'] = "Extremos"; bomData['2'] = "Poste S50"; renderBOMTableSimple(bomData);
            } else {
                let tramosData = [];
                const supportRef = document.getElementById('lv-support-type').value === 'poste' ? document.getElementById('lv-post-model').value : "Chapa Sand02";
                const ebModel = document.getElementById('lv-eb-model').value;
                const szhModel = document.getElementById('lv-szh-model').value;
                const manualTypesSet = new Set();

                document.querySelectorAll('.lv-tramo').forEach((el, i) => {
                    const len = parseFloat(el.querySelector('.lv-len').value) || 0;

                    if (i === 0) {
                        var startEl = el.querySelector('.lv-start-angle');
                        currentAngle = startEl ? parseFloat(startEl.value) || 0 : 0;
                    }
                    const manuals = [];
                    el.querySelectorAll('.manual-point-row').forEach(row => { const type = row.querySelector('.mp-type').value; manuals.push({ dist: row.querySelector('.mp-dist').value, type: type }); manualTypesSet.add(type); });
                    const hasCurve = el.querySelector('.lv-end').value === 'curva';
                    const curveModel = hasCurve ? el.querySelector('.lv-curve-type').value : null;
                    if (hasCurve) manualTypesSet.add(curveModel);
                    tramosData.push({ len: len, angle: currentAngle, manual: manuals, hasCurve: hasCurve, curveModel: curveModel });
                    const rad = currentAngle * Math.PI / 180;
                    const last = points[points.length - 1];
                    points.push({ x: last.x + len * Math.cos(rad), y: last.y + len * Math.sin(rad) });
                    if (hasCurve) currentAngle += parseFloat(el.querySelector('.lv-angle').value) || 0;
                });

                if (points.length < 2) return;
                const sol = solveLvPosts(tramosData);

                if (currentSystem === 'rail') {
                    const tipo = document.getElementById('rail-soporte-tipo').value;
                    let model = "";
                    if (tipo === 'bef') model = document.getElementById('rail-bef-model').value;
                    else if (tipo === 'sta') model = document.getElementById('rail-sta-model').value;
                    else model = document.getElementById('rail-eb-model').value;

                    const isLoop = document.getElementById('lv-loop').checked; // Using geometry loop
                    const totalSoportes = isLoop ? sol.countSZH : sol.countSZH + 2;
                    document.getElementById('bom-display').innerText = `Soportes (${model}): ${totalSoportes}`;
                } else {
                    document.getElementById('bom-display').innerText = `SZH: ${sol.countSZH} | Extras: ${sol.countExtras}`;
                }

                const sortedManuals = Array.from(manualTypesSet).sort();
                const manualMap = {};
                sortedManuals.forEach(function (m, i) {
                    manualMap[m] = 3 + i;
                });

                // ...

                Object.keys(manualMap).forEach(function (key) {
                    var val = manualMap[key];
                    bomData[val] = supportRef + ' + ' + key;
                });

                // Fit
                const xs = points.map(p => p.x), ys = points.map(p => p.y);
                const scale = Math.min((width - 100) / (Math.max(...xs) - Math.min(...xs) || 1), (height - 100) / (Math.max(...ys) - Math.min(...ys) || 1)) || 20;
                const toScreen = (x, y) => ({ x: 50 + (x - Math.min(...xs)) * scale + (width - 100 - (Math.max(...xs) - Math.min(...xs)) * scale) / 2, y: height - (50 + (y - Math.min(...ys)) * scale + (height - 100 - (Math.max(...ys) - Math.min(...ys)) * scale) / 2) });

                ctx.beginPath(); ctx.strokeStyle = '#27ae60'; ctx.lineWidth = 4;
                points.forEach((p, i) => { const s = toScreen(p.x, p.y); if (i === 0) ctx.moveTo(s.x, s.y); else ctx.lineTo(s.x, s.y); });
                ctx.stroke();

                ctx.font = "bold 20px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";

                // Nodes
                points.forEach((p, idx) => {
                    const s = toScreen(p.x, p.y);
                    if (idx === 0 || idx === points.length - 1) { // Extremos
                        ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(s.x, s.y, 8, 0, 2 * Math.PI); ctx.fill();

                        // Calcular perpendicular a la l√≠nea
                        let lineAngle;
                        if (idx === 0 && points.length > 1) {
                            // Primer punto: usar √°ngulo de la primera l√≠nea
                            lineAngle = tramosData[0].angle * Math.PI / 180;
                        } else if (idx === points.length - 1) {
                            // √öltimo punto: usar √°ngulo de la √∫ltima l√≠nea
                            lineAngle = tramosData[tramosData.length - 1].angle * Math.PI / 180;
                        }

                        // Perpendicular: sumar 90¬∞ (PI/2)
                        const perpAngle = lineAngle + Math.PI / 2;
                        const offset = 25;
                        const textX = s.x + offset * Math.cos(perpAngle);
                        const textY = s.y + offset * Math.sin(perpAngle);

                        ctx.fillStyle = 'orange'; ctx.fillText("1", textX, textY);
                    } else { // Esquinas
                        const prev = tramosData[idx - 1];
                        if (prev.hasCurve) {
                            ctx.fillStyle = 'orange'; ctx.fillRect(s.x - 8, s.y - 8, 16, 16);
                            ctx.fillStyle = 'white'; ctx.font = "bold 12px Arial"; ctx.fillText(manualMap[prev.curveModel], s.x, s.y);
                            ctx.font = "bold 20px Arial";
                        } else {
                            ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(s.x, s.y, 5, 0, 2 * Math.PI); ctx.fill();
                        }
                    }
                });

                // Intermedios
                let angleAcum = tramosData.length ? tramosData[0].angle : 0;
                tramosData.forEach((tramo, idx) => {
                    const pStart = points[idx];
                    const rad = angleAcum * Math.PI / 180;

                    // Perpendicular a la l√≠nea para los intermedios
                    // Restar 90¬∞ porque el eje Y del canvas est√° invertido
                    const perpAngle = rad - Math.PI / 2;
                    const offset = 25;

                    sol.segments[idx].forEach(post => {
                        const s = toScreen(pStart.x + post.pos * Math.cos(rad), pStart.y + post.pos * Math.sin(rad));

                        // Calcular posici√≥n del texto en perpendicular
                        const textX = s.x + offset * Math.cos(perpAngle);
                        const textY = s.y - offset * Math.sin(perpAngle); // Invertir Y para canvas

                        if (post.type === 'manual') {
                            ctx.fillStyle = 'orange'; ctx.fillRect(s.x - 6, s.y - 6, 12, 12);
                            ctx.fillStyle = 'orange'; ctx.fillText(manualMap[post.ref], textX, textY);
                        } else {
                            ctx.fillStyle = '#2ecc71'; ctx.beginPath(); ctx.arc(s.x, s.y, 5, 0, 2 * Math.PI); ctx.fill();
                            ctx.fillStyle = 'orange'; ctx.fillText("2", textX, textY);
                        }
                    });
                    if (idx < tramosData.length - 1) angleAcum = tramosData[idx + 1].angle;
                });

                if (currentSystem === 'rail') {
                    const tipo = document.getElementById('rail-soporte-tipo').value;
                    let railModel = "";
                    if (tipo === 'bef') railModel = document.getElementById('rail-bef-model').value;
                    else if (tipo === 'sta') railModel = document.getElementById('rail-sta-model').value;
                    else railModel = document.getElementById('rail-eb-model').value;

                    bomData['1'] = railModel;
                    bomData['2'] = railModel;
                    for (const [key, val] of Object.entries(manualMap)) { bomData[val] = `${railModel} + ${key}`; }
                } else {
                    bomData['1'] = `${supportRef} + Ends + ${ebModel}`;
                    bomData['2'] = `${supportRef} + ${szhModel}`;
                    for (const [key, val] of Object.entries(manualMap)) { bomData[val] = `${supportRef} + ${key}`; }
                }
                renderBOMTableSimple(bomData);
            }
        }

        function renderBOMTableSimple(data) {
            const tbody = document.getElementById('bom-table-body'); tbody.innerHTML = '';
            Object.keys(data).sort((a, b) => a - b).forEach(k => {
                tbody.insertAdjacentHTML('beforeend', `<tr><td><span class="bom-badge">${k}</span></td><td><strong>Tipo ${k}</strong></td><td>${data[k]}</td></tr>`);
            });
        }

        // --- FOTOS & OVERLAY ---
        const canvas = document.getElementById('editor'); const ctx = canvas.getContext('2d');

        function loadPhoto(e) {
            if (e.target.files[0]) {
                const r = new FileReader();
                r.onload = ev => {
                    imgObj.onload = () => {
                        // Ajustar canvas a la foto pero limitando ancho
                        const scale = Math.min(800 / imgObj.width, 1);
                        canvas.width = imgObj.width * scale;
                        canvas.height = imgObj.height * scale;
                        renderEditor();
                    };
                    imgObj.src = ev.target.result;
                };
                r.readAsDataURL(e.target.files[0]);
            }
        }

        function importPlanToPhoto() {
            if (!imgObj.src) { alert("Carga una foto primero"); return; }
            const planCanvas = document.getElementById('geo-canvas');
            overlay.img = new Image();
            overlay.img.src = planCanvas.toDataURL();
            overlay.img.onload = () => {
                overlay.active = true;
                // Centrar overlay
                overlay.scale = 1;
                overlay.x = (canvas.width - overlay.img.width) / 2;
                overlay.y = (canvas.height - overlay.img.height) / 2;
                document.getElementById('overlay-controls').style.display = 'block';
                renderEditor();
            };
        }

        function fixOverlay() {
            overlay.active = false;
            document.getElementById('overlay-controls').style.display = 'none';
            // "Quemar" el overlay en la imagen base para que al pintar encima no se borre
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.drawImage(canvas, 0, 0);
            imgObj.src = tempCanvas.toDataURL(); // Actualizar la imagen base con lo que vemos
            // (Nota: esto es un truco simple, en una app real se gestionarian capas)
        }

        function renderEditor() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (imgObj.src) ctx.drawImage(imgObj, 0, 0, canvas.width, canvas.height);

            if (overlay.active && overlay.img) {
                const s = parseFloat(document.getElementById('overlay-scale').value);
                overlay.scale = s;
                const w = overlay.img.width * s;
                const h = overlay.img.height * s;
                ctx.drawImage(overlay.img, overlay.x, overlay.y, w, h);
            }
        }

        // --- INTERACCION EDITOR ---
        let startX, startY, snapshot;

        // Mouse Events
        canvas.onmousedown = e => {
            if (overlay.active) {
                overlay.isDragging = true; startX = e.offsetX - overlay.x; startY = e.offsetY - overlay.y;
            } else {
                isDrawing = true; startX = e.offsetX; startY = e.offsetY; ctx.beginPath(); snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
        };
        canvas.onmousemove = e => {
            if (overlay.active && overlay.isDragging) {
                overlay.x = e.offsetX - startX; overlay.y = e.offsetY - startY; renderEditor();
            } else if (isDrawing) {
                ctx.putImageData(snapshot, 0, 0);
                ctx.lineWidth = 5; ctx.strokeStyle = "red"; ctx.lineCap = "round";
                ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke();
            }
        };
        canvas.onmouseup = () => { isDrawing = false; overlay.isDragging = false; };

        // Touch Events
        canvas.ontouchstart = e => {
            const r = canvas.getBoundingClientRect();
            const tx = e.touches[0].clientX - r.left; const ty = e.touches[0].clientY - r.top;
            if (overlay.active) {
                overlay.isDragging = true; startX = tx - overlay.x; startY = ty - overlay.y;
            } else {
                isDrawing = true; startX = tx; startY = ty; ctx.beginPath(); snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
        };
        canvas.ontouchmove = e => {
            e.preventDefault();
            const r = canvas.getBoundingClientRect();
            const tx = e.touches[0].clientX - r.left; const ty = e.touches[0].clientY - r.top;
            if (overlay.active && overlay.isDragging) {
                overlay.x = tx - startX; overlay.y = ty - startY; renderEditor();
            } else if (isDrawing) {
                ctx.putImageData(snapshot, 0, 0);
                ctx.lineWidth = 5; ctx.strokeStyle = "red"; ctx.lineCap = "round";
                ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(tx, ty); ctx.stroke();
            }
        };
        canvas.ontouchend = () => { isDrawing = false; overlay.isDragging = false; };

        function clearDraw() { imgObj.src = imgObj.src; setTimeout(renderEditor, 50); } // Reset to last saved state
        function savePhoto() { if (!canvas.width) return; savedPhotos.push(canvas.toDataURL('image/jpeg', 0.6)); const i = document.createElement('img'); i.src = savedPhotos[savedPhotos.length - 1]; i.className = 'thumb'; document.getElementById('gallery-grid').appendChild(i); document.getElementById('photo-count').innerText = savedPhotos.length; }

        // --- CALCULATE BOM FOR EXCEL EXPORT ---
        function calculateLineBOM() {
            const bom = {};

            if (currentSystem === 'sand02' || currentSystem === 'poste') {
                const variant = document.getElementById('lv-variant').value;
                const supportType = document.getElementById('lv-support-type').value;

                // Recoger datos de geometr√≠a
                let tramosData = [];
                let totalLength = 0;
                let countCurves = 0;
                const curveModels = {};

                document.querySelectorAll('.lv-tramo').forEach((el, i) => {
                    const len = parseFloat(el.querySelector('.lv-len').value) || 0;
                    totalLength += len;

                    const manuals = [];
                    el.querySelectorAll('.manual-point-row').forEach(row => {
                        manuals.push({
                            dist: row.querySelector('.mp-dist').value,
                            type: row.querySelector('.mp-type').value
                        });
                    });

                    const hasCurve = el.querySelector('.lv-end').value === 'curva';
                    const curveModel = hasCurve ? el.querySelector('.lv-curve-type').value : null;

                    if (hasCurve) {
                        countCurves++;
                        curveModels[curveModel] = (curveModels[curveModel] || 0) + 1;
                    }

                    tramosData.push({ len, manual: manuals, hasCurve, curveModel });
                });

                // Calcular posts autom√°ticos
                const sol = solveLvPosts(tramosData);
                const countSZH = sol.countSZH;
                const countExtras = sol.countExtras;

                if (supportType === 'sand02') {
                    // SAND-02: 2 extremos + intermedios + curvas (cada curva es un soporte adicional)
                    const totalSand02 = 2 + countSZH + countCurves;
                    bom['SAND-02'] = totalSand02;

                    // BEF 306-VE250: SAND-02 √ó 20
                    bom['BEF 306-VE250'] = totalSand02 * 20;

                    // Elementos seg√∫n variante
                    if (variant === 'ends10') {
                        const ebModel = document.getElementById('lv-eb-model').value;
                        const szhModel = document.getElementById('lv-szh-model').value;

                        bom[ebModel] = 2; // Extremos
                        if (countSZH > 0) bom[szhModel] = countSZH; // Intermedios

                        // Cable SEIL-30
                        bom['SEIL-30'] = Math.ceil(totalLength + 2);

                        // ENDS-10
                        bom['ENDS-10'] = 1;

                        // Absorbedores (si checkbox activado)
                        if (document.getElementById('chk-shock').checked) {
                            const shockQty = parseInt(document.getElementById('lv-shock-qty').value) || 0;
                            const shockType = document.getElementById('lv-shock-type').value;
                            if (shockQty > 0) bom[shockType] = shockQty;
                        }

                        // Curvas
                        for (const [model, qty] of Object.entries(curveModels)) {
                            bom[model] = qty;
                        }

                        // Cartel de instalaci√≥n
                        bom['AIO-TYP-20-ES'] = 1;

                        // Alzas VL-SAND-SET (si checkbox activado)
                        if (document.getElementById('chk-alzas').checked) {
                            const totalAlzas = countSZH + countCurves;
                            if (totalAlzas > 0) bom['VL-SAND-SET-10'] = totalAlzas;
                        }

                    } else { // ends50
                        const ebModel = document.getElementById('lv-eb-model').value;
                        const szhModel = document.getElementById('lv-szh-model').value;

                        bom[ebModel] = 2; // Extremos
                        if (countSZH > 0) bom[szhModel] = countSZH; // Intermedios

                        // Cable SEIL-30
                        bom['SEIL-30'] = Math.ceil(totalLength + 2);

                        // Configuraci√≥n de extremos Ends50
                        const ends50Config = document.getElementById('lv-ends50-config').value;
                        if (ends50Config === '50-51') {
                            bom['AIO-ENDS-50'] = 1;
                            bom['AIO-ENDS-51'] = 1;
                        } else {
                            bom['AIO-ENDS-50'] = 2;
                        }

                        // Curvas
                        for (const [model, qty] of Object.entries(curveModels)) {
                            bom[model] = qty;
                        }

                        // Cartel de instalaci√≥n
                        bom['AIO-TYP-50'] = 1;

                        // Alzas VL-SAND-SET (si checkbox activado)
                        if (document.getElementById('chk-alzas').checked) {
                            const totalAlzas = countSZH + countCurves;
                            if (totalAlzas > 0) bom['VL-SAND-SET-10'] = totalAlzas;
                        }
                    }

                    // Cartel ADEKUA (siempre)
                    bom['CARTEL ADEKUA'] = 1;
                } else if (supportType === 'poste') {
                    // POST INSTALLATION
                    const usePosts = document.getElementById('chk-use-posts') && document.getElementById('chk-use-posts').checked;

                    if (usePosts) {
                        // WITH POSTS
                        const defaultModel = document.getElementById('lv-post-model').value;
                        const postCounts = {}; // Track count by model

                        // Count posts by model (considering custom selections)
                        let totalPosts = 2; // 2 extremos

                        // Extremos always use default model
                        postCounts[defaultModel] = (postCounts[defaultModel] || 0) + 2;

                        // Count intermediate posts
                        globalCalculatedPosts.segments.forEach((segment, segIdx) => {
                            segment.forEach((post, postIdx) => {
                                const key = `${segIdx}_${postIdx}`;
                                const model = customPostSelections[key] || defaultModel;
                                postCounts[model] = (postCounts[model] || 0) + 1;
                                totalPosts++;
                            });
                        });

                        // Add posts for curves
                        totalPosts += countCurves;
                        postCounts[defaultModel] = (postCounts[defaultModel] || 0) + countCurves;

                        // Add posts to BOM (ordered by model name)
                        Object.keys(postCounts).sort().forEach(model => {
                            bom[model] = postCounts[model];
                        });

                        // Elementos seg√∫n variante
                        if (variant === 'ends10') {
                            const ebModel = document.getElementById('lv-eb-model').value;
                            const szhModel = document.getElementById('lv-szh-model').value;

                            // Extremos
                            bom[ebModel] = 2;

                            // Intermedios
                            if (countSZH > 0) bom[szhModel] = countSZH;

                            // ENDS-10
                            bom['ENDS-10'] = 1;

                            // Cable SEIL-30
                            bom['SEIL-30'] = Math.ceil(totalLength + 2);

                            // Curvas EDLE
                            for (const [model, qty] of Object.entries(curveModels)) {
                                bom[model] = qty;
                            }

                            // Absorbedores (si checkbox activado)
                            if (document.getElementById('chk-shock').checked) {
                                const shockQty = parseInt(document.getElementById('lv-shock-qty').value) || 0;
                                const shockType = document.getElementById('lv-shock-type').value;
                                if (shockQty > 0) bom[shockType] = shockQty;
                            }

                            // Cartel de instalaci√≥n
                            bom['AIO-TYP-10'] = 1;

                            // Placas base (si checkbox activado)
                            if (document.getElementById('chk-baseplate') && document.getElementById('chk-baseplate').checked) {
                                const postSuffix = defaultModel.split('-').pop();
                                bom[`VL-20-${postSuffix}`] = totalPosts;
                            }

                            // Alzas de nivelaci√≥n (si checkbox activado) - SIEMPRE VL-20-50
                            if (document.getElementById('chk-alzas-posts') && document.getElementById('chk-alzas-posts').checked) {
                                const totalAlzas = countSZH + countCurves;
                                if (totalAlzas > 0) bom['VL-20-50'] = totalAlzas;
                            }

                        } else { // ends50
                            const szhModel = document.getElementById('lv-szh-model').value;

                            // Configuraci√≥n de extremos Ends50
                            const ends50Config = document.getElementById('lv-ends50-config').value;
                            if (ends50Config === '50-51') {
                                bom['AIO-ENDS-50'] = 1;
                                bom['AIO-ENDS-51'] = 1;
                            } else {
                                bom['AIO-ENDS-50'] = 2;
                            }

                            // Intermedios
                            if (countSZH > 0) bom[szhModel] = countSZH;

                            // Cable SEIL-30
                            bom['SEIL-30'] = Math.ceil(totalLength + 2);

                            // Curvas EDLE
                            for (const [model, qty] of Object.entries(curveModels)) {
                                bom[model] = qty;
                            }

                            // Cartel de instalaci√≥n
                            bom['AIO-TYP-50'] = 1;

                            // Placas base (si checkbox activado)
                            if (document.getElementById('chk-baseplate') && document.getElementById('chk-baseplate').checked) {
                                const postSuffix = defaultModel.split('-').pop();
                                bom[`VL-20-${postSuffix}`] = totalPosts;
                            }

                            // Alzas de nivelaci√≥n (si checkbox activado) - SIEMPRE VL-20-50
                            if (document.getElementById('chk-alzas-posts') && document.getElementById('chk-alzas-posts').checked) {
                                const totalAlzas = countSZH + countCurves;
                                if (totalAlzas > 0) bom['VL-20-50'] = totalAlzas;
                            }
                        }
                    } else {
                        // WITHOUT POSTS - Solo extremos
                        if (variant === 'ends10') {
                            const ebModel = document.getElementById('lv-eb-model').value;
                            const szhModel = document.getElementById('lv-szh-model').value;

                            // Solo extremos, sin postes
                            bom[ebModel] = 2;

                            // Intermedios
                            if (countSZH > 0) bom[szhModel] = countSZH;

                            // ENDS-10
                            bom['ENDS-10'] = 1;

                            // Cable SEIL-30
                            bom['SEIL-30'] = Math.ceil(totalLength + 2);

                            // Curvas EDLE
                            for (const [model, qty] of Object.entries(curveModels)) {
                                bom[model] = qty;
                            }

                            // Absorbedores (si checkbox activado)
                            if (document.getElementById('chk-shock').checked) {
                                const shockQty = parseInt(document.getElementById('lv-shock-qty').value) || 0;
                                const shockType = document.getElementById('lv-shock-type').value;
                                if (shockQty > 0) bom[shockType] = shockQty;
                            }

                            // Cartel de instalaci√≥n
                            bom['AIO-TYP-10'] = 1;

                        } else { // ends50
                            const szhModel = document.getElementById('lv-szh-model').value;

                            // Configuraci√≥n de extremos Ends50 - sin postes
                            const ends50Config = document.getElementById('lv-ends50-config').value;
                            if (ends50Config === '50-51') {
                                bom['AIO-ENDS-50'] = 1;
                                bom['AIO-ENDS-51'] = 1;
                            } else {
                                bom['AIO-ENDS-50'] = 2;
                            }

                            // Intermedios
                            if (countSZH > 0) bom[szhModel] = countSZH;

                            // Cable SEIL-30
                            bom['SEIL-30'] = Math.ceil(totalLength + 2);

                            // Curvas EDLE
                            for (const [model, qty] of Object.entries(curveModels)) {
                                bom[model] = qty;
                            }

                            // Cartel de instalaci√≥n
                            bom['AIO-TYP-50'] = 1;
                        }
                    }

                    // Cartel ADEKUA (siempre)
                    bom['CARTEL ADEKUA'] = 1;
                }
            }

            return bom;
        }

        // --- CALCULATE RAIL BOM ---
        function calculateRailBOM() {
            const bom = {};

            // Get configuration
            const longitud = parseFloat(document.getElementById('rail-longitud').value) || 0;
            const isClosed = document.getElementById('rail-cerrada').checked;
            const tipoSoporte = document.getElementById('rail-soporte-tipo').value;
            const distMax = parseFloat(document.getElementById('rail-dist-max').value) || 3;
            const usar6m = document.getElementById('rail-usar-6m').checked;
            const carroTipo = document.getElementById('rail-carro-tipo').value;
            const unionTipo = document.getElementById('rail-union-tipo').value;
            const optimizarVE5 = document.getElementById('rail-optimizar-ve5').checked;

            if (longitud <= 0) return bom;

            // Calculate supports
            const numExtremosBase = isClosed ? 0 : 2;
            let numIntermedios = 0;

            if (distMax > 0) {
                if (isClosed) {
                    // Closed loop: supports distributed evenly around perimeter
                    numIntermedios = Math.ceil(longitud / distMax);
                } else {
                    // Open line: intermediates between extremes
                    // For N total supports, we have N-1 segments
                    // We need: longitud / (N-1) <= distMax
                    // Therefore: N >= (longitud / distMax) + 1
                    // Intermediates = N - 2 (extremes)
                    if (longitud > distMax) {
                        const totalNeeded = Math.ceil(longitud / distMax) + 1;
                        numIntermedios = totalNeeded - 2; // Subtract the 2 extremes
                    }
                }
            }

            const totalSoportes = numExtremosBase + numIntermedios;

            // Add supports based on type
            if (tipoSoporte === 'bef') {
                const befModel = document.getElementById('rail-bef-model').value;
                if (befModel.includes('-VE5')) {
                    const numPacks = Math.ceil(totalSoportes / 5);
                    if (numPacks > 0) bom[befModel] = numPacks;
                } else if (befModel === 'TAURUS-BEF-13') { // Fallback legacy
                    const numPacks = Math.ceil(totalSoportes / 5);
                    if (numPacks > 0) bom['TAURUS-BEF-13-VE5'] = numPacks;
                } else {
                    if (totalSoportes > 0) bom[befModel] = totalSoportes;
                }
            } else if (tipoSoporte === 'sta') {
                const staModel = document.getElementById('rail-sta-model').value;
                if (totalSoportes > 0) {
                    bom[staModel] = totalSoportes;
                    bom['TAURUS-BEF-30'] = totalSoportes;
                }
            } else { // bef-eb
                const ebModel = document.getElementById('rail-eb-model').value;
                const befAdicional = document.getElementById('rail-bef-adicional').value;
                const addVarilla = document.getElementById('rail-varilla-m16').checked;

                if (totalSoportes > 0) {
                    bom['BEF-411'] = totalSoportes;
                    bom[ebModel] = totalSoportes;
                    bom[befAdicional] = totalSoportes;

                    if (addVarilla) {
                        const cantidadVarillas = totalSoportes * 0.5;
                        bom['VAR-M16'] = cantidadVarillas;
                    }
                }
            }

            // Calculate rails
            let numRailes6m = 0;
            let numRailes3m = 0;

            if (usar6m && longitud >= 6) {
                numRailes6m = Math.floor(longitud / 6);
                const resto = longitud - (numRailes6m * 6);
                if (resto > 0) {
                    numRailes3m = Math.ceil(resto / 3);
                }
            } else {
                numRailes3m = Math.ceil(longitud / 3);
            }

            if (numRailes6m > 0) {
                bom['TAURUS-RAIL-10-6000'] = numRailes6m;
            }
            if (numRailes3m > 0) {
                bom['TAURUS-RAIL-10-3000'] = numRailes3m;
            }

            // Calculate unions
            const totalSegmentos = numRailes6m + numRailes3m;
            let numUniones = 0;

            if (isClosed) {
                numUniones = totalSegmentos; // Closed loop needs same number as segments
            } else {
                numUniones = totalSegmentos > 0 ? totalSegmentos - 1 : 0; // Open line needs segments - 1
            }

            if (numUniones > 0) {
                const tienePackVE5 = (unionTipo === 'TAURUS-VB-10' || unionTipo === 'TAURUS-VB-12');

                if (tienePackVE5 && optimizarVE5) {
                    const numPacks = Math.floor(numUniones / 5);
                    const numSueltas = numUniones % 5;

                    if (numPacks > 0) {
                        bom[`${unionTipo}-VE5`] = numPacks;
                    }
                    if (numSueltas > 0) {
                        bom[unionTipo] = numSueltas;
                    }
                } else {
                    bom[unionTipo] = numUniones;
                }
            }

            // Add terminations
            if (isClosed) {
                bom['TAURUS-EA-11'] = 1; // Solo entrada/salida
            } else {
                bom['TAURUS-EA-10'] = 1; // Final
                bom['TAURUS-EA-11'] = 1; // Entrada/salida
            }

            // Add cart
            bom[carroTipo] = 1;

            // Add signs
            bom['TAURUS-TYP-10'] = 1;
            if (totalSoportes > 0) {
                bom['CARTEL ADEKUA'] = 1;
            }

            return bom;
        }

        // --- EXPORT TO EXCEL ---
        function exportToExcel() {
            let bom = {};

            if (currentSystem === 'rail') {
                // Rail system
                bom = calculateRailBOM();
            } else if (currentSystem === 'sand02' || currentSystem === 'poste') {
                // Line systems
                const supportType = document.getElementById('lv-support-type').value;
                if (supportType !== 'sand02' && supportType !== 'poste') {
                    alert('La exportaci√≥n a Excel solo est√° disponible para SAND-02 y Postes actualmente.');
                    return;
                }
                bom = calculateLineBOM();
            } else {
                alert('La exportaci√≥n a Excel solo est√° disponible para Sand02, Postes y Rail actualmente.');
                return;
            }

            if (Object.keys(bom).length === 0) {
                alert('No hay datos para exportar. Por favor, completa la geometr√≠a primero.');
                return;
            }

            // Crear array de datos para Excel
            const data = [['C√≥digo', 'Cantidad']];

            // Mantener el orden como en las im√°genes del usuario
            // El orden est√° determinado por el orden de inserci√≥n en el objeto bom
            for (const [codigo, cantidad] of Object.entries(bom)) {
                data.push([codigo, cantidad]);
            }

            // Crear workbook y worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Ajustar ancho de columnas
            ws['!cols'] = [
                { wch: 20 }, // C√≥digo
                { wch: 10 }  // Cantidad
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'BOM');

            // Generar nombre de archivo
            const cliente = document.getElementById('g-client').value || 'Cliente';
            const fecha = document.getElementById('g-date').value || new Date().toISOString().split('T')[0];
            const filename = `BOM_${cliente.replace(/\s+/g, '_')}_${fecha}.xlsx`;

            // Descargar
            XLSX.writeFile(wb, filename);
        }


        // --- GENERATE HTML REPORT ---
        function generateReport() {
            const cliente = document.getElementById('g-client').value || 'Cliente';
            const obra = document.getElementById('g-site').value || 'Obra';
            const fecha = document.getElementById('g-date').value || new Date().toISOString().split('T')[0];
            const sistemaMap = { 'barandilla': 'Barandilla', 'sand02': 'L√≠nea de Vida (Sand02)', 'poste': 'L√≠nea de Vida (Postes)', 'rail': 'Rail (TAURUS)' };
            const sistema = sistemaMap[currentSystem] || 'L√≠nea de Vida';

            // Capturar imagen del plano
            const planCanvas = document.getElementById('geo-canvas');
            const planImage = planCanvas.toDataURL('image/png');

            // Obtener tabla BOM actual
            const bomTableBody = document.getElementById('bom-table-body');
            let bomTableHTML = '';
            if (bomTableBody) {
                bomTableHTML = '<table style="width:100%; border-collapse:collapse; margin:20px 0;"><thead><tr style="background:#f8f9fa; border-bottom:2px solid #ddd;"><th style="padding:10px; text-align:left; border:1px solid #ddd;">#</th><th style="padding:10px; text-align:left; border:1px solid #ddd;">Tipo</th><th style="padding:10px; text-align:left; border:1px solid #ddd;">Configuraci√≥n</th></tr></thead><tbody>';
                Array.from(bomTableBody.querySelectorAll('tr')).forEach(row => {
                    bomTableHTML += '<tr>';
                    Array.from(row.querySelectorAll('td')).forEach(cell => {
                        bomTableHTML += `<td style="padding:10px; border:1px solid #eee;">${cell.innerHTML}</td>`;
                    });
                    bomTableHTML += '</tr>';
                });
                bomTableHTML += '</tbody></table>';
            }

            // Obtener fotos guardadas
            let photosHTML = '';
            if (savedPhotos.length > 0) {
                photosHTML = '<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:15px; margin:20px 0;">';
                savedPhotos.forEach((photo, idx) => {
                    photosHTML += `<div style="border:1px solid #ddd; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1);"><img src="${photo}" style="width:100%; height:auto; display:block;"><p style="padding:10px; margin:0; text-align:center; background:#f8f9fa; font-size:0.9rem;">Foto ${idx + 1}</p></div>`;
                });
                photosHTML += '</div>';
            } else {
                photosHTML = '<p style="color:#999; font-style:italic;">No se han guardado fotos en esta visita.</p>';
            }

            // Obtener informaci√≥n t√©cnica adicional
            let technicalNotesHTML = '';
            const requiresCrane = document.getElementById('chk-grua').checked;
            const fragileRoof = document.getElementById('chk-fragil').checked;
            const accessNotes = document.getElementById('txt-accesos').value.trim();

            if (requiresCrane || fragileRoof || accessNotes) {
                technicalNotesHTML = '<div style="background:#fff3cd; border-left:4px solid #ffc107; padding:15px; border-radius:4px; margin:20px 0;">';
                technicalNotesHTML += '<h3 style="margin:0 0 10px; color:#856404; font-size:1.1rem;">‚ö†Ô∏è Informaci√≥n T√©cnica Importante</h3>';
                technicalNotesHTML += '<ul style="margin:0; padding-left:20px;">';

                if (requiresCrane) {
                    technicalNotesHTML += '<li style="margin:5px 0; color:#856404;"><strong>Requiere Gr√∫a Externa</strong>: Es necesario coordinar el uso de gr√∫a para la instalaci√≥n.</li>';
                }

                if (fragileRoof) {
                    technicalNotesHTML += '<li style="margin:5px 0; color:#856404;"><strong>Cubierta Fr√°gil</strong>: Precauci√≥n m√°xima durante la instalaci√≥n. Requiere medidas de seguridad adicionales.</li>';
                }

                if (accessNotes) {
                    technicalNotesHTML += `<li style="margin:5px 0; color:#856404;"><strong>Notas sobre Accesos</strong>: ${accessNotes}</li>`;
                }

                technicalNotesHTML += '</ul></div>';
            }


            // Generar HTML del informe
            const reportHTML = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe - ${cliente} - ${fecha}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; color: #333; background: #fff; padding: 40px 20px; max-width: 1200px; margin: 0 auto; }
        h1 { color: #0056b3; font-size: 2rem; margin-bottom: 10px; border-bottom: 3px solid #0056b3; padding-bottom: 10px; }
        h2 { color: #0056b3; font-size: 1.5rem; margin: 30px 0 15px; border-bottom: 2px solid #e67e22; padding-bottom: 8px; }
        .header { background: linear-gradient(135deg, #0056b3, #004494); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .header h1 { color: white; border: none; margin: 0; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .info-item { background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px; }
        .info-label { font-size: 0.85rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-value { font-size: 1.2rem; font-weight: bold; margin-top: 5px; }
        section { margin-bottom: 40px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        img { max-width: 100%; height: auto; border-radius: 8px; border: 1px solid #ddd; }
        .plan-container { text-align: center; background: #2c3e50; padding: 20px; border-radius: 8px; }
        @media print {
            body { padding: 0; }
            section { page-break-inside: avoid; box-shadow: none; }
            .header { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Informe de Visita T√©cnica</h1>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Cliente</div>
                <div class="info-value">${cliente}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Obra</div>
                <div class="info-value">${obra}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Fecha</div>
                <div class="info-value">${fecha}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Sistema</div>
                <div class="info-value">${sistema}</div>
            </div>
        </div>
    </div>
    
    <section>
        <h2>üìê Plano de Instalaci√≥n</h2>
        <div class="plan-container">
            <img src="${planImage}" alt="Plano de Instalaci√≥n">
        </div>
    </section>
    
    <section>
        <h2>üì¶ Lista de Materiales (BOM)</h2>
        ${bomTableHTML || '<p style="color:#999; font-style:italic;">No se ha generado el BOM para este sistema.</p>'}
    </section>
    
    ${technicalNotesHTML ? `<section>${technicalNotesHTML}</section>` : ''}
    
    <section>
        <h2>üì∑ Galer√≠a de Fotos</h2>
        ${photosHTML}
    </section>
    
    <footer style="margin-top:40px; padding-top:20px; border-top:2px solid #eee; text-align:center; color:#999; font-size:0.9rem;">
        <p>Informe generado autom√°ticamente el ${new Date().toLocaleDateString('es-ES')} a las ${new Date().toLocaleTimeString('es-ES')}</p>
        <p>Toma de Datos v14 - Sistema de Gesti√≥n de Visitas T√©cnicas</p>
    </footer>
</body>
</html>`;

            // Descargar como archivo HTML
            const blob = new Blob([reportHTML], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Informe_${cliente.replace(/\s+/g, '_')}_${fecha}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- EXPORT ---
        function exportJSON() {
            const data = { general: { cliente: document.getElementById('g-client').value, obra: document.getElementById('g-site').value, sistema: currentSystem } };
            // (L√≥gica de exportaci√≥n igual a v13)
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })); a.download = `Visita.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        addBarandillaTramo(); addLvTramo(); toggleLvConfig();
    </script>
</body>

</html>