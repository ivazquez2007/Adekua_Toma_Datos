<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± ADEKUA. TOMA DE DATOS (Superposici√≥n + BOM)</title>
    <!-- SheetJS Library for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #0056b3;
            --accent: #e67e22;
            --bg: #f4f6f8;
            --success: #27ae60;
            --danger: #c0392b;
            --purple: #6f42c1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            padding-bottom: 90px;
        }

        /* HEADER */
        header {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        h1 {
            margin: 0;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* TABS */
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 50px;
            z-index: 90;
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 10px;
            border: none;
            background: none;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            border-bottom: 4px solid transparent;
            transition: 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: #f8f9fa;
        }

        /* CONTAINER */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* CARDS */
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
            border: 1px solid #e1e4e8;
        }

        h2 {
            font-size: 1rem;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 15px;
        }

        h3 {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 5px;
            font-weight: 600;
        }

        /* INPUTS */
        label {
            display: block;
            margin-top: 12px;
            font-weight: 600;
            font-size: 0.85rem;
            color: #34495e;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* CHECKBOX GROUP */
        .check-group {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f1f1;
        }

        .check-group input {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        /* BUTTONS */
        .btn-full {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            text-align: center;
        }

        .btn-add {
            background: var(--success);
            color: white;
        }

        .btn-mini {
            padding: 5px 10px;
            font-size: 0.8rem;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
        }

        .btn-save {
            background: var(--primary);
            color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-overlay {
            background: var(--purple);
            color: white;
        }

        .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--danger);
            background: none;
            border: none;
            font-size: 1.5rem;
            line-height: 1;
            cursor: pointer;
        }

        /* RADIO GROUP */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .radio-opt {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .radio-opt input {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
        }

        .radio-opt label {
            margin: 0;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: normal;
            color: #333;
        }

        /* SYSTEM SELECTOR */
        .sys-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            /* Allow wrapping for larger buttons with images */
        }

        .sys-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
            background: white;
            font-weight: bold;
            font-size: 0.85rem;
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .sys-btn img {
            max-width: 100%;
            height: 60px;
            /* Fixed height for consistency */
            object-fit: contain;
            border-radius: 4px;
        }

        .sys-btn.active {
            border-color: var(--primary);
            background: #ebf5fb;
            color: var(--primary);
        }

        /* VISUALIZACION (CANVAS) */
        #geo-preview-container {
            width: 100%;
            height: 350px;
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            position: sticky;
            top: 110px;
            z-index: 80;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }

        canvas {
            display: block;
        }

        .preview-label {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #333;
            font-size: 0.8rem;
            opacity: 0.7;
            pointer-events: none;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .bom-overlay {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* TABLA BOM */
        #bom-table-container {
            margin-top: 0px;
            margin-bottom: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .bom-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .bom-table th {
            background: #f8f9fa;
            text-align: left;
            padding: 10px;
            border-bottom: 2px solid #ddd;
            color: #555;
        }

        .bom-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .bom-badge {
            display: inline-block;
            width: 24px;
            height: 24px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            font-size: 0.8rem;
            margin-right: 8px;
        }

        /* UTILS */
        .hidden {
            display: none !important;
        }

        .conditional-box {
            background-color: #fff8e1;
            border: 1px solid #ffe0b2;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .tramo-card {
            background: #fdfdfd;
            border-left: 4px solid var(--accent);
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            border-radius: 4px;
            border: 1px solid #eee;
            border-left-width: 4px;
        }

        .config-card {
            border-left: 4px solid var(--primary);
            background: #eef2f5;
        }

        .manual-point-row {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            align-items: center;
            background: #fff;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
        }

        /* FOTOS */
        #canvas-container {
            position: relative;
            width: 100%;
            height: 300px;
            border: 2px dashed #ccc;
            margin: 10px 0;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }

        .thumb {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        /* DRAWING TOOLS */
        .tool-selector {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin: 10px 0;
            justify-content: center;
        }

        .tool-btn {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 60px;
        }

        .tool-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .tool-btn:hover {
            border-color: var(--primary);
        }

        .color-selector {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .color-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 3px solid #ddd;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-btn.active {
            border-color: #333;
            transform: scale(1.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .control-group {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #ddd;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }

        .control-row label {
            margin: 0;
            min-width: 80px;
            font-size: 0.85rem;
        }

        .control-row input[type="range"] {
            flex: 1;
            margin: 0;
        }

        .control-row .value-display {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: var(--primary);
        }

        #text-input-container {
            margin: 10px 0;
        }

        #text-input-container input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-size: 1rem;
        }

        /* FOOTER */
        .footer-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background: white;
            border-top: 1px solid #ddd;
            z-index: 999;
            display: flex;
            gap: 10px;
            box-sizing: border-box;
        }
    </style>
</head>

<body>

    <header>
        <h1>üìê ADEKUA. TOMA DE DATOS</h1>
    </header>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('tab-tecnico')">1. Configuraci√≥n</button>
        <button class="tab-btn" onclick="switchTab('tab-geometria')">2. Plano (Auto)</button>
        <button class="tab-btn" onclick="switchTab('tab-fotos')">3. Fotos</button>
    </div>

    <div class="container">

        <div id="tab-tecnico" class="section active">
            <div class="card">
                <h2>Datos del Proyecto</h2>
                <label>Cliente</label><input type="text" id="g-client">
                <label>Obra</label><input type="text" id="g-site">
                <label>Fecha</label><input type="date" id="g-date">
            </div>

            <div class="card">
                <h2>Sistema a Presupuestar</h2>
                <div class="sys-selector">
                    <div class="sys-btn active" id="btn-barandilla" onclick="setSystem('barandilla')">
                        <img src="img/barandilla.jpg" alt="Icon"> Barrier Light
                    </div>
                    <div class="sys-btn" id="btn-sand01" onclick="setSystem('sand01')">
                        <img src="img/sand01.jpg" alt="Icon"> Sand01
                    </div>
                    <div class="sys-btn" id="btn-sand02" onclick="setSystem('sand02')">
                        <img src="img/sand02.jpg" alt="Icon"> Sand02
                    </div>
                    <div class="sys-btn" id="btn-poste" onclick="setSystem('poste')">
                        <img src="img/poste.jpg" alt="Icon"> Postes
                    </div>
                    <div class="sys-btn" id="btn-rail" onclick="setSystem('rail')">
                        <img src="img/rail.jpg" alt="Icon"> Rail
                    </div>
                    <div class="sys-btn" id="btn-attika" onclick="setSystem('attika')">
                        <img src="img/attika.jpg" alt="Icon"> Attika
                    </div>
                    <div class="sys-btn" id="btn-lightflex" onclick="setSystem('lightflex')">
                        <img src="img/lightflex.jpg" alt="Icon"> Light Flex
                    </div>
                </div>
            </div>

            <div id="tech-barandilla">
                <div class="card">
                    <h2>Configuraci√≥n Barrier Light</h2>
                    <label>Tipo de Fijaci√≥n</label>
                    <select id="b-fix-type" onchange="toggleBarandillaOpts()">
                        <option value="contrapeso">Autoportante (Contrapeso)</option>
                        <option value="metalica">Fijaci√≥n a Metal</option>
                        <option value="hormigon">Fijaci√≥n a Hormig√≥n</option>
                    </select>
                    <label>Lado de los Postes</label>
                    <select id="b-side" onchange="drawPreview()">
                        <option value="right">Derecha (Interior)</option>
                        <option value="left">Izquierda</option>
                    </select>
                    <label style="margin-top:15px;">Normativa</label>
                    <div class="radio-group" style="margin-top:5px;">
                        <div class="radio-opt">
                            <input type="radio" name="b-norm" id="b-norm-13374" value="2.5" checked
                                onchange="drawPreview()">
                            <label for="b-norm-13374">DIN 13374:2019 (Max 2,5m)</label>
                        </div>
                        <div class="radio-opt">
                            <input type="radio" name="b-norm" id="b-norm-14122" value="1.5" onchange="drawPreview()">
                            <label for="b-norm-14122">DIN 14122-3:2016 (Max 1,5m)</label>
                        </div>
                    </div>
                    <div id="opts-b-contrapeso" class="conditional-box">
                        <label>Tipo de Superficie</label>
                        <select id="b-surface">
                            <option value="grava">Grava / Canto rodado</option>
                            <option value="asfaltica">Tela Asf√°ltica</option>
                            <option value="pvc_tpo">L√°mina PVC / TPO</option>
                            <option value="losa">Losa Hormig√≥n / Baldosa</option>
                            <option value="delicado">Suelo Delicado (Fieltro)</option>
                        </select>
                    </div>
                    <div id="opts-b-metal" class="conditional-box hidden">
                        <label>Tipo Metal</label><input type="text" id="b-metal-desc" placeholder="Ej: Viga IPN">
                        <label>¬øTorniller√≠a Pasante?</label>
                        <select id="b-metal-pasante">
                            <option value="no">No</option>
                            <option value="si">S√≠</option>
                        </select>
                    </div>
                    <div id="opts-b-hormigon" class="conditional-box hidden">
                        <label>Estado</label>
                        <select id="b-hormigon-status">
                            <option value="bueno">Bueno</option>
                            <option value="malo">Malo</option>
                        </select>
                        <label>Ancho Peto (cm)</label><input type="number" id="b-peto-width">
                    </div>
                </div>
            </div>

            <div id="tech-linea" class="hidden">
                <div class="card config-card">
                    <h2 id="sand-config-header">Definici√≥n de Componentes (BOM)</h2>
                    <label>Variante del Sistema</label>
                    <select id="lv-variant" onchange="toggleLvConfig(); drawPreview();">
                        <option value="ends10">Ends10 (Est√°ndar)</option>
                        <option value="ends50">Ends50 (Simplificado)</option>
                    </select>
                    <div id="group-ends10">
                        <label>Elemento de Extremo (EB)</label>
                        <select id="lv-eb-model" onchange="drawPreview()"></select>
                        <div class="check-group" style="margin-top:15px; border-top:1px solid #ddd; padding-top:10px;">
                            <input type="checkbox" id="chk-shock" onchange="toggleShockOpts()">
                            <label>¬øLleva Absorbedores?</label>
                        </div>
                        <div id="opts-shock" class="conditional-box hidden">
                            <label>Cantidad Absorbedores</label>
                            <input type="number" id="lv-shock-qty" value="0">
                            <label>Tipo</label><select id="lv-shock-type">
                                <option value="SHOCK-10">SHOCK-10</option>
                                <option value="SHOCK-11">SHOCK-11</option>
                            </select>
                        </div>
                    </div>
                    <div id="group-ends50" class="hidden">
                        <label>Configuraci√≥n de Extremos</label>
                        <select id="lv-ends50-config">
                            <option value="50-51">1√ó AIO-ENDS-50 + 1√ó AIO-ENDS-51</option>
                            <option value="50-50">2√ó AIO-ENDS-50</option>
                        </select>
                    </div>
                    <hr style="margin: 20px 0; border:0; border-top:1px solid #ddd;">
                    <label>Elemento Intermedio (SZH)</label>
                    <select id="lv-szh-model" onchange="drawPreview()"></select>
                </div>

                <div class="card" id="card-opts-sand">
                    <h2>Opciones de Instalaci√≥n</h2>
                    <div id="opts-fix-sand01" class="hidden">
                        <label>Tipo de Fijaci√≥n (20 uds/base)</label>
                        <select id="sand01-fix-type">
                            <option value="BEF 306-VE250">Remache BEF 306-VE250</option>
                            <option value="BBF-06.3-028-DS-A2">Roscachapa BBF-06.3-028-DS-A2</option>
                        </select>
                    </div>
                    <div class="check-group">
                        <input type="checkbox" id="chk-alzas">
                        <label>¬øLleva alzas de nivelaci√≥n (VL-SAND-SET / VL-20-50)?</label>
                    </div>
                </div>

                <div class="card">
                    <h2>Soporte L√≠nea de Vida</h2>
                    <label>Estructura</label>
                    <select id="lv-support-type" onchange="toggleLvOpts(); drawPreview();">
                        <option value="sand02">Cubierta Chapa (Sandwich/Deck)</option>
                        <option value="poste">Poste Estructural</option>
                    </select>
                    <div id="opts-lv-chapa" class="conditional-box">
                        <label>Tipo Chapa</label>
                        <select id="lv-chapa-type">
                            <option value="sandwich">Panel Sandwich</option>
                            <option value="grecada">Grecada Simple</option>
                            <option value="deck">Deck</option>
                        </select>
                        <label>Tipo de Chapa</label>
                        <select id="lv-chapa-thick" onchange="updateMaxDistSand02(); drawPreview()">
                            <option value="10">Chapa Fina (m√°x 10m entre intermedios)</option>
                            <option value="12">Chapa Gruesa (m√°x 12m entre intermedios)</option>
                        </select>
                        <label>Distancia M√°xima entre Intermedios (m)</label>
                        <input type="number" id="lv-max-dist-sand02" value="10" min="1" max="12" step="0.5"
                            onchange="drawPreview()" style="width:100%;">
                        <small style="display:block; margin-top:5px; color:#666; font-size:0.85rem;">Puedes reducir la
                            distancia si lo necesitas</small>
                    </div>
                    <div id="opts-lv-poste" class="conditional-box hidden">
                        <label>Distancia M√°xima entre Soportes (m)</label>
                        <input type="number" id="lv-max-dist-poste" value="15" min="1" max="15" step="0.5"
                            onchange="drawPreview()" style="width:100%;">
                        <small
                            style="display:block; margin-top:5px; margin-bottom:15px; color:#666; font-size:0.85rem;">Distancia
                            m√°xima entre extremos e intermedios (m√°x 15m)</small>

                        <div class="check-group"
                            style="background:#e3f2fd; padding:10px; border-radius:4px; margin-bottom:15px;">
                            <input type="checkbox" id="chk-use-posts" checked
                                onchange="toggleUsePostsOpts(); drawPreview();">
                            <label>Usar Postes en la Instalaci√≥n</label>
                        </div>
                        <div id="opts-with-posts">
                            <label>Modelo Poste (STA)</label>
                            <select id="lv-post-model" onchange="drawPreview()"></select>
                            <label>Material Base</label>
                            <select id="lv-base-mat">
                                <option value="hormigon">Hormig√≥n</option>
                                <option value="acero">Metal</option>
                                <option value="madera">Madera</option>
                            </select>
                            <div style="margin-top:10px;">
                                <div class="check-group"><input type="checkbox" id="chk-contraplaca"><label>Requiere
                                        Contraplaca</label></div>
                                <div class="check-group"><input type="checkbox" id="chk-alzas-posts"><label>Requiere
                                        Alzas de Nivelaci√≥n (VL-20-50)</label></div>
                                <div class="check-group"><input type="checkbox" id="chk-herreria"
                                        onchange="document.getElementById('desc-herreria').classList.toggle('hidden',!this.checked)"><label>Herrer√≠a
                                        Especial</label></div>
                                <textarea id="desc-herreria" class="hidden" rows="2"
                                    placeholder="Detalle..."></textarea>
                            </div>
                            <hr style="margin: 15px 0; border:0; border-top:1px solid #ddd;">
                            <button class="btn-mini" style="width:100%; background:var(--accent);"
                                onclick="toggleCustomPostsUI()">‚öôÔ∏è Personalizar Postes Individuales</button>
                            <div id="custom-posts-container" class="hidden"
                                style="margin-top:10px; padding:10px; background:#fff3cd; border-radius:4px;">
                                <p style="font-size:0.85rem; margin:0 0 10px; color:#856404;">Selecciona postes
                                    espec√≠ficos
                                    para usar un modelo diferente:</p>
                                <div id="custom-posts-list"></div>
                            </div>
                        </div>
                        <div id="opts-without-posts" class="hidden"
                            style="padding:15px; background:#fff3cd; border-radius:4px; margin-top:10px;">
                            <p style="font-size:0.9rem; margin:0; color:#856404;"><strong>‚ö†Ô∏è Instalaci√≥n Sin
                                    Postes:</strong> Se usar√°n directamente los elementos de extremo (ENDS) sin postes
                                estructurales.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tech-rail" class="hidden">
                <div class="card">
                    <h2>Configuraci√≥n Sistema Rail (TAURUS)</h2>
                    <label>Longitud Total (m)</label>
                    <input type="number" id="rail-longitud" value="20" min="1" max="500" step="0.5">

                    <div class="check-group" style="margin-top:15px;">
                        <input type="checkbox" id="rail-cerrada">
                        <label>L√≠nea Cerrada (bucle)</label>
                    </div>
                </div>

                <div class="card">
                    <h2>Tipo de Soporte</h2>
                    <label>Estructura</label>
                    <select id="rail-soporte-tipo" onchange="toggleRailSoporteOpts()">
                        <option value="bef">Fijaci√≥n Directa (BEF)</option>
                        <option value="sta">Postes Estructurales (STA)</option>
                        <option value="bef-eb">Fijaci√≥n Acero (BEF-411 + EB)</option>
                    </select>

                    <div id="opts-rail-bef">
                        <label>Modelo BEF</label>
                        <select id="rail-bef-model"></select>
                    </div>

                    <div id="opts-rail-sta" class="hidden">
                        <label>Modelo Poste (STA)</label>
                        <select id="rail-sta-model"></select>
                        <small style="display:block; margin-top:5px; color:#666; font-size:0.85rem;">Se a√±adir√°
                            autom√°ticamente
                            TAURUS-BEF-30</small>
                    </div>

                    <div id="opts-rail-bef-eb" class="hidden">
                        <label>Soporte EB</label>
                        <select id="rail-eb-model"></select>
                        <label>Fijaci√≥n BEF Adicional</label>
                        <select id="rail-bef-adicional"></select>
                        <div class="check-group" style="margin-top:10px;">
                            <input type="checkbox" id="rail-varilla-m16">
                            <label>A√±adir 0.5x Varilla M16 por punto</label>
                        </div>
                    </div>

                    <label style="margin-top:15px;">Distancia M√°xima entre Soportes (m)</label>
                    <input type="number" id="rail-dist-max" value="3" min="1" max="6" step="0.1">
                    <small style="display:block; margin-top:5px; color:#666; font-size:0.85rem;">M√°ximo recomendado:
                        6m</small>
                </div>

                <div class="card">
                    <h2>Componentes del Sistema</h2>

                    <div class="check-group">
                        <input type="checkbox" id="rail-usar-6m" checked>
                        <label>Priorizar ra√≠les de 6m</label>
                    </div>
                    <small style="display:block; margin-bottom:15px; color:#666; font-size:0.85rem;">Si no, solo se
                        usar√°n
                        ra√≠les de 3m</small>

                    <label>Tipo de Carro Deslizador</label>
                    <select id="rail-carro-tipo"></select>

                    <label>Tipo de Uni√≥n de Carril</label>
                    <select id="rail-union-tipo"></select>

                    <div class="check-group" style="margin-top:10px;">
                        <input type="checkbox" id="rail-optimizar-ve5" checked>
                        <label>Optimizar con packs VE5 (VB-10/VB-12)</label>
                    </div>
                    <small style="display:block; margin-top:5px; color:#666; font-size:0.85rem;">Divide uniones en packs
                        de
                        5 +
                        unidades sueltas</small>
                </div>
            </div>

            <div id="tech-attika" class="hidden">
                <div class="card">
                    <h2>Configuraci√≥n Attika</h2>
                    <label>Lado de los Postes</label>
                    <select id="a-side" onchange="drawPreview()">
                        <option value="right">Derecha (Interior)</option>
                        <option value="left">Izquierda</option>
                    </select>
                    <label style="margin-top:15px;">Normativa</label>
                    <div class="radio-group" style="margin-top:5px;">
                        <div class="radio-opt">
                            <input type="radio" name="a-norm" id="a-norm-13374" value="2.5" checked
                                onchange="drawPreview()">
                            <label for="a-norm-13374">DIN 13374:2019 (Max 2,5m)</label>
                        </div>
                        <div class="radio-opt">
                            <input type="radio" name="a-norm" id="a-norm-14122" value="1.5" onchange="drawPreview()">
                            <label for="a-norm-14122">DIN 14122-3:2016 (Max 1,5m)</label>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tech-lightflex" class="hidden">
                <div class="card config-card">
                    <h2>Configuraci√≥n LIGHT-FLEX</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><label>Cantidad Lucernarios</label><input type="number" id="lf-qty" value="1" min="1"
                                oninput="drawPreview()"></div>
                        <div><label>Fijaci√≥n Perimetral</label>
                            <select id="lf-bracket-type" onchange="drawPreview()">
                                <option value="LIGHT-FLEX-BEF-02-VZ">BEF-02 (>= 5mm)</option>
                                <option value="LIGHT-FLEX-BEF-01-VZ">BEF-01 (<= 5mm)</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px;">
                        <div><label>Largo Exterior (m)</label><input type="number" id="lf-len" value="3.5" step="0.1"
                                oninput="drawPreview()"></div>
                        <div><label>Ancho Exterior (m)</label><input type="number" id="lf-width" value="2.4" step="0.1"
                                oninput="drawPreview()"></div>
                    </div>

                    <h3 style="margin-top:15px;">Barras de Rigidizaci√≥n (RWA)</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
                        <div><label style="font-size:0.7rem;">RWA-1165</label><input type="number" id="lf-rwa-1165"
                                value="0" min="0" oninput="toggleLfRwaMode(); drawPreview();"></div>
                        <div><label style="font-size:0.7rem;">RWA-1525</label><input type="number" id="lf-rwa-1525"
                                value="0" min="0" oninput="toggleLfRwaMode(); drawPreview();"></div>
                        <div><label style="font-size:0.7rem;">RWA-1900</label><input type="number" id="lf-rwa-1900"
                                value="0" min="0" oninput="toggleLfRwaMode(); drawPreview();"></div>
                    </div>

                    <div id="lf-rwa-advanced" class="conditional-box hidden">
                        <label>Disposici√≥n de Barras (2 uds)</label>
                        <select id="lf-rwa-mode" onchange="toggleLfRwaDetails(); drawPreview();">
                            <option value="standard">Est√°ndar (Sustituye Per√≠metro)</option>
                            <option value="center">Centro Agrupado (Split)</option>
                        </select>
                        <div id="lf-rwa-split-opts" class="hidden" style="margin-top:10px;">
                            <label>Gap (mm)</label><input type="number" id="lf-rwa-gap" value="100"
                                oninput="drawPreview()">
                            <label>Divisi√≥n</label>
                            <select id="lf-rwa-axis" onchange="drawPreview()">
                                <option value="L">Dividir Largo (Verticales)</option>
                                <option value="W">Dividir Ancho (Horizontales)</option>
                            </select>
                        </div>
                        <div id="lf-rwa-standard-opts" style="margin-top:10px;">
                            <label>Ubicaci√≥n de Barras</label>
                            <select id="lf-rwa-loc" onchange="drawPreview()">
                                <option value="long_side">Lados Largos</option>
                                <option value="short_side">Lados Cortos</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Accesos, Seguridad, Varios</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><label>VARIOS PLUMA</label><input type="number" id="v-pluma" value="0" min="0"></div>
                    <div><label>PEMP</label><input type="number" id="v-pemp" value="0" min="0"></div>
                    <div><label>VARIOS ATXABASTAR</label><input type="number" id="v-atxabastar" value="0" min="0"></div>
                    <div><label>VARIOS ESCALERA</label><input type="number" id="v-escalera" value="0" min="0"></div>
                    <div><label>VARIOS GANCHO ESCALERA</label><input type="number" id="v-gancho-escalera" value="0"
                            min="0"></div>
                    <div><label>VARIOS HERRER√çA JOSU</label><input type="number" id="v-herreria-josu" value="0" min="0">
                    </div>
                    <div><label>VARIOS PELDA√ëO</label><input type="number" id="v-peldano" value="0" min="0"></div>
                    <div><label>VARIOS SELLADO</label><input type="number" id="v-sellado" value="0" min="0"></div>
                </div>
            </div>
        </div>



        <div id="tab-geometria" class="section">
            <div id="geo-preview-container">
                <div class="preview-label">üëÅÔ∏è Plano de Instalaci√≥n</div>
                <canvas id="geo-canvas" width="600" height="350"></canvas>
                <div class="bom-overlay" id="bom-display">Items: 0</div>
            </div>

            <div id="bom-table-container">
                <table class="bom-table">
                    <thead>
                        <tr>
                            <th style="width:150px;">C√≥digo</th>
                            <th>Cantidad</th>
                        </tr>
                    </thead>
                    <tbody id="bom-table-body"></tbody>
                </table>
            </div>

            <div id="legend-table-container" style="margin-top:20px;">
                <h3 style="margin-bottom:10px;">Leyenda del Plano</h3>
                <table class="bom-table">
                    <thead>
                        <tr>
                            <th style="width:80px;">N√∫mero</th>
                            <th>Descripci√≥n de Componentes</th>
                        </tr>
                    </thead>
                    <tbody id="legend-table-body"></tbody>
                </table>
            </div>

            <div id="geo-barandilla">
                <div class="card config-card">
                    <h3>Terminaciones</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div><label>Comienzo</label><select id="b-start-conf" onchange="drawPreview()">
                                <option value="R41">R41 (Pared)</option>
                                <option value="R91">R91 (Libre)</option>
                                <option value="R51">R51 (Libre/Unido)</option>
                            </select></div>
                        <div><label>Final</label><select id="b-end-conf" onchange="drawPreview()">
                                <option value="R41">R41 (Pared)</option>
                                <option value="R91">R91 (Libre)</option>
                                <option value="R51">R51 (Libre/Unido)</option>
                            </select></div>
                    </div>
                </div>
                <div id="b-tramos-list"></div>
                <button class="btn-full btn-add" onclick="addBarandillaTramo()">+ A√±adir Tramo Recto</button>
            </div>

            <div id="geo-linea" class="hidden">
                <div class="card" style="background: #e3f2fd; padding:10px;">
                    <div class="check-group"><input type="checkbox" id="lv-loop" onchange="drawPreview()"><label>Sistema
                            Cerrado (Anillo)</label></div>
                </div>
                <div id="lv-tramos-list"></div>
                <button class="btn-full btn-add" onclick="addLvTramo()">+ A√±adir Segmento</button>
            </div>
        </div>

        <div id="tab-fotos" class="section">
            <div class="card" style="text-align: center;">
                <input type="file" id="cam-input" accept="image/*" capture="environment" style="display:none"
                    onchange="loadPhoto(event)">
                <button class="btn-full" style="background:#555; color:white; margin-bottom:10px;"
                    onclick="document.getElementById('cam-input').click()">üì∑ Tomar Foto</button>

                <div id="canvas-container" style="position:relative;">
                    <canvas id="editor"></canvas>
                    <!-- 3D Overlay Element -->
                    <img id="overlay-3d"
                        style="display:none; position:absolute; top:0; left:0; pointer-events:none; transform-origin:center center;">
                </div>

                <!-- Controles de Escala de Foto -->
                <div class="control-group" id="photo-scale-controls" style="display:none;">
                    <div class="control-row">
                        <label>üìè Escala Foto:</label>
                        <input type="range" id="photo-scale" min="0.1" max="2" step="0.05" value="1"
                            oninput="updatePhotoScale()">
                        <span class="value-display" id="photo-scale-value">100%</span>
                    </div>
                </div>

                <div id="overlay-controls"
                    style="display:none; background:#f1f3f5; padding:10px; border-radius:4px; margin-bottom:10px; border:1px solid #ddd;">
                    <label style="margin-top:0; color:var(--purple); font-weight:bold;">üó∫Ô∏è Ajustar Plano (3D)</label>

                    <!-- Scale Control -->
                    <div style="display:flex; gap:10px; align-items:center; justify-content:center; margin:8px 0;">
                        <span style="font-size:0.8rem; min-width:70px;">üìè Tama√±o:</span>
                        <input type="range" id="overlay-scale" min="0.1" max="3" step="0.1" value="1"
                            oninput="updateOverlayScale()" style="flex:1;">
                        <span id="overlay-scale-value"
                            style="font-size:0.8rem; min-width:50px; font-weight:bold; color:var(--purple);">100%</span>
                    </div>

                    <!-- Rotation Controls -->
                    <div style="background:#fff; padding:8px; border-radius:4px; margin:8px 0;">
                        <label
                            style="font-size:0.85rem; font-weight:bold; margin:0 0 8px 0; display:block; color:#555;">üîÑ
                            Rotaci√≥n 3D</label>

                        <!-- Rotate X -->
                        <div style="display:flex; gap:10px; align-items:center; margin:5px 0;">
                            <span style="font-size:0.75rem; min-width:55px; color:#666;">‚ÜïÔ∏è Eje X:</span>
                            <input type="range" id="overlay-rotateX" min="-180" max="180" step="1" value="0"
                                oninput="updateOverlayRotation()" style="flex:1;">
                            <span id="overlay-rotateX-value"
                                style="font-size:0.75rem; min-width:45px; font-weight:bold; color:var(--purple);">0¬∞</span>
                        </div>

                        <!-- Rotate Y -->
                        <div style="display:flex; gap:10px; align-items:center; margin:5px 0;">
                            <span style="font-size:0.75rem; min-width:55px; color:#666;">‚ÜîÔ∏è Eje Y:</span>
                            <input type="range" id="overlay-rotateY" min="-180" max="180" step="1" value="0"
                                oninput="updateOverlayRotation()" style="flex:1;">
                            <span id="overlay-rotateY-value"
                                style="font-size:0.75rem; min-width:45px; font-weight:bold; color:var(--purple);">0¬∞</span>
                        </div>

                        <!-- Rotate Z -->
                        <div style="display:flex; gap:10px; align-items:center; margin:5px 0;">
                            <span style="font-size:0.75rem; min-width:55px; color:#666;">üîÉ Eje Z:</span>
                            <input type="range" id="overlay-rotateZ" min="0" max="360" step="1" value="0"
                                oninput="updateOverlayRotation()" style="flex:1;">
                            <span id="overlay-rotateZ-value"
                                style="font-size:0.75rem; min-width:45px; font-weight:bold; color:var(--purple);">0¬∞</span>
                        </div>
                    </div>

                    <button class="btn-mini" style="background:var(--success); width:100%;" onclick="fixOverlay()">‚úÖ
                        Fijar Plano</button>
                    <p style="font-size:0.7rem; color:#666; margin:5px 0 0 0;">Arrastra para mover. Usa las barras para
                        escalar y rotar en 3D.</p>
                </div>

                <!-- Selector de Herramienta -->
                <div class="control-group">
                    <label style="margin:0 0 8px 0; display:block; text-align:center; font-weight:bold;">üé®
                        Herramientas</label>
                    <div class="tool-selector">
                        <button class="tool-btn active" onclick="setDrawTool('line')">‚úèÔ∏è L√≠nea</button>
                        <button class="tool-btn" onclick="setDrawTool('circle')">‚≠ï C√≠rculo</button>
                        <button class="tool-btn" onclick="setDrawTool('square')">‚¨ú Cuadrado</button>
                        <button class="tool-btn" onclick="setDrawTool('triangle')">üî∫ Tri√°ngulo</button>
                        <button class="tool-btn" onclick="setDrawTool('x')">‚ùå X</button>
                        <button class="tool-btn" onclick="setDrawTool('text')">üìù Texto</button>
                    </div>
                </div>

                <!-- Selector de Color -->
                <div class="control-group">
                    <label style="margin:0 0 8px 0; display:block; text-align:center; font-weight:bold;">üé®
                        Colores</label>
                    <div class="color-selector">
                        <div class="color-btn active" style="background:#ff0000;" onclick="setDrawColor('#ff0000')"
                            title="Rojo"></div>
                        <div class="color-btn" style="background:#0000ff;" onclick="setDrawColor('#0000ff')"
                            title="Azul"></div>
                        <div class="color-btn" style="background:#00ff00;" onclick="setDrawColor('#00ff00')"
                            title="Verde"></div>
                        <div class="color-btn" style="background:#ffff00;" onclick="setDrawColor('#ffff00')"
                            title="Amarillo"></div>
                        <div class="color-btn" style="background:#000000;" onclick="setDrawColor('#000000')"
                            title="Negro"></div>
                        <div class="color-btn" style="background:#ffffff; border-color:#999;"
                            onclick="setDrawColor('#ffffff')" title="Blanco"></div>
                    </div>
                </div>

                <!-- Controles de Ajuste -->
                <div class="control-group">
                    <div class="control-row">
                        <label>üìè Grosor:</label>
                        <input type="range" id="line-width" min="1" max="20" step="1" value="5"
                            oninput="updateLineWidth()">
                        <span class="value-display" id="line-width-value">5px</span>
                    </div>
                    <div class="control-row">
                        <label>üìù Tam. Texto:</label>
                        <input type="range" id="text-size" min="12" max="72" step="2" value="24"
                            oninput="updateTextSize()">
                        <span class="value-display" id="text-size-value">24px</span>
                    </div>
                </div>

                <!-- Input de Texto (solo visible cuando se selecciona herramienta texto) -->
                <div id="text-input-container" style="display:none;">
                    <input type="text" id="text-input" placeholder="Escribe el texto aqu√≠..." maxlength="100">
                    <p style="font-size:0.75rem; color:#666; margin:5px 0;">Haz clic en la foto para a√±adir el texto</p>
                </div>

                <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                    <button onclick="importPlanToPhoto()" class="btn-mini btn-overlay">üó∫Ô∏è Superponer Plano</button>
                    <button onclick="clearDraw()" class="btn-mini">‚Ü∫ Limpiar</button>
                    <button onclick="savePhoto()" class="btn-mini btn-save">üíæ Guardar</button>
                </div>
            </div>
            <div class="card">
                <h3>Galer√≠a (<span id="photo-count">0</span>)</h3>
                <div class="gallery" id="gallery-grid"></div>
            </div>
        </div>

    </div>

    <div class="footer-fixed">
        <button class="btn-full btn-save" onclick="exportJSON()" style="flex:1;">üì§ JSON</button>
        <button class="btn-full" style="background:var(--success); color:white; flex:1;" onclick="exportToExcel()">üìä
            Excel</button>
        <button class="btn-full" style="background:var(--purple); color:white; flex:1;" onclick="generateReport()">üìÑ
            Informe</button>
    </div>

    <script>
        if (window.NodeList && !NodeList.prototype.forEach) {
            NodeList.prototype.forEach = Array.prototype.forEach;
        }
        // --- DATOS MAESTROS ---
        const STA_LIST = ['STA-10-400', 'STA-10-600', 'STA-10-600-A4', 'STA-10-800', 'STA-11-340', 'STA-11-470', 'STA-12-400', 'STA-12-600', 'STA-12-800', 'STA-16-200', 'STA-16-500', 'STA-17-300', 'STA-17-400', 'STA-17-600'];
        const EB_LIST = ['AIO-EB-10', 'AIO-EB-11', 'AIO-EB-12', 'AIO-EB-13', 'AIO-EB-15', 'AIO-EB-16', 'AIO-EB-17'];
        const SZH_LIST = ['AIO-SZH-10', 'AIO-SZH-11', 'AIO-SZH-12', 'AIO-SZH-13', 'AIO-SZH-15', 'AIO-SZH-16', 'AIO-SZH-17'];
        const EDLE_LIST = ['AIO-EDLE-10', 'AIO-EDLE-11', 'AIO-EDLE-12', 'AIO-EDLE-13', 'AIO-EDLE-15', 'AIO-EDLE-16', 'AIO-EDLE-17', 'AIO-EDLE-19', 'AIO-EDLE-50', 'AIO-EDLE-51'];
        const EXTRA_ELEMENTS = ['AIO-EDLE-19', 'AIO-SZH-10', 'POSTE-REFUERZO', 'OTRO'];
        const RAIL_BEF_LIST = ['TAURUS-BEF-10', 'TAURUS-BEF-10-VE5', 'TAURUS-BEF-12', 'TAURUS-BEF-13-VE5', 'TAURUS-BEF-20', 'TAURUS-BEF-21', 'TAURUS-BEF-30', 'TAURUS-BEF-41', 'TAURUS-BEF-411'];
        const RAIL_CARRO_LIST = ['TAURUS-GLEIT-H-11', 'TAURUS-GLEIT-A-31', 'TAURUS-GLEIT-10', 'TAURUS-GLEIT-11', 'TAURUS-GLEIT-12', 'TAURUS-GLEIT-13'];
        const RAIL_UNION_LIST = ['TAURUS-VB-10', 'TAURUS-VB-11', 'TAURUS-VB-12'];
        const RAIL_CURVE_LIST = ['TAURUS-RAIL-20-15', 'TAURUS-RAIL-20-30', 'TAURUS-RAIL-20-45', 'TAURUS-RAIL-20-60', 'TAURUS-RAIL-20-75', 'TAURUS-RAIL-20-90'];

        // --- LIGHT-FLEX CONSTANTS ---
        const LF_FIXED_CORNER_SHORT_SIDE_MM = 85;
        const LF_FIXED_CORNER_RWA_MM = 280;
        const LF_MIN_MAX_SPACING_CORNER_LONG_MM = [280, 320];
        const LF_MIN_MAX_SPACING_MID_MM = [370, 530];

        const LF_SKU = {
            'LIGHT-FLEX-BEF-01-VZ': '10009387',
            'LIGHT-FLEX-BEF-02-VZ': '10010680',
            'LIGHT-FLEX-KARI-VZ': '10009386',
            'BBF-06.3-025-0-VZ': '10010819',
            'LIGHT-FLEX-NET-01': '10009540',
            'LIGHT-FLEX-RWA-01-1165': '10010705',
            'LIGHT-FLEX-RWA-01-1525': '10010706',
            'LIGHT-FLEX-RWA-01-1900': '10010704',
            'LIGHT-FLEX-TYP-DE-EN': '10009531',
        };
        const LF_DESC = {
            'LIGHT-FLEX-BEF-01-VZ': 'FIJACI√ìN PLANA (<= 5 mm)',
            'LIGHT-FLEX-BEF-02-VZ': 'FIJACI√ìN 90¬∫ (>= 5 mm)',
            'LIGHT-FLEX-KARI-VZ': 'MOSQUET√ìN DE BLOQUEO',
            'BBF-06.3-025-0-VZ': 'BORE FASTENER √ò 6,3 x 25',
            'LIGHT-FLEX-NET-01': 'RED A MEDIDA',
            'LIGHT-FLEX-RWA-01-1165': 'BARRA RIGIDIZACI√ìN - 1165 mm',
            'LIGHT-FLEX-RWA-01-1525': 'BARRA RIGIDIZACI√ìN - 1525 mm',
            'LIGHT-FLEX-RWA-01-1900': 'BARRA RIGIDIZACI√ìN - 1900 mm',
            'LIGHT-FLEX-TYP-DE-EN': 'PLACA IDENTIFICACI√ìN',
        };

        // --- ATTIKA CONSTANTS ---
        const ATTIKA_FIRST_WALL = 0.50;
        const ATTIKA_FIRST_R51 = 0.50;
        const ATTIKA_FIRST_DEFAULT = 0.35;
        const ATTIKA_AFTER_CORNER = 0.40;
        const ATTIKA_BEFORE_CORNER = 1.30;

        // --- GLOBALES ---
        let currentSystem = 'barandilla'; // 'barandilla', 'sand02', or 'poste'
        let globalCalculatedPosts = [];
        let customPostSelections = {}; // Stores custom post models: { segmentIndex_postIndex: 'STA-XX-XXX' }
        // Variables FOTOS
        let imgObj = new Image();
        let savedPhotos = [];
        let isDrawing = false;
        let overlay = { img: null, x: 0, y: 0, scale: 1.0, rotateX: 0, rotateY: 0, rotateZ: 0, active: false, isDragging: false };

        // Variables de Dibujo
        let drawTool = 'line'; // 'line', 'circle', 'square', 'triangle', 'x', 'text'
        let drawColor = '#ff0000'; // Rojo por defecto
        let lineWidth = 5;
        let textSize = 24;
        let photoScale = 1.0;

        // Draggable Labels State
        let labelOffsets = {}; // { id: { dx, dy } }
        let draggableItems = []; // Array of { id, x1, y1, x2, y2 } for hit detection
        let draggingLabel = null; // Current item being dragged: { id, startX, startY, origDx, origDy }

        var dateInput = document.getElementById('g-date');
        if (dateInput) {
            var today = new Date().toISOString().split('T')[0]; // "2026-01-05"
            dateInput.value = today;
        }


        // --- INIT ---
        function populateSelect(id, list) { const sel = document.getElementById(id); list.forEach(m => { let opt = document.createElement('option'); opt.value = m; opt.text = m; sel.appendChild(opt); }); }
        populateSelect('lv-post-model', STA_LIST); populateSelect('lv-eb-model', EB_LIST); populateSelect('lv-szh-model', SZH_LIST);
        populateSelect('rail-sta-model', STA_LIST); populateSelect('rail-eb-model', EB_LIST);
        populateSelect('rail-bef-model', RAIL_BEF_LIST);
        populateSelect('rail-bef-adicional', RAIL_BEF_LIST);
        populateSelect('rail-carro-tipo', RAIL_CARRO_LIST);
        populateSelect('rail-union-tipo', RAIL_UNION_LIST);
        function getCurveOptionsHTML() {
            const list = (currentSystem === 'rail') ? RAIL_CURVE_LIST : EDLE_LIST;
            return list.map(e => `<option value="${e}">${e}</option>`).join('');
        }
        function getExtraElemOptions() { return EXTRA_ELEMENTS.map(e => `<option value="${e}">${e}</option>`).join(''); }

        // --- UI ---
        function switchTab(tabId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            const map = { 'tab-tecnico': 0, 'tab-geometria': 1, 'tab-fotos': 2 };
            document.querySelectorAll('.tab-btn')[map[tabId]].classList.add('active');
            if (tabId === 'tab-geometria') setTimeout(() => { setupGeoCanvasInteractions(); drawPreview(); }, 100);
        }

        function setupGeoCanvasInteractions() {
            const cvs = document.getElementById('geo-canvas');
            if (cvs.dataset.interacted) return;
            cvs.dataset.interacted = "true";

            const handleStart = (ex, ey) => {
                const rect = cvs.getBoundingClientRect();
                const x = ex - rect.left;
                const y = ey - rect.top;
                // Hit detection (reverse order for top-most)
                for (let i = draggableItems.length - 1; i >= 0; i--) {
                    const item = draggableItems[i];
                    if (x >= item.x1 && x <= item.x2 && y >= item.y1 && y <= item.y2) {
                        const off = labelOffsets[item.id] || { dx: 0, dy: 0 };
                        draggingLabel = { id: item.id, startX: x, startY: y, origDx: off.dx, origDy: off.dy };
                        cvs.style.cursor = 'grabbing';
                        return;
                    }
                }
            };

            const handleMove = (ex, ey) => {
                if (!draggingLabel) {
                    const rect = cvs.getBoundingClientRect();
                    const x = ex - rect.left;
                    const y = ey - rect.top;
                    const hit = draggableItems.some(item => x >= item.x1 && x <= item.x2 && y >= item.y1 && y <= item.y2);
                    cvs.style.cursor = hit ? 'grab' : 'default';
                    return;
                }
                const rect = cvs.getBoundingClientRect();
                const x = ex - rect.left;
                const y = ey - rect.top;
                const dx = x - draggingLabel.startX;
                const dy = y - draggingLabel.startY;
                labelOffsets[draggingLabel.id] = { dx: draggingLabel.origDx + dx, dy: draggingLabel.origDy + dy };
                drawPreview();
            };

            const handleEnd = () => {
                draggingLabel = null;
                cvs.style.cursor = 'default';
            };

            cvs.onmousedown = e => handleStart(e.clientX, e.clientY);
            window.onmousemove = e => { if (draggingLabel) handleMove(e.clientX, e.clientY); else if (e.target === cvs) handleMove(e.clientX, e.clientY); };
            window.onmouseup = handleEnd;

            cvs.ontouchstart = e => { if (e.touches.length === 1) { handleStart(e.touches[0].clientX, e.touches[0].clientY); if (draggingLabel) e.preventDefault(); } };
            cvs.ontouchmove = e => { if (draggingLabel && e.touches.length === 1) { handleMove(e.touches[0].clientX, e.touches[0].clientY); e.preventDefault(); } };
            cvs.ontouchend = handleEnd;
        }

        function drawTextWithOffset(ctx, id, text, x, y, style = {}) {
            const offset = labelOffsets[id] || { dx: 0, dy: 0 };
            const finalX = x + offset.dx;
            const finalY = y + offset.dy;

            ctx.save();
            if (style.font) ctx.font = style.font;
            if (style.color) ctx.fillStyle = style.color;
            if (style.align) ctx.textAlign = style.align;
            if (style.baseline) ctx.textBaseline = style.baseline;

            ctx.fillText(text, finalX, finalY);

            // Bounds for hit detection
            const metrics = ctx.measureText(text);
            const w = metrics.width;
            const h = parseInt(ctx.font) || 12;
            let x1 = finalX;
            if (ctx.textAlign === 'center') x1 = finalX - w / 2;
            else if (ctx.textAlign === 'right') x1 = finalX - w;

            let y1 = finalY;
            if (ctx.textBaseline === 'middle') y1 = finalY - h / 2;
            else if (ctx.textBaseline === 'bottom') y1 = finalY - h;
            else if (ctx.textBaseline === 'top') y1 = finalY;
            else y1 = finalY - h; // alphabetic defaultish

            // Add margin
            const padding = 6;
            draggableItems.push({ id, x1: x1 - padding, y1: y1 - padding, x2: x1 + w + padding, y2: y1 + h + padding });
            ctx.restore();
        }

        function setSystem(sys) {
            currentSystem = sys;
            document.getElementById('btn-barandilla').classList.toggle('active', sys === 'barandilla');
            document.getElementById('btn-sand01').classList.toggle('active', sys === 'sand01');
            document.getElementById('btn-sand02').classList.toggle('active', sys === 'sand02');
            document.getElementById('btn-poste').classList.toggle('active', sys === 'poste');
            document.getElementById('btn-rail').classList.toggle('active', sys === 'rail');
            document.getElementById('btn-attika').classList.toggle('active', sys === 'attika');
            document.getElementById('btn-lightflex').classList.toggle('active', sys === 'lightflex');

            document.getElementById('tech-barandilla').classList.toggle('hidden', sys !== 'barandilla');
            document.getElementById('tech-linea').classList.toggle('hidden', sys !== 'sand01' && sys !== 'sand02' && sys !== 'poste');
            document.getElementById('tech-rail').classList.toggle('hidden', sys !== 'rail');
            document.getElementById('tech-attika').classList.toggle('hidden', sys !== 'attika');
            document.getElementById('tech-lightflex').classList.toggle('hidden', sys !== 'lightflex');

            // Refresh curve selects for the current system
            document.querySelectorAll('.lv-curve-type').forEach(sel => {
                const currentVal = sel.value;
                sel.innerHTML = getCurveOptionsHTML();
                if ([...sel.options].some(o => o.value === currentVal)) sel.value = currentVal;
            });

            // Show relevant options for Sand01/Sand02
            const fixSand01 = document.getElementById('opts-fix-sand01');
            if (fixSand01) {
                fixSand01.classList.toggle('hidden', sys !== 'sand01');
            }

            // For sand02 and poste, set the support type accordingly
            if (sys === 'sand02') {
                document.getElementById('lv-support-type').value = 'sand02';
                toggleLvOpts();
            } else if (sys === 'poste') {
                document.getElementById('lv-support-type').value = 'poste';
                toggleLvOpts();
            }

            document.getElementById('geo-barandilla').classList.toggle('hidden', sys !== 'barandilla' && sys !== 'attika');
            document.getElementById('geo-linea').classList.toggle('hidden', sys !== 'sand01' && sys !== 'sand02' && sys !== 'poste' && sys !== 'rail');

            if (sys === 'sand01') {
                // Sand01 defaults
                document.getElementById('lv-support-type').value = 'sand02'; // Shares chapa options UI mostly
                const hdr = document.getElementById('sand-config-header');
                if (hdr) hdr.innerText = "Configuraci√≥n Sand01";

                // Update chapa thickness options for Sand01 (max 7.5m)
                const thickSelect = document.getElementById('lv-chapa-thick');
                thickSelect.innerHTML = '<option value="7.5">Panel Sandwich (m√°x 7.5m entre intermedios)</option>';

                toggleLvOpts();
                updateMaxDistSand02();
            } else if (sys === 'sand02' || sys === 'poste') {
                const hdr = document.getElementById('sand-config-header');
                if (hdr) hdr.innerText = sys === 'sand02' ? "Configuraci√≥n Sand02" : "Definici√≥n de Componentes (BOM)";

                // Restore Sand02/Poste options if returning from Sand01
                const thickSelect = document.getElementById('lv-chapa-thick');
                if (thickSelect.options.length === 1) {
                    thickSelect.innerHTML = `
                        <option value="10">Chapa Fina (m√°x 10m entre intermedios)</option>
                        <option value="12">Chapa Gruesa (m√°x 12m entre intermedios)</option>
                    `;
                }
            }
            drawPreview();
        }

        function toggleBarandillaOpts() {
            const type = document.getElementById('b-fix-type').value;
            document.getElementById('opts-b-contrapeso').classList.toggle('hidden', type !== 'contrapeso');
            document.getElementById('opts-b-metal').classList.toggle('hidden', type !== 'metalica');
            document.getElementById('opts-b-hormigon').classList.toggle('hidden', type !== 'hormigon');
        }
        function toggleLvOpts() {
            const type = document.getElementById('lv-support-type').value;
            document.getElementById('opts-lv-chapa').classList.toggle('hidden', type !== 'sand02');
            document.getElementById('opts-lv-poste').classList.toggle('hidden', type !== 'poste');
        }

        function toggleUsePostsOpts() {
            const usePosts = document.getElementById('chk-use-posts').checked;
            document.getElementById('opts-with-posts').classList.toggle('hidden', !usePosts);
            document.getElementById('opts-without-posts').classList.toggle('hidden', usePosts);
        }

        function updateMaxDistSand02() {
            const chapaValue = document.getElementById('lv-chapa-thick').value;
            const maxDistInput = document.getElementById('lv-max-dist-sand02');
            maxDistInput.value = chapaValue;
            maxDistInput.max = chapaValue;
        }


        function toggleRailSoporteOpts() {
            const tipo = document.getElementById('rail-soporte-tipo').value;
            document.getElementById('opts-rail-bef').classList.toggle('hidden', tipo !== 'bef');
            document.getElementById('opts-rail-sta').classList.toggle('hidden', tipo !== 'sta');
            document.getElementById('opts-rail-bef-eb').classList.toggle('hidden', tipo !== 'bef-eb');
        }

        function toggleLvConfig() {
            const variant = document.getElementById('lv-variant').value;
            document.getElementById('group-ends10').classList.toggle('hidden', variant === 'ends50');
            document.getElementById('group-ends50').classList.toggle('hidden', variant !== 'ends50');
        }
        function toggleShockOpts() {
            document.getElementById('opts-shock').classList.toggle('hidden', !document.getElementById('chk-shock').checked);
        }

        function toggleCustomPostsUI() {
            const container = document.getElementById('custom-posts-container');
            const list = document.getElementById('custom-posts-list');

            if (container.classList.contains('hidden')) {
                // Show and populate
                container.classList.remove('hidden');
                updateCustomPostsList();
            } else {
                container.classList.add('hidden');
            }
        }

        function updateCustomPostsList() {
            const list = document.getElementById('custom-posts-list');
            list.innerHTML = '';

            if (!globalCalculatedPosts || globalCalculatedPosts.segments.length === 0) {
                list.innerHTML = '<p style="font-size:0.85rem; color:#999; font-style:italic;">A√±ade segmentos primero para personalizar postes.</p>';
                return;
            }

            const defaultModel = document.getElementById('lv-post-model').value;

            globalCalculatedPosts.segments.forEach((segment, segIdx) => {
                if (segment.length === 0) return;

                const segmentDiv = document.createElement('div');
                segmentDiv.style.cssText = 'margin-bottom:10px; padding:8px; background:white; border-radius:4px; border:1px solid #ddd;';
                segmentDiv.innerHTML = `<strong style="font-size:0.85rem;">Segmento ${segIdx + 1}:</strong>`;

                segment.forEach((post, postIdx) => {
                    const key = `${segIdx}_${postIdx}`;
                    const currentModel = customPostSelections[key] || defaultModel;

                    const postRow = document.createElement('div');
                    postRow.style.cssText = 'display:flex; gap:5px; align-items:center; margin-top:5px; font-size:0.85rem;';
                    postRow.innerHTML = `
                        <input type="checkbox" id="chk-custom-${key}" ${customPostSelections[key] ? 'checked' : ''} 
                            onchange="toggleCustomPostSelect('${key}')">
                        <label style="flex:1; margin:0;">${post.type === 'auto' ? 'Intermedio' : 'Manual'} #${postIdx + 1}</label>
                        <select id="sel-custom-${key}" class="custom-post-select" style="width:140px; padding:4px; font-size:0.85rem;" 
                            ${!customPostSelections[key] ? 'disabled' : ''} 
                            onchange="setCustomPost('${key}', this.value)">
                            ${STA_LIST.map(sta => `<option value="${sta}" ${currentModel === sta ? 'selected' : ''}>${sta}</option>`).join('')}
                        </select>
                    `;

                    segmentDiv.appendChild(postRow);
                });

                list.appendChild(segmentDiv);
            });
        }

        function toggleCustomPostSelect(key) {
            const checkbox = document.getElementById(`chk-custom-${key}`);
            const select = document.getElementById(`sel-custom-${key}`);

            if (checkbox.checked) {
                select.disabled = false;
                customPostSelections[key] = select.value;
            } else {
                select.disabled = true;
                delete customPostSelections[key];
            }

            drawPreview();
        }

        function setCustomPost(key, model) {
            customPostSelections[key] = model;
            drawPreview();
        }

        // --- GEOMETRY ---
        function addBarandillaTramo() {
            const container = document.getElementById('b-tramos-list');
            const idx = container.children.length + 1;
            let angleLabel = idx === 1 ? "Direcci√≥n Inicial (¬∫)" : "Giro respecto anterior (¬∫)";
            let defaultVal = idx === 1 ? "0" : "90";
            const html = `
            <div class="tramo-card b-tramo">
                <button class="remove-btn" onclick="this.parentElement.remove(); drawPreview()">√ó</button>
                <h3>Tramo ${idx}</h3>
                <div style="background:#eee; padding:8px; margin-bottom:5px; border-radius:4px;"><label>${angleLabel}</label><input type="number" class="b-angle" value="${defaultVal}" oninput="drawPreview()"></div>
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
                    <div><label>Longitud (m)</label><input type="number" class="b-len" step="0.01" oninput="drawPreview()"></div>
                    <div><label>Rodapi√©</label><input type="checkbox" class="b-rodapie" style="margin-top:40px;"></div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
            drawPreview();
        }

        function addLvTramo() {
            const container = document.getElementById('lv-tramos-list');
            const idx = container.children.length + 1;
            let startHtml = idx === 1 ? `<div style="background:#e8f5e9; padding:8px; margin-bottom:10px;"><label>Orientaci√≥n Inicial (¬∫)</label><input type="number" class="lv-start-angle" value="0" oninput="drawPreview()"></div>` : '';
            const html = `
            <div class="tramo-card lv-tramo" oninput="drawPreview()">
                <button class="remove-btn" onclick="this.parentElement.remove(); drawPreview()">√ó</button>
                <h3>Segmento ${idx}</h3>
                ${startHtml}
                <label>Longitud Recta (m)</label><input type="number" class="lv-len" step="0.01" value="0">
                <div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:5px;">
                    <div class="manual-points-list"></div>
                    <button class="btn-mini" onclick="addManualPoint(this)">+ P. Intermedio Manual</button>
                </div>
                <div style="margin-top:10px; padding:10px; background:#e3f2fd;">
                    <label>Al final:</label>
                    <select class="lv-end" onchange="this.nextElementSibling.classList.toggle('hidden', this.value !== 'curva'); drawPreview()">
                        <option value="nada">Sigue recto / Fin</option>
                        <option value="curva">Hay Curva</option>
                    </select>
                    <div class="hidden"><label>Giro (¬∫)</label><input type="number" class="lv-angle" value="90" oninput="drawPreview()"><label>Modelo</label><select class="lv-curve-type" onchange="drawPreview()">${getCurveOptionsHTML()}</select></div>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
            drawPreview();
        }

        function addManualPoint(btn) {
            btn.previousElementSibling.insertAdjacentHTML('beforeend', `<div class="manual-point-row"><input type="number" class="mp-dist" placeholder="Dist" style="width:70px;" oninput="drawPreview()"><select class="mp-type" onchange="drawPreview()">${getExtraElemOptions()}</select><button onclick="this.parentElement.remove(); drawPreview()" style="color:red; border:none;">√ó</button></div>`);
        }

        // --- CALC ---
        function solveBarandillaPosts(tramos, startType, endType) {
            if (tramos.length === 0) return { posts: [], count: 0 };
            const maxDist = parseFloat(document.querySelector('input[name="b-norm"]:checked').value) || 2.5;

            const getOffset = (type) => { if (type === 'R91') return 0.35; if (type === 'R51') return 0.50; if (type === 'R41') return 2.50; return 0.35; };
            const startOff = getOffset(startType);
            const endOff = getOffset(endType);
            if (tramos.length === 1) return calcSegmentPosts(tramos[0].len, startOff, endOff, maxDist);
            const numCorners = tramos.length - 1;
            const combinations = 1 << numCorners;
            let bestConfig = null; let minTotalPosts = Infinity;
            for (let i = 0; i < combinations; i++) {
                let currentTotal = 0; let currentLayout = [];
                for (let t = 0; t < tramos.length; t++) {
                    let s_off = (t === 0) ? startOff : (((i >> (t - 1)) & 1) === 0 ? 1.5 : 0.4);
                    let e_off = (t === tramos.length - 1) ? endOff : (((i >> t) & 1) === 0 ? 0.4 : 1.5);
                    const res = calcSegmentPosts(tramos[t].len, s_off, e_off, maxDist);
                    currentTotal += res.count;
                    currentLayout.push(res.positions);
                }
                if (currentTotal < minTotalPosts) { minTotalPosts = currentTotal; bestConfig = currentLayout; }
            }
            return { posts: bestConfig, count: minTotalPosts };
        }

        function calcSegmentPosts(length, startM, endM, maxDist) {
            const positions = []; positions.push(startM);
            const coverDist = length - startM - endM;
            if (coverDist > 0) {
                const spaces = Math.ceil(coverDist / maxDist);
                const step = coverDist / spaces;
                for (let k = 1; k < spaces; k++) positions.push(startM + (step * k));
            }
            const lastPos = length - endM;
            if (Math.abs(lastPos - startM) > 0.01) positions.push(lastPos);
            return { positions: positions, count: positions.length };
        }

        // --- ATTIKA CALC ---
        function solveAttikaPosts(tramos, startType, endType) {
            if (tramos.length === 0) return { posts: [], count: 0 };
            const maxDist = parseFloat(document.querySelector('input[name="a-norm"]:checked').value) || 2.5;

            const getEndOffset = (type, isStart, len) => {
                if (type === 'R41') return ATTIKA_FIRST_WALL;
                if (type === 'R51') return ATTIKA_FIRST_R51;
                return ATTIKA_FIRST_DEFAULT;
            };

            const n = tramos.length;
            const combinations = 1 << (n - 1);
            let bestConfig = null;
            let minTotalPosts = Infinity;

            for (let i = 0; i < combinations; i++) {
                let currentLayout = [];
                let currentTotal = 0;

                for (let t = 0; t < n; t++) {
                    const L = tramos[t].len;
                    let s_start = 0;
                    if (t === 0) {
                        s_start = getEndOffset(startType);
                    } else {
                        // Corner choice: 0: closed (AFTER_CORNER), 1: open (BEFORE_CORNER)
                        s_start = ((i >> (t - 1)) & 1) === 0 ? ATTIKA_AFTER_CORNER : ATTIKA_BEFORE_CORNER;
                    }

                    let s_end_rel = 0;
                    if (t === n - 1) {
                        s_end_rel = getEndOffset(endType);
                    } else {
                        // Corner choice: 0: closed (BEFORE_CORNER), 1: open (AFTER_CORNER)
                        s_end_rel = ((i >> t) & 1) === 0 ? ATTIKA_BEFORE_CORNER : ATTIKA_AFTER_CORNER;
                    }
                    const s_end = L - s_end_rel;

                    let positions = [];
                    if (Math.abs(s_start - s_end) < 1e-6) {
                        positions.push(s_start);
                    } else {
                        positions.push(s_start);
                        const dist = s_end - s_start;
                        if (dist > maxDist + 1e-6) {
                            const numSpans = Math.ceil(dist / maxDist);
                            const spanLen = dist / numSpans;
                            for (let k = 1; k < numSpans; k++) {
                                positions.push(s_start + k * spanLen);
                            }
                        }
                        positions.push(s_end);
                    }
                    currentLayout.push(positions);
                    currentTotal += positions.length;
                }

                if (currentTotal < minTotalPosts) {
                    minTotalPosts = currentTotal;
                    bestConfig = currentLayout;
                }
            }
            return { posts: bestConfig, count: minTotalPosts };
        }

        // --- LIGHT-FLEX CALC ---
        function calculateLfOptimizedPositions(dimension_mm, rule_type) {
            if (rule_type === 'short_side' || rule_type === 'forced_85') {
                const inner_length = dimension_mm - (2 * LF_FIXED_CORNER_SHORT_SIDE_MM);
                if (inner_length < LF_MIN_MAX_SPACING_MID_MM[0]) {
                    if (dimension_mm >= 2 * LF_FIXED_CORNER_SHORT_SIDE_MM) {
                        return [LF_FIXED_CORNER_SHORT_SIDE_MM, dimension_mm - LF_FIXED_CORNER_SHORT_SIDE_MM];
                    } else {
                        return [dimension_mm / 2];
                    }
                }
                let n_min = Math.ceil(inner_length / LF_MIN_MAX_SPACING_MID_MM[1]);
                let n_max = Math.floor(inner_length / LF_MIN_MAX_SPACING_MID_MM[0]);
                let num_mid_spans = n_min;
                const chosen_d_mid = inner_length / num_mid_spans;
                const positions = [LF_FIXED_CORNER_SHORT_SIDE_MM];
                for (let i = 0; i < num_mid_spans - 1; i++) {
                    positions.push(positions[positions.length - 1] + chosen_d_mid);
                }
                positions.push(dimension_mm - LF_FIXED_CORNER_SHORT_SIDE_MM);
                return positions;
            } else if (rule_type === 'long_side') {
                for (let num_mid_spans = 1; num_mid_spans < 30; num_mid_spans++) {
                    let req_d_corner_min = (dimension_mm - num_mid_spans * LF_MIN_MAX_SPACING_MID_MM[1]) / 2;
                    let req_d_corner_max = (dimension_mm - num_mid_spans * LF_MIN_MAX_SPACING_MID_MM[0]) / 2;
                    let overlap_start = Math.max(req_d_corner_min, LF_MIN_MAX_SPACING_CORNER_LONG_MM[0]);
                    let overlap_end = Math.min(req_d_corner_max, LF_MIN_MAX_SPACING_CORNER_LONG_MM[1]);

                    if (overlap_start <= overlap_end) {
                        let chosen_d_corner = overlap_start;
                        let chosen_d_mid = (dimension_mm - 2 * chosen_d_corner) / num_mid_spans;
                        const positions = [chosen_d_corner];
                        for (let i = 0; i < num_mid_spans - 1; i++) {
                            positions.push(positions[positions.length - 1] + chosen_d_mid);
                        }
                        positions.push(dimension_mm - chosen_d_corner);
                        return positions;
                    }
                }
            }
            return [];
        }

        function calculateLfRwaBracketPositions(length_mm) {
            if (length_mm < 2 * LF_FIXED_CORNER_RWA_MM) return [length_mm / 2];
            const inner_length = length_mm - (2 * LF_FIXED_CORNER_RWA_MM);
            let num_spans = Math.ceil(inner_length / LF_MIN_MAX_SPACING_MID_MM[1]);
            if (num_spans < 1) num_spans = 1;
            const dist_mid = inner_length / num_spans;
            const positions = [LF_FIXED_CORNER_RWA_MM];
            for (let i = 0; i < num_spans - 1; i++) {
                positions.push(positions[positions.length - 1] + dist_mid);
            }
            positions.push(length_mm - LF_FIXED_CORNER_RWA_MM);
            return positions;
        }

        function calculateLfSplitPositions(total_len_mm, gap_mm) {
            const segment_len_mm = (total_len_mm - gap_mm) / 2;
            const pos_sub_1 = calculateLfOptimizedPositions(segment_len_mm, 'forced_85');
            const pos_sub_2_rel = calculateLfOptimizedPositions(segment_len_mm, 'forced_85');
            const offset = segment_len_mm + gap_mm;
            const pos_sub_2_abs = pos_sub_2_rel.map(p => p + offset);
            return pos_sub_1.concat(pos_sub_2_abs);
        }

        function solveLightFlexComponents(length_m, width_m, bracket_type, rwa_bars, rwa_config) {
            let short_dim_mm, long_dim_mm, short_axis, long_axis;
            if (width_m < length_m) {
                short_dim_mm = width_m * 1000; long_dim_mm = length_m * 1000;
                short_axis = 'W'; long_axis = 'L';
            } else {
                short_dim_mm = length_m * 1000; long_dim_mm = width_m * 1000;
                short_axis = 'L'; long_axis = 'W';
            }

            const num_total_rwa = Object.values(rwa_bars).reduce((a, b) => a + b, 0);
            const is_split_mode = (num_total_rwa === 2 && rwa_config.mode === 'center' && rwa_config.gap_mm > 0);
            const is_perimeter_replacement_mode = (num_total_rwa === 2 && rwa_config.mode === 'standard');

            let rule_L = (long_axis === 'L') ? 'long_side' : 'short_side';
            let rule_W = (long_axis === 'W') ? 'long_side' : 'short_side';
            let type_L = bracket_type;
            let type_W = bracket_type;

            if (is_split_mode) {
                if (rwa_config.axis === 'L') rule_W = 'forced_85';
                else rule_L = 'forced_85';
            } else if (is_perimeter_replacement_mode) {
                const target_axis = (rwa_config.location === 'long_side') ? long_axis : short_axis;
                if (target_axis === 'L') {
                    rule_L = 'rwa_bar'; type_L = 'LIGHT-FLEX-BEF-01-VZ'; rule_W = 'forced_85';
                } else {
                    rule_W = 'rwa_bar'; type_W = 'LIGHT-FLEX-BEF-01-VZ'; rule_L = 'forced_85';
                }
            }

            const getPos = (dim_mm, rule, gap = 0) => {
                if (rule === 'rwa_bar') return calculateLfRwaBracketPositions(dim_mm);
                if (gap > 0) return calculateLfSplitPositions(dim_mm, gap);
                return calculateLfOptimizedPositions(dim_mm, rule);
            };

            const gap_L = (is_split_mode && rwa_config.axis === 'L') ? rwa_config.gap_mm : 0;
            const pos_L_mm = getPos(length_m * 1000, rule_L, gap_L);
            const gap_W = (is_split_mode && rwa_config.axis === 'W') ? rwa_config.gap_mm : 0;
            const pos_W_mm = getPos(width_m * 1000, rule_W, gap_W);

            const coord_data = [];
            pos_L_mm.forEach(p => coord_data.push({ side: 'Inferior', x: p / 1000, y: 0, type: type_L }));
            pos_L_mm.forEach(p => coord_data.push({ side: 'Superior', x: p / 1000, y: width_m, type: type_L }));
            pos_W_mm.forEach(p => coord_data.push({ side: 'Izquierdo', x: 0, y: p / 1000, type: type_W }));
            pos_W_mm.forEach(p => coord_data.push({ side: 'Derecho', x: length_m, y: p / 1000, type: type_W }));

            if (num_total_rwa > 0 && !is_perimeter_replacement_mode) {
                const bar_lines = [];
                if (is_split_mode) {
                    const gap_m = rwa_config.gap_mm / 1000;
                    if (rwa_config.axis === 'L') {
                        bar_lines.push({ axis: 'vertical', x: length_m / 2 - gap_m / 2, len: width_m * 1000 });
                        bar_lines.push({ axis: 'vertical', x: length_m / 2 + gap_m / 2, len: width_m * 1000 });
                    } else {
                        bar_lines.push({ axis: 'horizontal', y: width_m / 2 - gap_m / 2, len: length_m * 1000 });
                        bar_lines.push({ axis: 'horizontal', y: width_m / 2 + gap_m / 2, len: length_m * 1000 });
                    }
                } else {
                    for (let i = 1; i <= num_total_rwa; i++) {
                        bar_lines.push({ axis: 'horizontal', y: (width_m * i) / (num_total_rwa + 1), len: length_m * 1000 });
                    }
                }
                bar_lines.forEach(bar => {
                    const rwa_pos = calculateLfRwaBracketPositions(bar.len);
                    rwa_pos.forEach(p_mm => {
                        if (bar.axis === 'horizontal') coord_data.push({ side: 'RWA (Int)', x: p_mm / 1000, y: bar.y, type: 'LIGHT-FLEX-BEF-01-VZ' });
                        else coord_data.push({ side: 'RWA (Int)', x: bar.x, y: p_mm / 1000, type: 'LIGHT-FLEX-BEF-01-VZ' });
                    });
                });
            }

            const comp = {};
            coord_data.forEach(c => { comp[c.type] = (comp[c.type] || 0) + 1; });
            const total_brackets = (comp[bracket_type] || 0) + (comp['LIGHT-FLEX-BEF-01-VZ'] || 0);
            comp['LIGHT-FLEX-KARI-VZ'] = total_brackets;
            comp['BBF-06.3-025-0-VZ'] = total_brackets * 2;
            comp['LIGHT-FLEX-TYP-DE-EN'] = 1;
            Object.entries(rwa_bars).forEach(([sku, qty]) => { if (qty > 0) comp[sku] = qty; });

            let net_area = length_m * width_m;
            let info = "";
            if (is_split_mode) {
                const gap_m = rwa_config.gap_mm / 1000;
                net_area -= gap_m * (rwa_config.axis === 'L' ? width_m : length_m);
                info = `Modo Split (Gap ${rwa_config.gap_mm}mm).`;
            } else if (is_perimeter_replacement_mode) {
                info = `2 Barras RWA sustituyen a los ${rwa_config.location === 'long_side' ? 'Lados Largos' : 'Lados Cortos'}.`;
            }
            comp['LIGHT-FLEX-NET-01'] = Math.max(0, net_area.toFixed(3));
            return { comp, coord_data, info, axial: { L: pos_L_mm.map(p => p / 1000), W: pos_W_mm.map(p => p / 1000) } };
        }

        // --- UI HELPERS ---
        function toggleLfRwaMode() {
            const r1165 = parseInt(document.getElementById('lf-rwa-1165').value) || 0;
            const r1525 = parseInt(document.getElementById('lf-rwa-1525').value) || 0;
            const r1900 = parseInt(document.getElementById('lf-rwa-1900').value) || 0;
            const total = r1165 + r1525 + r1900;
            document.getElementById('lf-rwa-advanced').classList.toggle('hidden', total !== 2);
        }
        function toggleLfRwaDetails() {
            const mode = document.getElementById('lf-rwa-mode').value;
            document.getElementById('lf-rwa-split-opts').classList.toggle('hidden', mode !== 'center');
            document.getElementById('lf-rwa-standard-opts').classList.toggle('hidden', mode !== 'standard');
        }

        function solveLvPosts(tramosData) {
            const support = document.getElementById('lv-support-type').value;
            let maxDist = 10.0; // Default

            if (currentSystem === 'rail') {
                const customDist = parseFloat(document.getElementById('rail-dist-max').value) || 3;
                maxDist = customDist;
            } else if (currentSystem === 'sand01') {
                maxDist = 7.5; // Sand01 hardcoded/default max
            } else if (support === 'sand02') {
                // Use custom max distance for sand02
                const customDist = parseFloat(document.getElementById('lv-max-dist-sand02').value) || 10;
                maxDist = customDist;
            } else {
                // Use custom max distance for poste (default 15m)
                const customDist = parseFloat(document.getElementById('lv-max-dist-poste').value) || 15;
                maxDist = customDist;
            }

            let totalSZH = 0; let totalExtras = 0; const segmentResults = [];
            tramosData.forEach(tramo => {
                if (tramo.len <= 0) { segmentResults.push([]); return; }
                let manualPoints = tramo.manual.map(m => ({ dist: parseFloat(m.dist), type: m.type })).filter(m => m.dist > 0 && m.dist < tramo.len).sort((a, b) => a.dist - b.dist);
                let nodes = [0, ...manualPoints.map(m => m.dist), tramo.len];
                let postsPositions = [];
                for (let i = 0; i < nodes.length - 1; i++) {
                    const span = nodes[i + 1] - nodes[i];
                    if (i > 0) { postsPositions.push({ pos: nodes[i], type: 'manual', ref: manualPoints[i - 1].type }); totalExtras++; }
                    if (span > 0) {
                        const spaces = Math.ceil(span / maxDist);
                        const realDist = span / spaces;
                        for (let k = 1; k < spaces; k++) { postsPositions.push({ pos: nodes[i] + (realDist * k), type: 'auto', ref: 'SZH' }); totalSZH++; }
                    }
                }
                segmentResults.push(postsPositions);
            });
            const result = { segments: segmentResults, countSZH: totalSZH, countExtras: totalExtras };
            globalCalculatedPosts = result; // Store globally for custom posts UI
            return result;
        }

        function calculateAttikaBOM(tramos, sol, startConf, endConf) {
            const comp = {};
            const addComp = (sku, qty) => {
                if (qty <= 0) return;
                const prefixedSku = "BA " + sku;
                comp[prefixedSku] = (comp[prefixedSku] || 0) + qty;
            };

            const numPosts = sol.count;
            addComp('A10', numPosts);
            addComp('S21-1050', numPosts);
            addComp('Z11', 1);

            const handleEnds = (type) => {
                if (type === 'R41') addComp('R41', 2);
                else if (type === 'R51') addComp('R51', 1);
                else addComp('R91', 2);
            };
            handleEnds(startConf);
            handleEnds(endConf);

            const numCorners = tramos.length - 1;
            addComp('R31', 2 * numCorners);

            let straightJoins = 0;
            let allCuts = [];
            tramos.forEach(t => {
                straightJoins += 2 * Math.max(0, Math.ceil(t.len / 3) - 1);
                // Simple rail calculation: 2 rails per segment (top and middle)
                for (let i = 0; i < 2; i++) {
                    let rem = t.len;
                    while (rem > 0.001) {
                        const cut = Math.min(rem, 3);
                        allCuts.push(cut);
                        rem -= cut;
                    }
                }
            });
            addComp('R21', straightJoins);

            // Rail optimization (bin packing)
            allCuts.sort((a, b) => b - a);
            let barsUsed = 0;
            let leftovers = [];
            allCuts.forEach(piece => {
                let found = false;
                for (let i = 0; i < leftovers.length; i++) {
                    if (leftovers[i] >= piece - 0.001) {
                        leftovers[i] -= piece;
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    barsUsed++;
                    leftovers.push(3 - piece);
                }
            });
            addComp('R11', barsUsed);

            // Rodapi√©
            let f20Count = 0;
            let f21Count = 0;
            let f23Count = 0;
            let f26Count = 0;

            tramos.forEach((t, i) => {
                if (t.rodapie) {
                    f21Count += sol.posts[i].length * 2;
                    const numBoards = Math.ceil(t.len / 3);
                    f20Count += numBoards;
                    f23Count += Math.max(0, numBoards - 1);

                    if (i < tramos.length - 1 && tramos[i + 1].rodapie) {
                        f26Count++;
                    }
                }
            });
            addComp('F20', f20Count);
            addComp('F23', f23Count);
            addComp('F21', f21Count);
            addComp('F26', f26Count);

            return comp;
        }

        // --- DRAW ---
        function drawPreview() {
            const cvs = document.getElementById('geo-canvas'); const ctx = cvs.getContext('2d');
            const width = cvs.width; const height = cvs.height;
            ctx.clearRect(0, 0, width, height);

            // Clear BOM and Legend tables immediately
            const tbody = document.getElementById('bom-table-body');
            if (tbody) tbody.innerHTML = '';
            const lbody = document.getElementById('legend-table-body');
            if (lbody) lbody.innerHTML = '';

            const bomDisplay = document.getElementById('bom-display');
            if (bomDisplay) bomDisplay.innerText = 'Items: 0';

            const legendData = {};

            draggableItems = []; // Clear current items
            let points = [{ x: 0, y: 0 }]; let currentAngle = 0; const bomData = {};

            if (currentSystem === 'barandilla' || currentSystem === 'attika') {
                const sideLabel = currentSystem === 'barandilla' ? document.getElementById('b-side').value : document.getElementById('a-side').value;
                const sideSign = sideLabel === 'left' ? 1 : -1;
                let tramosData = [];
                document.querySelectorAll('.b-tramo').forEach((el, i) => {
                    const angleInput = parseFloat(el.querySelector('.b-angle').value) || 0;
                    currentAngle = i === 0 ? angleInput : currentAngle + angleInput;
                    const len = parseFloat(el.querySelector('.b-len').value) || 0;
                    const hasRodapie = el.querySelector('.b-rodapie').checked;
                    tramosData.push({ len: len, angle: currentAngle, rodapie: hasRodapie });
                    const rad = currentAngle * Math.PI / 180;
                    const last = points[points.length - 1];
                    points.push({ x: last.x + len * Math.cos(rad), y: last.y + len * Math.sin(rad) });
                });
                if (points.length < 2) return;

                const startConf = document.getElementById('b-start-conf').value;
                const endConf = document.getElementById('b-end-conf').value;

                let sol;
                if (currentSystem === 'barandilla') {
                    sol = solveBarandillaPosts(tramosData, startConf, endConf);
                } else {
                    sol = solveAttikaPosts(tramosData, startConf, endConf);
                }

                // Fit to screen
                const xs = points.map(p => p.x), ys = points.map(p => p.y);
                const scale = Math.min((width - 100) / (Math.max(...xs) - Math.min(...xs) || 1), (height - 100) / (Math.max(...ys) - Math.min(...ys) || 1)) || 20;
                const toScreen = (x, y) => ({ x: 50 + (x - Math.min(...xs)) * scale + (width - 100 - (Math.max(...xs) - Math.min(...xs)) * scale) / 2, y: height - (50 + (y - Math.min(...ys)) * scale + (height - 100 - (Math.max(...ys) - Math.min(...ys)) * scale) / 2) });

                // Draw alternate rails (3m segments)
                tramosData.forEach((tramo, idx) => {
                    const pStart = points[idx];
                    const rad = tramo.angle * Math.PI / 180;
                    let dist = 0;
                    let segmentIdx = 0;
                    while (dist < tramo.len) {
                        const nextDist = Math.min(tramo.len, dist + 3);
                        const s0 = toScreen(pStart.x + dist * Math.cos(rad), pStart.y + dist * Math.sin(rad));
                        const s1 = toScreen(pStart.x + nextDist * Math.cos(rad), pStart.y + nextDist * Math.sin(rad));

                        ctx.beginPath();
                        ctx.strokeStyle = segmentIdx % 2 === 0 ? '#2ecc71' : '#e74c3c'; // Alternating green and red
                        ctx.lineWidth = 2; // Thinner lines
                        ctx.moveTo(s0.x, s0.y);
                        ctx.lineTo(s1.x, s1.y);
                        ctx.stroke();

                        dist = nextDist;
                        segmentIdx++;
                    }
                });

                // Removed red circles at endpoints and corners

                // Draw Posts & V20 Arms (or Squares for Attika)
                const fixType = currentSystem === 'barandilla' ? document.getElementById('b-fix-type').value : 'attika';

                function drawCotaGroup(pStart, rad, dimPerpRad, group, toScreen, ctx, idx) {
                    const startD = group[0].d1;
                    const endD = group[group.length - 1].d2;
                    const distVal = group[0].len;
                    const midD = (startD + endD) / 2;
                    const offsetM = 0.6;

                    const pMid = {
                        x: pStart.x + midD * Math.cos(rad) + offsetM * Math.cos(dimPerpRad),
                        y: pStart.y + midD * Math.sin(rad) + offsetM * Math.sin(dimPerpRad)
                    };
                    const sMid = toScreen(pMid.x, pMid.y);

                    drawTextWithOffset(ctx, `${currentSystem === 'barandilla' ? 'b' : 'a'}_cota_${idx}_group_${group[0].d1.toFixed(2)}`, distVal.toFixed(2), sMid.x, sMid.y, {
                        color: '#333', font: 'bold 10px Arial', align: 'center'
                    });
                }

                if (sol.posts && sol.posts.length > 0) {
                    let legend2v20Drawn = false;
                    tramosData.forEach((tramo, idx) => {
                        const pStart = points[idx];
                        const rad = tramo.angle * Math.PI / 180;
                        const perpRad = rad + (Math.PI / 2) * sideSign;
                        const dimPerpRad = rad + (Math.PI / 2) * -sideSign;

                        // DIMENSIONS (COTAS) - Grouping repeated distances
                        const postDists = (sol.posts[idx] || []);
                        const boundaries = [0, ...postDists, tramo.len];
                        let currentGroup = [];

                        for (let k = 0; k < boundaries.length - 1; k++) {
                            const d1 = boundaries[k];
                            const d2 = boundaries[k + 1];
                            const distLen = d2 - d1;
                            if (distLen < 0.01) continue;

                            if (currentGroup.length > 0) {
                                const prevDist = currentGroup[currentGroup.length - 1].len;
                                if (Math.abs(prevDist - distLen) < 0.01) {
                                    currentGroup.push({ d1, d2, len: distLen });
                                } else {
                                    drawCotaGroup(pStart, rad, dimPerpRad, currentGroup, toScreen, ctx, idx);
                                    currentGroup = [{ d1, d2, len: distLen }];
                                }
                            } else {
                                currentGroup = [{ d1, d2, len: distLen }];
                            }
                        }
                        if (currentGroup.length > 0) {
                            drawCotaGroup(pStart, rad, dimPerpRad, currentGroup, toScreen, ctx, idx);
                        }

                        // Draw Posts
                        (sol.posts[idx] || []).forEach((dist, pIdx) => {
                            const postX = pStart.x + dist * Math.cos(rad);
                            const postY = pStart.y + dist * Math.sin(rad);
                            const s = toScreen(postX, postY);

                            if (currentSystem === 'attika') {
                                // Draw square for Attika
                                const size = 6;
                                ctx.fillStyle = '#0056b3';
                                ctx.fillRect(s.x - size / 2, s.y - size / 2, size, size);
                            } else {
                                const armEndX = postX + 1.3 * Math.cos(perpRad);
                                const armEndY = postY + 1.3 * Math.sin(perpRad);
                                const sEnd = toScreen(armEndX, armEndY);
                                ctx.beginPath(); ctx.strokeStyle = '#333'; ctx.lineWidth = 1; // Thinner arm
                                ctx.moveTo(s.x, s.y); ctx.lineTo(sEnd.x, sEnd.y); ctx.stroke();

                                if (fixType === 'contrapeso') {
                                    const v20X = postX + 1.1 * Math.cos(perpRad);
                                    const v20Y = postY + 1.1 * Math.sin(perpRad);
                                    const sV20 = toScreen(v20X, v20Y);
                                    const size = 6;
                                    ctx.fillStyle = '#f39c12';
                                    ctx.fillRect(sV20.x - size / 2, sV20.y - size / 2, size, size);
                                }
                            }
                        });
                    });
                }

                if (currentSystem === 'barandilla') {
                    const bBom = calculateBarandillaBOM();
                    document.getElementById('bom-display').innerText = `Postes S50: ${sol.count}`;
                    renderBOMTableSimple(bBom);
                } else if (currentSystem === 'attika') {
                    const bBom = calculateAttikaBOM(tramosData, sol, startConf, endConf);
                    document.getElementById('bom-display').innerText = `Postes A10: ${sol.count}`;
                    renderBOMTableSimple(bBom);
                }
            } else if (currentSystem === 'lightflex') {
                const len = parseFloat(document.getElementById('lf-len').value) || 0;
                const width = parseFloat(document.getElementById('lf-width').value) || 0;
                const qty = parseInt(document.getElementById('lf-qty').value) || 1;
                const bracketType = document.getElementById('lf-bracket-type').value;
                const rwaBars = {
                    'LIGHT-FLEX-RWA-01-1165': parseInt(document.getElementById('lf-rwa-1165').value) || 0,
                    'LIGHT-FLEX-RWA-01-1525': parseInt(document.getElementById('lf-rwa-1525').value) || 0,
                    'LIGHT-FLEX-RWA-01-1900': parseInt(document.getElementById('lf-rwa-1900').value) || 0
                };
                const totalRwa = Object.values(rwaBars).reduce((a, b) => a + b, 0);
                const rwaConfig = {
                    mode: document.getElementById('lf-rwa-mode').value,
                    gap_mm: parseFloat(document.getElementById('lf-rwa-gap').value) || 0,
                    axis: document.getElementById('lf-rwa-axis').value,
                    location: document.getElementById('lf-rwa-loc').value
                };

                const res = solveLightFlexComponents(len, width, bracketType, rwaBars, rwaConfig);
                const width_cvs = cvs.width; // Use local variable for canvas width
                const height_cvs = cvs.height; // Use local variable for canvas height
                const scale = Math.min((width_cvs - 80) / len, (height_cvs - 140) / width);
                const ox = (width_cvs - len * scale) / 2;
                const oy = (height_cvs - width * scale) / 2;

                // Draw perimeter (Green)
                ctx.strokeStyle = '#27ae60'; ctx.lineWidth = 2;
                ctx.strokeRect(ox, oy, len * scale, width * scale);

                // Draw RWA Bars (Dashed Blue)
                ctx.setLineDash([5, 5]); ctx.strokeStyle = 'rgba(0,0,255,0.5)'; ctx.lineWidth = 3;
                const isSplit = (totalRwa === 2 && rwaConfig.mode === 'center');
                const isPerim = (totalRwa === 2 && rwaConfig.mode === 'standard');

                if (isSplit) {
                    const gap = rwaConfig.gap_mm / 1000;
                    if (rwaConfig.axis === 'L') {
                        ctx.beginPath(); ctx.moveTo(ox + (len / 2 - gap / 2) * scale, oy); ctx.lineTo(ox + (len / 2 - gap / 2) * scale, oy + width * scale); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(ox + (len / 2 + gap / 2) * scale, oy); ctx.lineTo(ox + (len / 2 + gap / 2) * scale, oy + width * scale); ctx.stroke();
                    } else {
                        ctx.beginPath(); ctx.moveTo(ox, oy + (width / 2 - gap / 2) * scale); ctx.lineTo(ox + len * scale, oy + (width / 2 - gap / 2) * scale); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(ox, oy + (width / 2 + gap / 2) * scale); ctx.lineTo(ox + len * scale, oy + (width / 2 + gap / 2) * scale); ctx.stroke();
                    }
                } else if (isPerim) {
                    if (rwaConfig.location === 'long_side') {
                        const axis = (width < len) ? 'Horiz' : 'Vert';
                        if (axis === 'Horiz') {
                            ctx.beginPath(); ctx.moveTo(ox, oy); ctx.lineTo(ox + len * scale, oy); ctx.stroke();
                            ctx.beginPath(); ctx.moveTo(ox, oy + width * scale); ctx.lineTo(ox + len * scale, oy + width * scale); ctx.stroke();
                        } else {
                            ctx.beginPath(); ctx.moveTo(ox, oy); ctx.lineTo(ox, oy + width * scale); ctx.stroke();
                            ctx.beginPath(); ctx.moveTo(ox + len * scale, oy); ctx.lineTo(ox + len * scale, oy + width * scale); ctx.stroke();
                        }
                    } else {
                        const axis = (width < len) ? 'Vert' : 'Horiz';
                        if (axis === 'Vert') {
                            ctx.beginPath(); ctx.moveTo(ox, oy); ctx.lineTo(ox, oy + width * scale); ctx.stroke();
                            ctx.beginPath(); ctx.moveTo(ox + len * scale, oy); ctx.lineTo(ox + len * scale, oy + width * scale); ctx.stroke();
                        } else {
                            ctx.beginPath(); ctx.moveTo(ox, oy); ctx.lineTo(ox + len * scale, oy); ctx.stroke();
                            ctx.beginPath(); ctx.moveTo(ox, oy + width * scale); ctx.lineTo(ox + len * scale, oy + width * scale); ctx.stroke();
                        }
                    }
                } else if (totalRwa > 0) {
                    for (let i = 1; i <= totalRwa; i++) {
                        const y = (width * i) / (totalRwa + 1);
                        ctx.beginPath(); ctx.moveTo(ox, oy + y * scale); ctx.lineTo(ox + len * scale, oy + y * scale); ctx.stroke();
                    }
                }
                ctx.setLineDash([]);

                // Draw Brackets
                res.coord_data.forEach(c => {
                    const px = ox + c.x * scale;
                    const py = oy + (width - c.y) * scale; // Invert Y for canvas
                    if (c.type === 'LIGHT-FLEX-BEF-01-VZ') {
                        ctx.fillStyle = 'orange'; ctx.beginPath(); ctx.arc(px, py, 4, 0, Math.PI * 2); ctx.fill();
                    } else {
                        ctx.fillStyle = 'green'; ctx.beginPath(); ctx.moveTo(px, py - 5); ctx.lineTo(px - 5, py + 5); ctx.lineTo(px + 5, py + 5); ctx.closePath(); ctx.fill();
                    }
                });

                // Draw Cotas
                const drawLfChain = (points, total, isHoriz, offset_px) => {
                    const chain = Array.from(new Set([0, ...points, total])).sort((a, b) => a - b);
                    for (let i = 0; i < chain.length - 1; i++) {
                        const p1 = chain[i], p2 = chain[i + 1], d = p2 - p1;
                        if (d < 0.005) continue;
                        const mid = (p1 + p2) / 2;
                        if (isHoriz) {
                            ctx.strokeStyle = '#444'; ctx.lineWidth = 0.5;
                            ctx.beginPath(); ctx.moveTo(ox + p1 * scale, oy + offset_px); ctx.lineTo(ox + p2 * scale, oy + offset_px); ctx.stroke();
                            drawTextWithOffset(ctx, `lf_L_${i}`, d.toFixed(2), ox + mid * scale, oy + offset_px + 12, { color: '#666', font: '10px Arial', align: 'center' });
                        } else {
                            ctx.strokeStyle = '#444'; ctx.lineWidth = 0.5;
                            ctx.beginPath(); ctx.moveTo(ox + offset_px, oy + (width - p1) * scale); ctx.lineTo(ox + offset_px, oy + (width - p2) * scale); ctx.stroke();
                            drawTextWithOffset(ctx, `lf_W_${i}`, d.toFixed(2), ox + offset_px - 25, oy + (width - mid) * scale, { color: '#666', font: '10px Arial', align: 'center' });
                        }
                    }
                };
                drawLfChain(res.axial.L, len, true, width * scale + 30);
                drawLfChain(res.axial.W, width, false, -30);

                document.getElementById('bom-display').innerText = `Red: ${res.comp['LIGHT-FLEX-NET-01']} m¬≤ | Fij: ${res.comp['LIGHT-FLEX-KARI-VZ']}`;
                const finalBom = {};
                Object.entries(res.comp).forEach(([k, v]) => { finalBom[k] = v * qty; });
                renderBOMTableSimple(finalBom);
            } else if (currentSystem === 'sand01' || currentSystem === 'sand02' || currentSystem === 'poste' || currentSystem === 'rail') {
                let tramosData = [];
                const supportRef = document.getElementById('lv-support-type').value === 'poste' ? document.getElementById('lv-post-model').value : "Chapa Sand02";
                const ebModel = document.getElementById('lv-eb-model').value;
                const szhModel = document.getElementById('lv-szh-model').value;
                const manualTypesSet = new Set();

                document.querySelectorAll('.lv-tramo').forEach((el, i) => {
                    const len = parseFloat(el.querySelector('.lv-len').value) || 0;

                    if (i === 0) {
                        var startEl = el.querySelector('.lv-start-angle');
                        currentAngle = startEl ? parseFloat(startEl.value) || 0 : 0;
                    }
                    const manuals = [];
                    el.querySelectorAll('.manual-point-row').forEach(row => { const type = row.querySelector('.mp-type').value; manuals.push({ dist: row.querySelector('.mp-dist').value, type: type }); manualTypesSet.add(type); });
                    const hasCurve = el.querySelector('.lv-end').value === 'curva';
                    const curveModel = hasCurve ? el.querySelector('.lv-curve-type').value : null;
                    if (hasCurve) manualTypesSet.add(curveModel);
                    tramosData.push({ len: len, angle: currentAngle, manual: manuals, hasCurve: hasCurve, curveModel: curveModel });
                    const rad = currentAngle * Math.PI / 180;
                    const last = points[points.length - 1];
                    points.push({ x: last.x + len * Math.cos(rad), y: last.y + len * Math.sin(rad) });
                    if (hasCurve) currentAngle += parseFloat(el.querySelector('.lv-angle').value) || 0;
                });

                if (points.length < 2) return;
                const sol = solveLvPosts(tramosData);

                if (currentSystem === 'rail') {
                    const tipo = document.getElementById('rail-soporte-tipo').value;
                    let model = "";
                    if (tipo === 'bef') model = document.getElementById('rail-bef-model').value;
                    else if (tipo === 'sta') model = document.getElementById('rail-sta-model').value;
                    else model = document.getElementById('rail-eb-model').value;

                    const isLoop = document.getElementById('lv-loop').checked; // Using geometry loop
                    const totalSoportes = isLoop ? sol.countSZH : sol.countSZH + 2;
                    document.getElementById('bom-display').innerText = `Soportes (${model}): ${totalSoportes}`;
                } else {
                    document.getElementById('bom-display').innerText = `SZH: ${sol.countSZH} | Extras: ${sol.countExtras}`;
                }

                const sortedManuals = Array.from(manualTypesSet).sort();
                const manualMap = {};
                sortedManuals.forEach(function (m, i) {
                    manualMap[m] = 3 + i;
                });

                // ...

                Object.keys(manualMap).forEach(function (key) {
                    var val = manualMap[key];
                    bomData[val] = supportRef + ' + ' + key;
                });

                // Fit
                const xs = points.map(p => p.x), ys = points.map(p => p.y);
                const scale = Math.min((width - 100) / (Math.max(...xs) - Math.min(...xs) || 1), (height - 100) / (Math.max(...ys) - Math.min(...ys) || 1)) || 20;
                const toScreen = (x, y) => ({ x: 50 + (x - Math.min(...xs)) * scale + (width - 100 - (Math.max(...xs) - Math.min(...xs)) * scale) / 2, y: height - (50 + (y - Math.min(...ys)) * scale + (height - 100 - (Math.max(...ys) - Math.min(...ys)) * scale) / 2) });

                ctx.beginPath(); ctx.strokeStyle = '#27ae60'; ctx.lineWidth = 2; // Thinner lines
                points.forEach((p, idx) => { const s = toScreen(p.x, p.y); if (idx === 0) ctx.moveTo(s.x, s.y); else ctx.lineTo(s.x, s.y); });
                ctx.stroke();

                ctx.font = "bold 20px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";

                // Nodes & Labels
                const nodeFontSize = currentSystem === 'rail' ? 'bold 12px Arial' : 'bold 20px Arial';
                points.forEach((p, idx) => {
                    const s = toScreen(p.x, p.y);

                    // Draw dot at all nodes (extremos and esquinas)
                    ctx.fillStyle = '#e67e22';
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, 4, 0, 2 * Math.PI);
                    ctx.fill();

                    if (idx === 0 || idx === points.length - 1) { // Extremos
                        // Calcular perpendicular a la l√≠nea
                        let lineAngle;
                        if (idx === 0 && points.length > 1) {
                            lineAngle = tramosData[0].angle * Math.PI / 180;
                        } else if (idx === points.length - 1) {
                            lineAngle = tramosData[tramosData.length - 1].angle * Math.PI / 180;
                        }

                        const perpAngle = lineAngle + Math.PI / 2;
                        const offset = 25;
                        const textX = s.x + offset * Math.cos(perpAngle);
                        const textY = s.y + offset * Math.sin(perpAngle);

                        drawTextWithOffset(ctx, `lv_node_${idx}`, "1", textX, textY, {
                            color: '#e67e22', font: nodeFontSize, align: "center", baseline: "middle"
                        });

                        // Detailed Legend for Extremos (1)
                        let comps1 = [];
                        if (currentSystem === 'sand01' || currentSystem === 'sand02' || currentSystem === 'poste') {
                            const variant = document.getElementById('lv-variant').value;
                            const support = currentSystem === 'poste' ? document.getElementById('lv-post-model').value : currentSystem.toUpperCase();
                            comps1.push(support);
                            if (currentSystem === 'sand01') comps1.push(document.getElementById('sand01-fix-type').value);
                            else if (currentSystem === 'sand02') comps1.push('BEF 306-VE250');

                            if (variant === 'ends10') {
                                comps1.push(document.getElementById('lv-eb-model').value);
                                comps1.push('ENDS-10');
                                if (document.getElementById('chk-shock').checked) comps1.push(document.getElementById('lv-shock-type').value);
                            } else {
                                const ends50Cfg = document.getElementById('lv-ends50-config').value;
                                comps1.push('AIO-ENDS-50');
                                if (ends50Cfg === '50-51') comps1.push('AIO-ENDS-51');
                            }
                        } else if (currentSystem === 'rail') {
                            const tipo = document.getElementById('rail-soporte-tipo').value;
                            const model = (tipo === 'sta') ? document.getElementById('rail-sta-model').value : (tipo === 'bef' ? document.getElementById('rail-bef-model').value : document.getElementById('rail-eb-model').value);
                            comps1.push(model);
                            if (tipo === 'sta') comps1.push('TAURUS-BEF-30');
                            else if (tipo === 'eb') {
                                comps1.push('BEF-411'); comps1.push(document.getElementById('rail-bef-adicional').value);
                                if (document.getElementById('rail-varilla-m16').checked) comps1.push('VAR-M16');
                            }
                            comps1.push('TAURUS-EA-10/11');
                        }
                        legendData["1"] = comps1.join(' + ');
                    } else { // Esquinas
                        const prev = tramosData[idx - 1];
                        if (prev.hasCurve) {
                            ctx.fillStyle = 'orange'; ctx.fillRect(s.x - 8, s.y - 8, 16, 16);
                            const curveLabel = manualMap[prev.curveModel];
                            drawTextWithOffset(ctx, `lv_curve_${idx}`, curveLabel, s.x, s.y, {
                                color: 'white', font: currentSystem === 'rail' ? "bold 10px Arial" : "bold 12px Arial", align: "center", baseline: "middle"
                            });

                            let compsC = [];
                            if (currentSystem !== 'rail') {
                                const support = currentSystem === 'poste' ? document.getElementById('lv-post-model').value : currentSystem.toUpperCase();
                                compsC.push(support);
                                if (currentSystem === 'sand01') compsC.push(document.getElementById('sand01-fix-type').value);
                                else if (currentSystem === 'sand02') compsC.push('BEF 306-VE250');

                                // ALZAS in curves
                                const hasAlzas = (currentSystem === 'poste') ? (document.getElementById('chk-alzas-posts') && document.getElementById('chk-alzas-posts').checked) : (document.getElementById('chk-alzas') && document.getElementById('chk-alzas').checked);
                                if (hasAlzas) {
                                    const alzaCode = currentSystem === 'sand02' ? 'VL-SAND-SET-10' : 'VL-20-50';
                                    compsC.push(alzaCode);
                                }
                            } else {
                                const tipo = document.getElementById('rail-soporte-tipo').value;
                                const model = (tipo === 'sta') ? document.getElementById('rail-sta-model').value : (tipo === 'bef' ? document.getElementById('rail-bef-model').value : document.getElementById('rail-eb-model').value);
                                compsC.push(model);
                                if (tipo === 'sta') compsC.push('TAURUS-BEF-30');
                                else if (tipo === 'eb') {
                                    compsC.push('BEF-411'); compsC.push(document.getElementById('rail-bef-adicional').value);
                                    if (document.getElementById('rail-varilla-m16').checked) compsC.push('VAR-M16');
                                }
                            }
                            compsC.push(prev.curveModel);
                            legendData[curveLabel] = compsC.join(' + ');
                        } else {
                            // Points already drawn above
                        }
                    }
                });

                // Intermedios & COTAS
                let angleAcum = tramosData.length ? tramosData[0].angle : 0;
                const sideSign = currentSystem === 'barandilla' ? (document.getElementById('b-side').value === 'left' ? 1 : -1) : 1;

                tramosData.forEach((tramo, idx) => {
                    const pStart = points[idx];
                    const rad = angleAcum * Math.PI / 180;
                    const dimPerpRad = rad - Math.PI / 2;
                    const offset = 25;

                    // DRAW COTAS for LV
                    const postDists = sol.segments[idx].map(p => p.pos);
                    const boundaries = [0, ...postDists, tramo.len];
                    let currentGroup = [];

                    for (let k = 0; k < boundaries.length - 1; k++) {
                        const d1 = boundaries[k];
                        const d2 = boundaries[k + 1];
                        const distLen = d2 - d1;
                        if (distLen < 0.01) continue;

                        if (currentGroup.length > 0) {
                            const prevDist = currentGroup[currentGroup.length - 1].len;
                            if (Math.abs(prevDist - distLen) < 0.01) {
                                currentGroup.push({ d1, d2, len: distLen });
                            } else {
                                drawCotaGroupLV(pStart, rad, dimPerpRad, currentGroup, toScreen, ctx, idx);
                                currentGroup = [{ d1, d2, len: distLen }];
                            }
                        } else {
                            currentGroup = [{ d1, d2, len: distLen }];
                        }
                    }
                    if (currentGroup.length > 0) {
                        drawCotaGroupLV(pStart, rad, dimPerpRad, currentGroup, toScreen, ctx, idx);
                    }

                    sol.segments[idx].forEach(post => {
                        const s = toScreen(pStart.x + post.pos * Math.cos(rad), pStart.y + post.pos * Math.sin(rad));
                        const textX = s.x + offset * Math.cos(dimPerpRad);
                        const textY = s.y - offset * Math.sin(dimPerpRad);

                        // Draw small dot at support position
                        ctx.fillStyle = '#e67e22';
                        ctx.beginPath();
                        ctx.arc(s.x, s.y, 3, 0, 2 * Math.PI);
                        ctx.fill();

                        if (post.type === 'manual') {
                            const manualLabel = (typeof manualMap !== 'undefined' && manualMap[post.ref]) || post.ref;
                            drawTextWithOffset(ctx, `lv_manual_${idx}_${post.pos.toFixed(2)}`, manualLabel, textX, textY, {
                                color: '#e67e22', font: nodeFontSize, align: "center", baseline: "middle"
                            });

                            let compsM = [];
                            if (currentSystem !== 'rail') {
                                const support = currentSystem === 'poste' ? document.getElementById('lv-post-model').value : currentSystem.toUpperCase();
                                compsM.push(support);
                                if (currentSystem === 'sand01') compsM.push(document.getElementById('sand01-fix-type').value);
                                else if (currentSystem === 'sand02') compsM.push('BEF 306-VE250');
                            } else {
                                const tipo = document.getElementById('rail-soporte-tipo').value;
                                const model = (tipo === 'sta') ? document.getElementById('rail-sta-model').value : (tipo === 'bef' ? document.getElementById('rail-bef-model').value : document.getElementById('rail-eb-model').value);
                                compsM.push(model);
                                if (tipo === 'sta') compsM.push('TAURUS-BEF-30');
                                else if (tipo === 'eb') {
                                    compsM.push('BEF-411'); compsM.push(document.getElementById('rail-bef-adicional').value);
                                    if (document.getElementById('rail-varilla-m16').checked) compsM.push('VAR-M16');
                                }
                            }
                            compsM.push(post.ref);
                            legendData[manualLabel] = compsM.join(' + ');
                        } else {
                            drawTextWithOffset(ctx, `lv_auto_${idx}_${post.pos.toFixed(2)}`, "2", textX, textY, {
                                color: '#e67e22', font: nodeFontSize, align: "center", baseline: "middle"
                            });

                            let comps2 = [];
                            if (currentSystem !== 'rail') {
                                const support = currentSystem === 'poste' ? document.getElementById('lv-post-model').value : currentSystem.toUpperCase();
                                comps2.push(support);
                                if (currentSystem === 'sand01') comps2.push(document.getElementById('sand01-fix-type').value);
                                else if (currentSystem === 'sand02') comps2.push('BEF 306-VE250');

                                // ALZAS in intermediates
                                const hasAlzas = (currentSystem === 'poste') ? (document.getElementById('chk-alzas-posts') && document.getElementById('chk-alzas-posts').checked) : (document.getElementById('chk-alzas') && document.getElementById('chk-alzas').checked);
                                if (hasAlzas) {
                                    const alzaCode = currentSystem === 'sand02' ? 'VL-SAND-SET-10' : 'VL-20-50';
                                    comps2.push(alzaCode);
                                }

                                comps2.push(document.getElementById('lv-szh-model').value);
                            } else {
                                const tipo = document.getElementById('rail-soporte-tipo').value;
                                const model = (tipo === 'sta') ? document.getElementById('rail-sta-model').value : (tipo === 'bef' ? document.getElementById('rail-bef-model').value : document.getElementById('rail-eb-model').value);
                                comps2.push(model);
                                if (tipo === 'sta') comps2.push('TAURUS-BEF-30');
                                else if (tipo === 'eb') {
                                    comps2.push('BEF-411'); comps2.push(document.getElementById('rail-bef-adicional').value);
                                    if (document.getElementById('rail-varilla-m16').checked) comps2.push('VAR-M16');
                                }
                            }
                            legendData["2"] = comps2.join(' + ');
                        }
                    });
                    if (idx < tramosData.length - 1) angleAcum = tramosData[idx + 1].angle;
                });

                function drawCotaGroupLV(pStart, rad, dimPerpRad, group, toScreen, ctx, idx) {
                    const startD = group[0].d1;
                    const endD = group[group.length - 1].d2;
                    const distVal = group[0].len;
                    const midD = (startD + endD) / 2;
                    const offsetM = 0.5; // Slightly closer than barandilla

                    const pMid = {
                        x: pStart.x + midD * Math.cos(rad) + offsetM * Math.cos(dimPerpRad),
                        y: pStart.y + midD * Math.sin(rad) + offsetM * Math.sin(dimPerpRad)
                    };
                    const sMid = toScreen(pMid.x, pMid.y);

                    drawTextWithOffset(ctx, `lv_cota_${idx}_group_${group[0].d1.toFixed(2)}`, distVal.toFixed(2), sMid.x, sMid.y, {
                        color: '#333', font: 'bold 11px Arial', align: 'center', baseline: 'middle'
                    });

                    // Removed dimension marker lines
                }

                const realBom = currentSystem === 'rail' ? calculateRailBOM() : calculateLineBOM();
                renderBOMTableSimple(realBom);
                renderLegendTable(legendData);
            }
        }

        function renderLegendTable(data) {
            const lbody = document.getElementById('legend-table-body');
            if (lbody) {
                lbody.innerHTML = '';
                Object.entries(data).sort((a, b) => a[0] - b[0]).forEach(([num, desc]) => {
                    lbody.insertAdjacentHTML('beforeend', `<tr><td><center><strong>${num}</strong></center></td><td>${desc}</td></tr>`);
                });

                // Toggle visibility of legend container
                const container = document.getElementById('legend-table-container');
                if (container) {
                    if (Object.keys(data).length > 0) container.classList.remove('hidden');
                    else container.classList.add('hidden');
                }
            }
        }

        // The bomData variable is not used after this point in the original code.
        // The provided snippet for `bom` calculation at the beginning of `drawPreview`
        // would overwrite the `bomData` variable, but the `renderBOMTableSimple` calls
        // are already specific to each system.
        // To avoid breaking existing logic, I will not add the provided `bom` calculation
        // at the beginning of `drawPreview`. The existing `renderBOMTableSimple` calls
        // are sufficient for displaying the BOM in the UI.

        function renderBOMTableSimple(data) {
            const tbody = document.getElementById('bom-table-body'); tbody.innerHTML = '';
            Object.entries(data).forEach(([sku, qty]) => {
                tbody.insertAdjacentHTML('beforeend', `<tr><td><strong>${sku}</strong></td><td>${qty}</td></tr>`);
            });
        }

        // --- FOTOS & OVERLAY ---
        const photoCanvas = document.getElementById('editor');
        const photoCtx = photoCanvas.getContext('2d');

        function loadPhoto(e) {
            if (e.target.files[0]) {
                const r = new FileReader();
                r.onload = ev => {
                    imgObj.onload = () => {
                        // Ajustar canvas a la foto pero limitando ancho
                        const scale = Math.min(800 / imgObj.width, 1);
                        photoCanvas.width = imgObj.width * scale;
                        photoCanvas.height = imgObj.height * scale;
                        photoScale = 1.0;
                        document.getElementById('photo-scale').value = '1';
                        document.getElementById('photo-scale-value').innerText = '100%';
                        document.getElementById('photo-scale-controls').style.display = 'block';
                        renderEditor();
                    };
                    imgObj.src = ev.target.result;
                };
                r.readAsDataURL(e.target.files[0]);
            }
        }

        // --- CONTROL FUNCTIONS ---
        function setDrawTool(tool) {
            drawTool = tool;
            // Actualizar botones activos
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            // Mostrar/ocultar input de texto
            document.getElementById('text-input-container').style.display = tool === 'text' ? 'block' : 'none';
        }

        function setDrawColor(color) {
            drawColor = color;
            // Actualizar botones activos
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function updateLineWidth() {
            lineWidth = parseInt(document.getElementById('line-width').value);
            document.getElementById('line-width-value').innerText = lineWidth + 'px';
        }

        function updateTextSize() {
            textSize = parseInt(document.getElementById('text-size').value);
            document.getElementById('text-size-value').innerText = textSize + 'px';
        }

        function updatePhotoScale() {
            photoScale = parseFloat(document.getElementById('photo-scale').value);
            document.getElementById('photo-scale-value').innerText = Math.round(photoScale * 100) + '%';
            renderEditor();
        }

        function importPlanToPhoto() {
            if (!imgObj.src) { alert("Carga una foto primero"); return; }
            const planCanvas = document.getElementById('geo-canvas');
            overlay.img = new Image();
            overlay.img.src = planCanvas.toDataURL();
            overlay.img.onload = () => {
                overlay.active = true;
                // Centrar overlay y resetear transformaciones
                overlay.scale = 1;
                overlay.rotateX = 0;
                overlay.rotateY = 0;
                overlay.rotateZ = 0;
                overlay.x = (photoCanvas.width - overlay.img.width) / 2;
                overlay.y = (photoCanvas.height - overlay.img.height) / 2;
                // Actualizar controles UI
                document.getElementById('overlay-scale').value = '1';
                document.getElementById('overlay-scale-value').innerText = '100%';
                document.getElementById('overlay-rotateX').value = '0';
                document.getElementById('overlay-rotateX-value').innerText = '0¬∞';
                document.getElementById('overlay-rotateY').value = '0';
                document.getElementById('overlay-rotateY-value').innerText = '0¬∞';
                document.getElementById('overlay-rotateZ').value = '0';
                document.getElementById('overlay-rotateZ-value').innerText = '0¬∞';
                document.getElementById('overlay-controls').style.display = 'block';
                renderEditor();
            };
        }

        async function fixOverlay() {
            if (!overlay.active) return;

            overlay.active = false;
            document.getElementById('overlay-controls').style.display = 'none';

            // Capturar la vista actual del canvas container que incluye el overlay 3D
            try {
                const container = document.getElementById('canvas-container');
                const overlay3D = document.getElementById('overlay-3d');

                // Crear un canvas temporal para combinar la imagen
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = photoCanvas.width;
                tempCanvas.height = photoCanvas.height;
                const tCtx = tempCanvas.getContext('2d');

                // Dibujar la imagen base (foto)
                tCtx.drawImage(photoCanvas, 0, 0);

                // Para la transformaci√≥n 3D, necesitar√≠amos renderizar el elemento HTML
                // Por ahora, ocultamos el overlay 3D
                overlay3D.style.display = 'none';

                // Actualizar la imagen base
                imgObj.src = tempCanvas.toDataURL();
            } catch (e) {
                console.error('Error al fijar overlay:', e);
            }
        }

        function updateOverlayScale() {
            const s = parseFloat(document.getElementById('overlay-scale').value);
            overlay.scale = s;
            document.getElementById('overlay-scale-value').innerText = Math.round(s * 100) + '%';
            renderEditor();
        }

        function updateOverlayRotation() {
            overlay.rotateX = parseInt(document.getElementById('overlay-rotateX').value);
            overlay.rotateY = parseInt(document.getElementById('overlay-rotateY').value);
            overlay.rotateZ = parseInt(document.getElementById('overlay-rotateZ').value);
            document.getElementById('overlay-rotateX-value').innerText = overlay.rotateX + '¬∞';
            document.getElementById('overlay-rotateY-value').innerText = overlay.rotateY + '¬∞';
            document.getElementById('overlay-rotateZ-value').innerText = overlay.rotateZ + '¬∞';
            renderEditor();
        }

        function renderEditor() {
            photoCtx.clearRect(0, 0, photoCanvas.width, photoCanvas.height);
            if (imgObj.src) {
                // Aplicar escala de foto
                const w = photoCanvas.width * photoScale;
                const h = photoCanvas.height * photoScale;
                const x = (photoCanvas.width - w) / 2;
                const y = (photoCanvas.height - h) / 2;
                photoCtx.drawImage(imgObj, x, y, w, h);
            }

            const overlay3D = document.getElementById('overlay-3d');

            if (overlay.active && overlay.img) {
                // Usar elemento img con CSS 3D transforms
                const s = overlay.scale;
                const w = overlay.img.width * s;
                const h = overlay.img.height * s;

                overlay3D.src = overlay.img.src;
                overlay3D.style.display = 'block';
                overlay3D.style.width = w + 'px';
                overlay3D.style.height = h + 'px';
                overlay3D.style.left = overlay.x + 'px';
                overlay3D.style.top = overlay.y + 'px';

                // Aplicar transformaci√≥n 3D con perspectiva
                const transform = `
                    perspective(1000px)
                    rotateX(${overlay.rotateX}deg)
                    rotateY(${overlay.rotateY}deg)
                    rotateZ(${overlay.rotateZ}deg)
                `;
                overlay3D.style.transform = transform;
            } else {
                overlay3D.style.display = 'none';
            }
        }

        // --- DRAWING FUNCTIONS ---
        function drawShape(x1, y1, x2, y2) {
            photoCtx.strokeStyle = drawColor;
            photoCtx.fillStyle = drawColor;
            photoCtx.lineWidth = lineWidth;
            photoCtx.lineCap = "round";

            switch (drawTool) {
                case 'line':
                    photoCtx.beginPath();
                    photoCtx.moveTo(x1, y1);
                    photoCtx.lineTo(x2, y2);
                    photoCtx.stroke();
                    break;

                case 'circle':
                    const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                    photoCtx.beginPath();
                    photoCtx.arc(x1, y1, radius, 0, 2 * Math.PI);
                    photoCtx.stroke();
                    break;

                case 'square':
                    const width = x2 - x1;
                    const height = y2 - y1;
                    photoCtx.beginPath();
                    photoCtx.rect(x1, y1, width, height);
                    photoCtx.stroke();
                    break;

                case 'triangle':
                    const baseWidth = x2 - x1;
                    const topX = x1 + baseWidth / 2;
                    const topY = y2;
                    photoCtx.beginPath();
                    photoCtx.moveTo(x1, y1); // Bottom left
                    photoCtx.lineTo(x2, y1); // Bottom right
                    photoCtx.lineTo(topX, topY); // Top
                    photoCtx.closePath();
                    photoCtx.stroke();
                    break;

                case 'x':
                    photoCtx.beginPath();
                    photoCtx.moveTo(x1, y1);
                    photoCtx.lineTo(x2, y2);
                    photoCtx.moveTo(x2, y1);
                    photoCtx.lineTo(x1, y2);
                    photoCtx.stroke();
                    break;
            }
        }

        function drawTextOnCanvas(x, y) {
            const text = document.getElementById('text-input').value;
            if (!text) {
                alert('Por favor escribe un texto primero');
                return;
            }
            photoCtx.font = `${textSize}px Arial`;
            photoCtx.fillStyle = drawColor;
            photoCtx.fillText(text, x, y);
            // Guardar el estado actual
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = photoCanvas.width;
            tempCanvas.height = photoCanvas.height;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.drawImage(photoCanvas, 0, 0);
            imgObj.src = tempCanvas.toDataURL();
        }

        // --- INTERACCION EDITOR ---
        let startX, startY, snapshot;

        // Mouse Events
        photoCanvas.onmousedown = e => {
            if (overlay.active) {
                overlay.isDragging = true;
                startX = e.offsetX - overlay.x;
                startY = e.offsetY - overlay.y;
            } else {
                // Si es texto, dibujarlo inmediatamente
                if (drawTool === 'text') {
                    drawTextOnCanvas(e.offsetX, e.offsetY);
                } else {
                    isDrawing = true;
                    startX = e.offsetX;
                    startY = e.offsetY;
                    snapshot = photoCtx.getImageData(0, 0, photoCanvas.width, photoCanvas.height);
                }
            }
        };

        photoCanvas.onmousemove = e => {
            if (overlay.active && overlay.isDragging) {
                overlay.x = e.offsetX - startX;
                overlay.y = e.offsetY - startY;
                renderEditor();
            } else if (isDrawing) {
                photoCtx.putImageData(snapshot, 0, 0);
                drawShape(startX, startY, e.offsetX, e.offsetY);
            }
        };

        photoCanvas.onmouseup = () => {
            isDrawing = false;
            overlay.isDragging = false;
        };

        // Touch Events
        photoCanvas.ontouchstart = e => {
            const r = photoCanvas.getBoundingClientRect();
            const tx = e.touches[0].clientX - r.left;
            const ty = e.touches[0].clientY - r.top;
            if (overlay.active) {
                overlay.isDragging = true;
                startX = tx - overlay.x;
                startY = ty - overlay.y;
            } else {
                // Si es texto, dibujarlo inmediatamente
                if (drawTool === 'text') {
                    drawTextOnCanvas(tx, ty);
                } else {
                    isDrawing = true;
                    startX = tx;
                    startY = ty;
                    snapshot = photoCtx.getImageData(0, 0, photoCanvas.width, photoCanvas.height);
                }
            }
        };

        photoCanvas.ontouchmove = e => {
            e.preventDefault();
            const r = photoCanvas.getBoundingClientRect();
            const tx = e.touches[0].clientX - r.left;
            const ty = e.touches[0].clientY - r.top;
            if (overlay.active && overlay.isDragging) {
                overlay.x = tx - startX;
                overlay.y = ty - startY;
                renderEditor();
            } else if (isDrawing) {
                photoCtx.putImageData(snapshot, 0, 0);
                drawShape(startX, startY, tx, ty);
            }
        };

        photoCanvas.ontouchend = () => {
            isDrawing = false;
            overlay.isDragging = false;
        };

        function clearDraw() { imgObj.src = imgObj.src; setTimeout(renderEditor, 50); } // Reset to last saved state
        function savePhoto() { if (!photoCanvas.width) return; savedPhotos.push(photoCanvas.toDataURL('image/jpeg', 0.6)); const i = document.createElement('img'); i.src = savedPhotos[savedPhotos.length - 1]; i.className = 'thumb'; document.getElementById('gallery-grid').appendChild(i); document.getElementById('photo-count').innerText = savedPhotos.length; }

        // --- CALCULATE BARANDILLA BOM ---
        function calculateBarandillaBOM() {
            const bom = {};
            const tramosElements = document.querySelectorAll('.b-tramo');
            if (tramosElements.length === 0) return bom;

            const lengths = [];
            const toeBoards = [];
            let totalLength = 0;

            tramosElements.forEach(el => {
                const len = parseFloat(el.querySelector('.b-len').value) || 0;
                const rodapie = el.querySelector('.b-rodapie').checked;
                lengths.push(len);
                toeBoards.push(rodapie);
                totalLength += len;
            });

            const startType = document.getElementById('b-start-conf').value;
            const endType = document.getElementById('b-end-conf').value;
            const fixType = document.getElementById('b-fix-type').value;

            // Get posts
            const tramosData = lengths.map(l => ({ len: l }));
            const sol = solveBarandillaPosts(tramosData, startType, endType);
            const totalPosts = sol.count;

            // 1. Posts (BA S50)
            bom['BA S50'] = totalPosts;

            // 2. Bars (BA R11) - Calculated for 2 parallel bars
            // Algorithm from Python script: Bin packing 3m bars
            // We need 2 * totalLength of bars.
            // Simplified: how many 3m bars cover 2 * totalLength?
            // "comp['R11'] = bars_used" in Python uses a more complex bin packing per piece.
            // Since we use continuous bars with unions R21, we can simplify:
            // For each rail (top and mid), we calculate how many 3m bars are needed.
            let barsNeeded = 0;
            lengths.forEach(L => {
                // Top rail
                barsNeeded += Math.ceil(L / 3);
                // Mid rail
                barsNeeded += Math.ceil(L / 3);
            });
            bom['BA R11'] = barsNeeded;

            // 3. Linear Junctions (BA R21)
            let junctionsR21 = 0;
            lengths.forEach(L => {
                const numBars = Math.ceil(L / 3);
                if (numBars > 1) {
                    junctionsR21 += (numBars - 1) * 2; // 2 parallel bars
                }
            });
            bom['BA R21'] = junctionsR21;

            // 4. Angular Junctions (BA R31)
            // 2 per corner (top and mid)
            bom['BA R31'] = (lengths.length - 1) * 2;

            // 5. Terminations
            if (startType === 'R91') bom['BA R91'] = (bom['BA R91'] || 0) + 1;
            if (startType === 'R41') bom['BA R41'] = (bom['BA R41'] || 0) + 2;
            if (startType === 'R51') bom['BA R51'] = (bom['BA R51'] || 0) + 1;

            if (endType === 'R91') bom['BA R91'] = (bom['BA R91'] || 0) + 1;
            if (endType === 'R41') bom['BA R41'] = (bom['BA R41'] || 0) + 2;
            if (endType === 'R51') bom['BA R51'] = (bom['BA R51'] || 0) + 1;

            // 6. Counterweights (BA V20) & Pads (BA Z35) & Safety (BA Z34)
            if (fixType === 'contrapeso') {
                // Determine V20 per post
                // Ends (not R41) get 4, Intermediates get 2.
                let v20Count = 0;
                sol.posts.forEach((segPosts, idx) => {
                    segPosts.forEach((sPos, pIdx) => {
                        let isExtremity = false;
                        if (idx === 0 && pIdx === 0 && startType !== 'R41') isExtremity = true;
                        if (idx === sol.posts.length - 1 && pIdx === segPosts.length - 1 && endType !== 'R41') isExtremity = true;

                        v20Count += isExtremity ? 4 : 2;
                    });
                });
                bom['BA V20'] = v20Count;
                bom['BA Z35'] = Math.floor(v20Count / 2);
            }

            // 7. Cartel & Safety
            bom['BA Z12'] = 1; // Cartel
            bom['BA Z34'] = totalPosts; // Z34 per post

            // 8. Screws (BBF)
            bom['BBF-05.5-096'] = totalPosts + 1;
            bom['BBF-05.5-025'] = totalPosts + 1;

            // 9. Rodapi√© (F20, F23, F50, F26)
            let countF20 = 0;
            let countF23 = 0;
            let countF50 = 0;
            let countF26 = 0;

            lengths.forEach((L, i) => {
                if (toeBoards[i]) {
                    const numPieces = Math.ceil(L / 3);
                    countF20 += numPieces;
                    countF23 += Math.max(0, numPieces - 1);
                    countF50 += sol.posts[i].length;

                    if (i < lengths.length - 1 && toeBoards[i + 1]) {
                        countF26 += 1; // Corner union
                    }
                }
            });

            if (countF20 > 0) {
                bom['BA F20'] = countF20;
                bom['BA F23'] = countF23;
                bom['BA F50'] = countF50;
                if (countF26 > 0) bom['BA F26'] = countF26;
            }

            return bom;
        }

        // --- CALCULATE BOM FOR EXCEL EXPORT ---
        // --- CALCULATE BOM FOR EXCEL EXPORT ---
        function calculateLineBOM() {
            const bom = {};

            if (currentSystem === 'sand01' || currentSystem === 'sand02' || currentSystem === 'poste') {
                const variant = document.getElementById('lv-variant').value;
                const supportType = document.getElementById('lv-support-type').value;

                // Recoger datos de geometr√≠a
                let tramosData = [];
                let totalLength = 0;
                let countCurves = 0;
                const curveModels = {};

                document.querySelectorAll('.lv-tramo').forEach((el, i) => {
                    const len = parseFloat(el.querySelector('.lv-len').value) || 0;
                    totalLength += len;

                    const manuals = [];
                    el.querySelectorAll('.manual-point-row').forEach(row => {
                        manuals.push({
                            dist: row.querySelector('.mp-dist').value,
                            type: row.querySelector('.mp-type').value
                        });
                    });

                    const hasCurve = el.querySelector('.lv-end').value === 'curva';
                    const curveModel = hasCurve ? el.querySelector('.lv-curve-type').value : null;

                    if (hasCurve) {
                        countCurves++;
                        curveModels[curveModel] = (curveModels[curveModel] || 0) + 1;
                    }

                    tramosData.push({ len, manual: manuals, hasCurve, curveModel });
                });

                // Calcular posts autom√°ticos
                const sol = solveLvPosts(tramosData);
                const countSZH = sol.countSZH;
                const countExtras = sol.countExtras;

                if (currentSystem === 'sand01' || supportType === 'sand02') {
                    // SAND bases (2 extremos + intermedios + curvas)
                    const totalBases = 2 + countSZH + countCurves;
                    const baseCode = currentSystem === 'sand01' ? 'SAND-01' : 'SAND-02';
                    bom[baseCode] = totalBases;

                    // Fijaci√≥n
                    if (currentSystem === 'sand01') {
                        const fixCode = document.getElementById('sand01-fix-type').value;
                        bom[fixCode] = totalBases * 20;
                    } else {
                        // SAND-02 default rivets
                        bom['BEF 306-VE250'] = totalBases * 20;
                    }

                    // Elementos seg√∫n variante
                    if (variant === 'ends10') {
                        const ebModel = document.getElementById('lv-eb-model').value;
                        const szhModel = document.getElementById('lv-szh-model').value;

                        bom[ebModel] = 2; // Extremos
                        if (countSZH > 0) bom[szhModel] = countSZH; // Intermedios

                        // Cable SEIL-30
                        bom['SEIL-30'] = Math.ceil(totalLength + 2);

                        // ENDS-10
                        if (currentSystem === 'sand01') {
                            bom['EB-10'] = 2;
                            bom['ENDS-10'] = 1; // Pack 2
                            bom['ENDS SAFETY TUBE'] = 2;
                        } else {
                            bom['ENDS-10'] = 1;
                        }

                        // Absorbedores (si checkbox activado)
                        if (document.getElementById('chk-shock').checked) {
                            const shockQty = parseInt(document.getElementById('lv-shock-qty').value) || 0;
                            const shockType = document.getElementById('lv-shock-type').value;
                            if (shockQty > 0) bom[shockType] = shockQty;
                        }

                        // Curvas
                        for (const [model, qty] of Object.entries(curveModels)) {
                            bom[model] = qty;
                        }

                        // Cartel de instalaci√≥n
                        if (currentSystem === 'sand01') {
                            bom['AIO-TYP-20-ES'] = 1;
                        } else {
                            bom['AIO-TYP-20-ES'] = 1; // Error in original code? It had AIO-TYP-20-ES for both ends10
                        }

                        // Alzas (si checkbox activado)
                        if (document.getElementById('chk-alzas').checked) {
                            const totalAlzas = countSZH + countCurves;
                            const alzaCode = currentSystem === 'sand01' ? 'VL-20-50' : 'VL-SAND-SET-10';
                            if (totalAlzas > 0) bom[alzaCode] = totalAlzas;
                        }

                    } else { // ends50
                        const szhModel = document.getElementById('lv-szh-model').value;

                        // Configuraci√≥n de extremos Ends50
                        const ends50Config = document.getElementById('lv-ends50-config').value;
                        if (ends50Config === '50-51') {
                            bom['AIO-ENDS-50'] = 1;
                            bom['AIO-ENDS-51'] = 1;
                        } else {
                            bom['AIO-ENDS-50'] = 2;
                        }

                        if (countSZH > 0) bom[szhModel] = countSZH; // Intermedios

                        // Cable SEIL-30
                        bom['SEIL-30'] = Math.ceil(totalLength + 2);

                        // Curvas
                        for (const [model, qty] of Object.entries(curveModels)) {
                            bom[model] = qty;
                        }

                        // Cartel de instalaci√≥n
                        bom['AIO-TYP-50'] = 1;
                        if (currentSystem === 'sand01') bom['ENDS SAFETY TUBE'] = 2;

                        // Alzas (si checkbox activado)
                        if (document.getElementById('chk-alzas').checked) {
                            const totalAlzas = countSZH + countCurves;
                            const alzaCode = currentSystem === 'sand01' ? 'VL-20-50' : 'VL-SAND-SET-10';
                            if (totalAlzas > 0) bom[alzaCode] = totalAlzas;
                        }
                    }

                    // Cartel ADEKUA (siempre)
                    bom['CARTEL ADEKUA'] = 1;
                } else if (supportType === 'poste') {
                    // POST INSTALLATION
                    const usePosts = document.getElementById('chk-use-posts') && document.getElementById('chk-use-posts').checked;

                    if (usePosts) {
                        // WITH POSTS
                        const defaultModel = document.getElementById('lv-post-model').value;
                        const postCounts = {}; // Track count by model

                        // Count posts by model (considering custom selections)
                        let totalPosts = 2; // 2 extremos

                        // Extremos always use default model
                        postCounts[defaultModel] = (postCounts[defaultModel] || 0) + 2;

                        // Count intermediate posts
                        globalCalculatedPosts.segments.forEach((segment, segIdx) => {
                            segment.forEach((post, postIdx) => {
                                const key = `${segIdx}_${postIdx}`;
                                const model = customPostSelections[key] || defaultModel;
                                postCounts[model] = (postCounts[model] || 0) + 1;
                                totalPosts++;
                            });
                        });

                        // Add posts for curves
                        totalPosts += countCurves;
                        postCounts[defaultModel] = (postCounts[defaultModel] || 0) + countCurves;

                        // Add posts to BOM (ordered by model name)
                        Object.keys(postCounts).sort().forEach(model => {
                            bom[model] = postCounts[model];
                        });

                        // Elementos seg√∫n variante
                        if (variant === 'ends10') {
                            const ebModel = document.getElementById('lv-eb-model').value;
                            const szhModel = document.getElementById('lv-szh-model').value;

                            // Extremos
                            bom[ebModel] = 2;

                            // Intermedios
                            if (countSZH > 0) bom[szhModel] = countSZH;

                            // ENDS-10
                            bom['ENDS-10'] = 1;

                            // Cable SEIL-30
                            bom['SEIL-30'] = Math.ceil(totalLength + 2);

                            // Curvas EDLE
                            for (const [model, qty] of Object.entries(curveModels)) {
                                bom[model] = qty;
                            }

                            // Absorbedores (si checkbox activado)
                            if (document.getElementById('chk-shock').checked) {
                                const shockQty = parseInt(document.getElementById('lv-shock-qty').value) || 0;
                                const shockType = document.getElementById('lv-shock-type').value;
                                if (shockQty > 0) bom[shockType] = shockQty;
                            }

                            // Cartel de instalaci√≥n
                            bom['AIO-TYP-10'] = 1;

                            // Alzas de nivelaci√≥n (si checkbox activado) - SIEMPRE VL-20-50
                            if (document.getElementById('chk-alzas-posts') && document.getElementById('chk-alzas-posts').checked) {
                                const totalAlzas = countSZH + countCurves;
                                if (totalAlzas > 0) bom['VL-20-50'] = totalAlzas;
                            }

                        } else { // ends50
                            const szhModel = document.getElementById('lv-szh-model').value;

                            // Configuraci√≥n de extremos Ends50
                            const ends50Config = document.getElementById('lv-ends50-config').value;
                            if (ends50Config === '50-51') {
                                bom['AIO-ENDS-50'] = 1;
                                bom['AIO-ENDS-51'] = 1;
                            } else {
                                bom['AIO-ENDS-50'] = 2;
                            }

                            // Intermedios
                            if (countSZH > 0) bom[szhModel] = countSZH;

                            // Cable SEIL-30
                            bom['SEIL-30'] = Math.ceil(totalLength + 2);

                            // Curvas EDLE
                            for (const [model, qty] of Object.entries(curveModels)) {
                                bom[model] = qty;
                            }

                            // Cartel de instalaci√≥n
                            bom['AIO-TYP-50'] = 1;

                            // Alzas de nivelaci√≥n (si checkbox activado) - SIEMPRE VL-20-50
                            if (document.getElementById('chk-alzas-posts') && document.getElementById('chk-alzas-posts').checked) {
                                const totalAlzas = countSZH + countCurves;
                                if (totalAlzas > 0) bom['VL-20-50'] = totalAlzas;
                            }
                        }
                    } else {
                        // WITHOUT POSTS - Solo extremos
                        if (variant === 'ends10') {
                            const ebModel = document.getElementById('lv-eb-model').value;
                            const szhModel = document.getElementById('lv-szh-model').value;

                            // Solo extremos, sin postes
                            bom[ebModel] = 2;

                            // Intermedios
                            if (countSZH > 0) bom[szhModel] = countSZH;

                            // ENDS-10
                            bom['ENDS-10'] = 1;

                            // Cable SEIL-30
                            bom['SEIL-30'] = Math.ceil(totalLength + 2);

                            // Curvas EDLE
                            for (const [model, qty] of Object.entries(curveModels)) {
                                bom[model] = qty;
                            }

                            // Absorbedores (si checkbox activado)
                            if (document.getElementById('chk-shock').checked) {
                                const shockQty = parseInt(document.getElementById('lv-shock-qty').value) || 0;
                                const shockType = document.getElementById('lv-shock-type').value;
                                if (shockQty > 0) bom[shockType] = shockQty;
                            }

                            // Cartel de instalaci√≥n
                            bom['AIO-TYP-10'] = 1;

                        } else { // ends50
                            const szhModel = document.getElementById('lv-szh-model').value;

                            // Configuraci√≥n de extremos Ends50 - sin postes
                            const ends50Config = document.getElementById('lv-ends50-config').value;
                            if (ends50Config === '50-51') {
                                bom['AIO-ENDS-50'] = 1;
                                bom['AIO-ENDS-51'] = 1;
                            } else {
                                bom['AIO-ENDS-50'] = 2;
                            }

                            // Intermedios
                            if (countSZH > 0) bom[szhModel] = countSZH;

                            // Cable SEIL-30
                            bom['SEIL-30'] = Math.ceil(totalLength + 2);

                            // Curvas EDLE
                            for (const [model, qty] of Object.entries(curveModels)) {
                                bom[model] = qty;
                            }

                            // Cartel de instalaci√≥n
                            bom['AIO-TYP-50'] = 1;
                        }
                    }

                    // Cartel ADEKUA (siempre)
                    bom['CARTEL ADEKUA'] = 1;
                }
            }

            return bom;
        }

        // --- CALCULATE RAIL BOM ---
        function calculateRailBOM() {
            const bom = {};

            // Get configuration
            const longitud = parseFloat(document.getElementById('rail-longitud').value) || 0;
            const isClosed = document.getElementById('rail-cerrada').checked;
            const tipoSoporte = document.getElementById('rail-soporte-tipo').value;
            const distMax = parseFloat(document.getElementById('rail-dist-max').value) || 3;
            const usar6m = document.getElementById('rail-usar-6m').checked;
            const carroTipo = document.getElementById('rail-carro-tipo').value;
            const unionTipo = document.getElementById('rail-union-tipo').value;
            const optimizarVE5 = document.getElementById('rail-optimizar-ve5').checked;

            // Recoger datos de geometr√≠a si existen, si no usar longitud simple
            let tramosData = [];
            let totalLength = 0;
            let countCurves = 0;
            const curveModels = {};
            const tramoEls = document.querySelectorAll('.lv-tramo');

            if (tramoEls.length > 0) {
                tramoEls.forEach(el => {
                    const len = parseFloat(el.querySelector('.lv-len').value) || 0;
                    totalLength += len;
                    const manuals = [];
                    el.querySelectorAll('.manual-point-row').forEach(row => {
                        manuals.push({
                            dist: row.querySelector('.mp-dist').value,
                            type: row.querySelector('.mp-type').value
                        });
                    });
                    const hasCurve = el.querySelector('.lv-end').value === 'curva';
                    const curveModel = hasCurve ? el.querySelector('.lv-curve-type').value : null;
                    if (hasCurve) {
                        countCurves++;
                        curveModels[curveModel] = (curveModels[curveModel] || 0) + 1;
                    }
                    tramosData.push({ len, manual: manuals, hasCurve, curveModel });
                });
            } else {
                totalLength = longitud;
            }

            // Calcular soportes basados en longitud total
            const sol = solveLvPosts(tramosData.length > 0 ? tramosData : [{ len: totalLength, manual: [], hasCurve: false }]);
            const numIntermedios = sol.countSZH;
            const numExtremosBase = isClosed ? 0 : 2;
            const totalSoportes = numExtremosBase + numIntermedios + countCurves;

            // Add supports based on type
            if (tipoSoporte === 'bef') {
                const befModel = document.getElementById('rail-bef-model').value;
                if (befModel.includes('-VE5')) {
                    const numPacks = Math.ceil(totalSoportes / 5);
                    if (numPacks > 0) bom[befModel] = numPacks;
                } else {
                    if (totalSoportes > 0) bom[befModel] = totalSoportes;
                }
            } else if (tipoSoporte === 'sta') {
                const staModel = document.getElementById('rail-sta-model').value;
                if (totalSoportes > 0) {
                    bom[staModel] = totalSoportes;
                    bom['TAURUS-BEF-30'] = totalSoportes;
                }
            } else { // bef-eb
                const ebModel = document.getElementById('rail-eb-model').value;
                const befAdicional = document.getElementById('rail-bef-adicional').value;
                const addVarilla = document.getElementById('rail-varilla-m16').checked;

                if (totalSoportes > 0) {
                    bom['BEF-411'] = totalSoportes;
                    bom[ebModel] = totalSoportes;
                    bom[befAdicional] = totalSoportes;

                    if (addVarilla) {
                        const cantidadVarillas = totalSoportes * 0.5;
                        bom['VAR-M16'] = cantidadVarillas;
                    }
                }
            }

            // Calculate rails
            let numRailes6m = 0;
            let numRailes3m = 0;
            let longitudRecta = totalLength; // For simple calculation

            if (usar6m && totalLength >= 6) {
                numRailes6m = Math.floor(totalLength / 6);
                const resto = totalLength - (numRailes6m * 6);
                if (resto > 0) {
                    numRailes3m = Math.ceil(resto / 3);
                }
            } else {
                numRailes3m = Math.ceil(totalLength / 3);
            }

            if (numRailes6m > 0) {
                bom['TAURUS-RAIL-10-6000'] = numRailes6m;
            }
            if (numRailes3m > 0) {
                bom['TAURUS-RAIL-10-3000'] = numRailes3m;
            }

            // Calculate unions
            const totalSegmentos = numRailes6m + numRailes3m;
            let numUniones = 0;

            if (isClosed) {
                numUniones = totalSegmentos; // Closed loop needs same number as segments
            } else {
                numUniones = totalSegmentos > 0 ? totalSegmentos - 1 : 0; // Open line needs segments - 1
            }

            if (numUniones > 0) {
                const tienePackVE5 = (unionTipo === 'TAURUS-VB-10' || unionTipo === 'TAURUS-VB-12');

                if (tienePackVE5 && optimizarVE5) {
                    const numPacks = Math.floor(numUniones / 5);
                    const numSueltas = numUniones % 5;

                    if (numPacks > 0) {
                        bom[`${unionTipo}-VE5`] = numPacks;
                    }
                    if (numSueltas > 0) {
                        bom[unionTipo] = numSueltas;
                    }
                } else {
                    bom[unionTipo] = numUniones;
                }
            }

            // Add curves
            for (const [model, qty] of Object.entries(curveModels)) {
                if (qty > 0) bom[model] = (bom[model] || 0) + qty;
            }

            // Add terminations
            if (isClosed) {
                bom['TAURUS-EA-11'] = 1; // Solo entrada/salida
            } else {
                bom['TAURUS-EA-10'] = 1; // Final
                bom['TAURUS-EA-11'] = 1; // Entrada/salida
            }

            // Add cart
            bom[carroTipo] = 1;

            // Add signs
            bom['TAURUS-TYP-10'] = 1;
            if (totalSoportes > 0) {
                bom['CARTEL ADEKUA'] = 1;
            }

            return bom;
        }

        // --- EXPORT TO EXCEL ---
        function exportToExcel() {
            let bom = {};

            if (currentSystem === 'rail') {
                // Rail system
                bom = calculateRailBOM();
            } else if (currentSystem === 'barandilla') {
                bom = calculateBarandillaBOM();
            } else if (currentSystem === 'attika') {
                const startConf = document.getElementById('b-start-conf').value;
                const endConf = document.getElementById('b-end-conf').value;
                let tramosData = [];
                document.querySelectorAll('.b-tramo').forEach(el => {
                    tramosData.push({
                        len: parseFloat(el.querySelector('.b-len').value) || 0,
                        rodapie: el.querySelector('.b-rodapie').checked
                    });
                });
                const sol = solveAttikaPosts(tramosData, startConf, endConf);
                bom = calculateAttikaBOM(tramosData, sol, startConf, endConf);
            } else if (currentSystem === 'lightflex') {
                const len = parseFloat(document.getElementById('lf-len').value) || 0;
                const width = parseFloat(document.getElementById('lf-width').value) || 0;
                const qty = parseInt(document.getElementById('lf-qty').value) || 1;
                const bracketType = document.getElementById('lf-bracket-type').value;
                const rwaBars = {
                    'LIGHT-FLEX-RWA-01-1165': parseInt(document.getElementById('lf-rwa-1165').value) || 0,
                    'LIGHT-FLEX-RWA-01-1525': parseInt(document.getElementById('lf-rwa-1525').value) || 0,
                    'LIGHT-FLEX-RWA-01-1900': parseInt(document.getElementById('lf-rwa-1900').value) || 0
                };
                const res = solveLightFlexComponents(len, width, bracketType, rwaBars, {
                    mode: document.getElementById('lf-rwa-mode').value,
                    gap_mm: parseFloat(document.getElementById('lf-rwa-gap').value) || 0,
                    axis: document.getElementById('lf-rwa-axis').value,
                    location: document.getElementById('lf-rwa-loc').value
                });
                const finalBom = {};
                Object.entries(res.comp).forEach(([k, v]) => { finalBom[k] = v * qty; });
                bom = finalBom;
            } else if (currentSystem === 'sand01' || currentSystem === 'sand02' || currentSystem === 'poste') {
                bom = calculateLineBOM();
            } else {
                alert('La exportaci√≥n a Excel solo est√° disponible para Sand02, Postes, Rail, Barandilla, Attika y Light Flex actualmente.');
                return;
            }

            if (Object.keys(bom).length === 0) {
                alert('No hay datos para exportar. Por favor, completa la geometr√≠a primero.');
                return;
            }

            // Crear array de datos para Excel
            const data = [['C√≥digo', 'Cantidad']];

            // Mantener el orden como en las im√°genes del usuario
            // El orden est√° determinado por el orden de inserci√≥n en el objeto bom
            for (const [codigo, cantidad] of Object.entries(bom)) {
                data.push([codigo, cantidad]);
            }

            // A√±adir campos de la secci√≥n Accesos, Seguridad, Varios
            const variosFields = [
                { id: 'v-pluma', label: 'VARIOS PLUMA' },
                { id: 'v-pemp', label: 'PEMP' },
                { id: 'v-atxabastar', label: 'VARIOS ATXABASTAR' },
                { id: 'v-escalera', label: 'VARIOS ESCALERA' },
                { id: 'v-gancho-escalera', label: 'VARIOS GANCHO ESCALERA' },
                { id: 'v-herreria-josu', label: 'VARIOS HERRER√çA JOSU' },
                { id: 'v-peldano', label: 'VARIOS PELDA√ëO' },
                { id: 'v-sellado', label: 'VARIOS SELLADO' }
            ];

            variosFields.forEach(field => {
                const val = parseInt(document.getElementById(field.id).value) || 0;
                if (val > 0) {
                    data.push([field.label, val]);
                }
            });

            // Crear workbook y worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Ajustar ancho de columnas
            ws['!cols'] = [
                { wch: 20 }, // C√≥digo
                { wch: 10 }  // Cantidad
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'BOM');

            // Generar nombre de archivo
            const cliente = document.getElementById('g-client').value || 'Cliente';
            const fecha = document.getElementById('g-date').value || new Date().toISOString().split('T')[0];
            const filename = `BOM_${cliente.replace(/\s+/g, '_')}_${fecha}.xlsx`;

            // Descargar
            XLSX.writeFile(wb, filename);
        }


        // --- GENERATE HTML REPORT ---
        function generateReport() {
            const cliente = document.getElementById('g-client').value || 'Cliente';
            const obra = document.getElementById('g-site').value || 'Obra';
            const fecha = document.getElementById('g-date').value || new Date().toISOString().split('T')[0];
            let sistemaDesc = currentSystem;
            if (currentSystem === 'barandilla') sistemaDesc = 'Barandilla R11';
            else if (currentSystem === 'attika') sistemaDesc = 'Barandilla Attika';
            else if (currentSystem === 'lightflex') sistemaDesc = 'Light Flex (Redes)';
            else if (currentSystem === 'sand01') sistemaDesc = 'L√≠nea de Vida (Sand01)';
            else if (currentSystem === 'sand02') sistemaDesc = 'L√≠nea de Vida (Sand02)';
            else if (currentSystem === 'poste') sistemaDesc = 'L√≠nea de Vida (Postes)';
            else if (currentSystem === 'rail') sistemaDesc = 'Rail (TAURUS)';
            else sistemaDesc = 'Sistema Desconocido'; // Fallback for any other system
            const sistema = sistemaDesc;

            // Capturar imagen del plano
            const planCanvas = document.getElementById('geo-canvas');
            const planImage = planCanvas.toDataURL('image/png');

            // Obtener tabla BOM actual
            const bomTableBody = document.getElementById('bom-table-body');
            let bomTableHTML = '';
            if (bomTableBody) {
                bomTableHTML = '<table style="width:100%; border-collapse:collapse; margin:20px 0;"><thead><tr style="background:#f8f9fa; border-bottom:2px solid #ddd;"><th style="padding:10px; text-align:left; border:1px solid #ddd;">C√≥digo</th><th style="padding:10px; text-align:left; border:1px solid #ddd;">Cantidad</th></tr></thead><tbody>';
                Array.from(bomTableBody.querySelectorAll('tr')).forEach(row => {
                    bomTableHTML += '<tr>';
                    Array.from(row.querySelectorAll('td')).forEach(cell => {
                        bomTableHTML += `<td style="padding:10px; border:1px solid #eee;">${cell.innerHTML}</td>`;
                    });
                    bomTableHTML += '</tr>';
                });
                bomTableHTML += '</tbody></table>';
            }

            // Obtener tabla Leyenda del Plano
            const legendTableBody = document.getElementById('legend-table-body');
            let legendTableHTML = '';
            if (legendTableBody && legendTableBody.innerHTML.trim() !== '') {
                legendTableHTML = '<h2 style="color:#0056b3; font-size:1.5rem; margin:30px 0 15px; border-bottom:2px solid #e67e22; padding-bottom:8px;">Leyenda del Plano</h2>';
                legendTableHTML += '<table style="width:100%; border-collapse:collapse; margin:20px 0;"><thead><tr style="background:#f8f9fa; border-bottom:2px solid #ddd;"><th style="padding:10px; text-align:left; border:1px solid #ddd; width:100px;">N√∫mero</th><th style="padding:10px; text-align:left; border:1px solid #ddd;">Descripci√≥n / Elementos</th></tr></thead><tbody>';
                Array.from(legendTableBody.querySelectorAll('tr')).forEach(row => {
                    legendTableHTML += '<tr>';
                    Array.from(row.querySelectorAll('td')).forEach(cell => {
                        legendTableHTML += `<td style="padding:10px; border:1px solid #eee;">${cell.innerHTML}</td>`;
                    });
                    legendTableHTML += '</tr>';
                });
                legendTableHTML += '</tbody></table>';
            }

            // Obtener fotos guardadas
            let photosHTML = '';
            if (savedPhotos.length > 0) {
                photosHTML = '<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:15px; margin:20px 0;">';
                savedPhotos.forEach((photo, idx) => {
                    photosHTML += `<div style="border:1px solid #ddd; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1);"><img src="${photo}" style="width:100%; height:auto; display:block;"><p style="padding:10px; margin:0; text-align:center; background:#f8f9fa; font-size:0.9rem;">Foto ${idx + 1}</p></div>`;
                });
                photosHTML += '</div>';
            } else {
                photosHTML = '<p style="color:#999; font-style:italic;">No se han guardado fotos en esta visita.</p>';
            }

            // Obtener informaci√≥n de la secci√≥n Accesos, Seguridad, Varios
            let technicalNotesHTML = '';
            const variosFields = [
                { id: 'v-pluma', label: 'VARIOS PLUMA' },
                { id: 'v-pemp', label: 'PEMP' },
                { id: 'v-atxabastar', label: 'VARIOS ATXABASTAR' },
                { id: 'v-escalera', label: 'VARIOS ESCALERA' },
                { id: 'v-gancho-escalera', label: 'VARIOS GANCHO ESCALERA' },
                { id: 'v-herreria-josu', label: 'VARIOS HERRER√çA JOSU' },
                { id: 'v-peldano', label: 'VARIOS PELDA√ëO' },
                { id: 'v-sellado', label: 'VARIOS SELLADO' }
            ];

            let hasVarios = false;
            let variosListItems = '';
            variosFields.forEach(field => {
                const val = parseInt(document.getElementById(field.id).value) || 0;
                if (val > 0) {
                    hasVarios = true;
                    variosListItems += `<li style="margin:5px 0;"><strong>${field.label}</strong>: ${val}</li>`;
                }
            });

            if (hasVarios) {
                technicalNotesHTML = '<div style="background:#f8f9fa; border-left:4px solid #0056b3; padding:15px; border-radius:4px; margin:20px 0;">';
                technicalNotesHTML += '<h3 style="margin:0 0 10px; color:#0056b3; font-size:1.1rem;">üõ†Ô∏è Accesos, Seguridad, Varios</h3>';
                technicalNotesHTML += '<ul style="margin:0; padding-left:20px;">' + variosListItems + '</ul></div>';
            }


            // Generar HTML del informe
            const reportHTML = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe - ${cliente} - ${fecha}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; color: #333; background: #fff; padding: 40px 20px; max-width: 1200px; margin: 0 auto; }
        h1 { color: #0056b3; font-size: 2rem; margin-bottom: 10px; border-bottom: 3px solid #0056b3; padding-bottom: 10px; }
        h2 { color: #0056b3; font-size: 1.5rem; margin: 30px 0 15px; border-bottom: 2px solid #e67e22; padding-bottom: 8px; }
        .header { background: linear-gradient(135deg, #0056b3, #004494); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .header h1 { color: white; border: none; margin: 0; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .info-item { background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px; }
        .info-label { font-size: 0.85rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-value { font-size: 1.2rem; font-weight: bold; margin-top: 5px; }
        section { margin-bottom: 40px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        img { max-width: 100%; height: auto; border-radius: 8px; border: 1px solid #ddd; }
        .plan-container { text-align: center; background: white; padding: 20px; border-radius: 8px; }
        @media print {
            body { padding: 0; }
            section { page-break-inside: avoid; box-shadow: none; }
            .header { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Informe de Visita T√©cnica</h1>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Cliente</div>
                <div class="info-value">${cliente}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Obra</div>
                <div class="info-value">${obra}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Fecha</div>
                <div class="info-value">${fecha}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Sistema</div>
                <div class="info-value">${sistema}</div>
            </div>
        </div>
    </div>
    
    <section>
        <h2>üìê Plano de Instalaci√≥n</h2>
        <div class="plan-container">
            <img src="${planImage}" alt="Plano de Instalaci√≥n">
        </div>
    </section>
    
    <section>
        <h2>üì¶ Lista de Materiales (BOM)</h2>
        ${bomTableHTML || '<p style="color:#999; font-style:italic;">No se ha generado el BOM para este sistema.</p>'}
    </section>

    ${legendTableHTML}
    
    ${technicalNotesHTML ? `<section>${technicalNotesHTML}</section>` : ''}
    
    <section>
        <h2>üì∑ Galer√≠a de Fotos</h2>
        ${photosHTML}
    </section>
    
    <footer style="margin-top:40px; padding-top:20px; border-top:2px solid #eee; text-align:center; color:#999; font-size:0.9rem;">
        <p>Informe generado autom√°ticamente el ${new Date().toLocaleDateString('es-ES')} a las ${new Date().toLocaleTimeString('es-ES')}</p>
        <p>Toma de Datos v14 - Sistema de Gesti√≥n de Visitas T√©cnicas</p>
    </footer>
</body>
</html>`;

            // Descargar como archivo HTML
            const blob = new Blob([reportHTML], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Informe_${cliente.replace(/\s+/g, '_')}_${fecha}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- EXPORT ---
        function exportJSON() {
            const data = { general: { cliente: document.getElementById('g-client').value, obra: document.getElementById('g-site').value, sistema: currentSystem } };
            // (L√≥gica de exportaci√≥n igual a v13)
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })); a.download = `Visita.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        addBarandillaTramo();
        addLvTramo();
        toggleLvConfig();
    </script>
</body>

</html>